# 3.7. Оптимизация портфеля

## Обзор

Система реализует две основные стратегии оптимизации — **HJB** (стохастическое управление) и **CCMV** (кластерная mean-variance), интегрированные с GARCH-моделированием волатильности, Монте-Карло симуляцией и стресс-тестированием.

## GARCH(1,1) — моделирование волатильности

### Модель условной дисперсии

```
σ²_t = ω + α × ε²_{t-1} + β × σ²_{t-1}
```

где:
- `ω` (omega) = 0.000025 — базовая дисперсия
- `α` (alpha) = 0.082 — реакция на шоки
- `β` (beta) = 0.893 — инерция волатильности
- `ε_{t-1}` — raw returns (не стандартизированные остатки)

### Ограничения
- **Стационарность:** α + β < 1 (обязательная валидация)
- **Variance floor:** предотвращение нулевой дисперсии
- **Начальная дисперсия:** long-run variance `ω / (1 - α - β)`

### API
```
POST /api/compute/garch
Body: { returns: number[], omega, alpha, beta }
Response: { variances, volatilities, residuals, params, long_term_vol }
```

### Фильтрация GARCH
Отчёт активов, проходящих скрининг:
- Условная волатильность ≤ 30%
- Стабильность: α + β < 1
- Достаточная ликвидность

## Монте-Карло симуляция

### Geometric Brownian Motion (GBM)

Непрерывная формулировка:
```
dS_t = μ × S_t × dt + σ × S_t × dW_t
```

Дискретизация (Эйлер-Маруяма):
```
S_{t+1} = S_t × exp((μ - σ²/2) × Δt + σ × √Δt × Z_t)
```
где `Z_t ~ N(0, 1)`.

### Визуализация

**2D SVG:**
- Анимированный timeline slider
- Макс. 50 отображаемых путей (из тысяч)
- Pre-calculated квантили: q05, q50, q95

**3D Three.js:**
- Интерактивная камера (zoom, pan, rotate)
- OrbitControls
- BufferGeometry для GPU-оптимизации
- requestAnimationFrame (60fps)

### Метрики риска

| Метрика | Расчёт |
|---------|--------|
| **Average Return** | mean(finalPrices / initialPrice - 1) |
| **Sharpe Ratio** | (avgReturn - Rf) / std(returns) |
| **VaR (95%)** | quantile(returns, 0.05) |
| **CVaR (95%)** | mean(returns | returns < VaR) |
| **Average MDD** | mean(maxDrawdowns по всем путям) |

## HJB Strategy (Hamilton-Jacobi-Bellman)

### Задача Мертона

Максимизация ожидаемой полезности:
```
max E[∫₀ᵀ U(c_t) dt + U(W_T)]
```

где `U(x) = x^(1-γ) / (1-γ)` — CRRA utility, `γ` — коэффициент неприятия риска.

### Параметры

| Параметр | Диапазон | Описание |
|----------|----------|----------|
| γ (risk aversion) | 0.1-20 | Неприятие риска |
| T (horizon) | 0.1-50 лет | Инвестиционный горизонт |
| r (risk-free) | 0-0.2 | Безрисковая ставка |
| σ (volatility) | 0.05-0.8 | Рыночная волатильность |
| μ (return) | 0-0.5 | Ожидаемая доходность |
| Trajectories | 100-100,000 | Количество Монте-Карло путей |

### Оптимальная аллокация
Формула Мертона для доли рисковых активов:
```
π* = (μ - r) / (γ × σ²)
```

### 3D Correlation Heatmap
Plotly.js визуализация для идентификации:
- Диверсификационных возможностей (низкая корреляция)
- Концентрации риска (высокая аллокация + высокая vol)
- Кластеров активов с похожими корреляциями

## CCMV Strategy (Cluster-based Constrained Mean-Variance)

### Целевая функция
```
min f*(Δ, α) = Variance - γ × Return

s.t.  Σ wᵢ = 1         (бюджетное ограничение)
      0 ≤ wᵢ ≤ w̄       (ограничение весов)
      Σ 1{wᵢ > 0} ≤ Δ  (ограничение кол-ва активов)
```

### Параметры

| Параметр | Диапазон | Описание |
|----------|----------|----------|
| Δ (delta) | 1-N | Макс. количество активов в портфеле |
| w̄ (bar weight) | 0.01-1.0 | Макс. вес одного актива |
| γ (risk aversion) | 0.1-10 | Неприятие риска |
| Method | Δ-CCMV / α-CCMV | Ограничение по кол-ву / распределению |

### Валидация ковариационной матрицы
- Проверка PSD (positive semi-definite) через `eigvalsh`
- Регуляризация при отрицательных собственных значениях

### Sharpe Ratio
```
Sharpe = (R - Rf) / σ
```
(Исправлено: вычитание Rf в обоих методах — delta и alpha)

## Таблица портфельной композиции

| Колонка | Содержимое |
|---------|------------|
| **Инструмент** | Тикер и название |
| **Текущий вес** | Существующая аллокация (%) |
| **Оптимальный вес** | Рекомендуемая аллокация (%) |
| **Изменение** | Разница (optimal - current), зелёный = рост, красный = снижение |

## Стресс-тестирование (StressTestingSwap.vue)

### Сценарии
Каждый стресс-сценарий содержит:
- Сдвиги рыночных параметров (ставки, волатильность, спреды)
- Расчёт влияния через swap DV01
- Интеграция с реестром свопов в Pinia store
- Progress-индикатор выполнения

### Визуализация
- Total P&L impact
- Изменения по отдельным позициям
- Цветовое кодирование (зелёный/красный)

## Отчёты

### GARCH Filtering Report
- Активы с условной волатильностью ≤ 30%
- Стабильность: α + β < 1
- Ликвидность

### Historical & Dividend Yield Report
- Историческая ценовая appreciation (%)
- Ожидаемая дивидендная доходность
- Совокупная доходность
- Сводная статистика
