import{c as a,r as l,d as s,l as t,p as e,A as o,B as i,U as n,F as c,z as r,D as d,u,q as p,K as v,L as m,Y as h,O as g,H as b}from"./vendor-DdjqA-DE.js";import{u as y,a as f,b as x,_ as w}from"./index-CPZWcFRR.js";import"./three-vendor-JfvIfzq4.js";import"./charts-DbP6hfG6.js";const C={class:"hero-section"},k={class:"hero-left"},_={class:"hero-meta"},R={class:"glass-pill"},M={class:"glass-pill"},V={class:"glass-pill"},F={class:"glass-pill"},j={class:"hero-actions"},A=["disabled"],K={key:0,width:"16",height:"16",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},D={key:1,class:"spinner"},O={class:"dashboard-grid hjb-grid"},z={class:"col-portfolio-wide"},E={class:"glass-panel portfolio-composition-panel"},U={class:"panel-body weights-body"},B={class:"weights-comparison"},P={class:"weights-table-container"},W={class:"weights-table"},S={class:"asset-cell"},H={class:"asset-info"},$={class:"symbol"},I={class:"name"},q={class:"text-right mono"},G={class:"text-right mono"},L={class:"text-right mono opacity-80"},Y={class:"text-right mono font-bold"},J={class:"col-3d-right"},N={class:"glass-panel"},Q={class:"panel-header"},T={class:"header-tabs"},X={class:"panel-body params-body"},Z={key:0},aa={class:"param-group"},la={class:"param-input-group"},sa=["max"],ta={class:"param-hint"},ea={class:"param-group"},oa={class:"param-input-group"},ia={class:"param-hint"},na={class:"param-group"},ca={class:"param-input-group"},ra={key:1},da={class:"param-group"},ua={class:"radio-group"},pa={class:"radio-item"},va={class:"radio-item"},ma={class:"glass-panel metrics-card"},ha={class:"panel-body metrics-value"},ga={class:"obj-value"},ba={class:"value"},ya={class:"obj-components"},fa={class:"component"},xa={class:"comp-value text-red"},wa={class:"component"},Ca={class:"comp-value text-green"},ka={class:"dashboard-grid hjb-grid"},_a={class:"col-portfolio-wide"},Ra={class:"glass-panel"},Ma={class:"panel-header"},Va={class:"header-tabs"},Fa={class:"panel-body weights-body"},ja={key:0,class:"weights-comparison"},Aa={class:"weights-table-container"},Ka={class:"weights-table"},Da={class:"asset-cell"},Oa={class:"asset-info"},za={class:"symbol"},Ea={class:"name"},Ua={class:"text-right mono"},Ba={class:"text-right mono font-bold"},Pa={class:"text-right mono"},Wa={key:1,class:"weights-optimal"},Sa={class:"weight-chart"},Ha={class:"weight-bar-info"},$a={class:"weight-bar-label"},Ia={class:"weight-bar-bg"},qa={class:"weight-bar-value mono"},Ga={class:"col-3d-right"},La={class:"glass-panel"},Ya={class:"panel-body"},Ja={class:"cluster-info"},Na={class:"info-row"},Qa={class:"value mono"},Ta={class:"info-row"},Xa={class:"value mono"},Za={class:"clusters-list"},al={class:"cluster-detail"},ll={class:"cluster-label"},sl={class:"cluster-assets"},tl={class:"asset-tag-symbol"},el={key:0,class:"asset-tag-weight"},ol={class:"cluster-count"},il={class:"dashboard-grid"},nl={class:"col-grid"},cl={class:"glass-panel"},rl={class:"panel-body metrics-table-body"},dl={class:"metrics-table"},ul={class:"cluster-cell"},pl={class:"mono text-right"},vl={class:"mono text-right"},ml={class:"mono text-right"},hl={class:"mono text-right font-bold"},gl={class:"mono text-right font-bold"},bl={class:"col-grid"},yl={class:"glass-panel"},fl={class:"panel-body allocation-body"},xl={class:"allocation-chart"},wl={class:"alloc-label"},Cl={class:"allocation-details"},kl={class:"alloc-name"},_l={class:"alloc-pct mono"},Rl={class:"col-grid"},Ml={class:"glass-panel metrics-card"},Vl={class:"panel-body"},Fl={class:"stat-row"},jl={class:"stat-val text-green"},Al={class:"stat-row"},Kl={class:"stat-val"},Dl={class:"stat-row"},Ol={class:"stat-val"},zl={class:"stat-row"},El={class:"stat-val mono"},Ul=w(s({__name:"CCMVOptimization",emits:["toast"],setup(s,{emit:w}){const Ul=w,Bl=l("comparison"),Pl=l("basic"),{isComputing:Wl,params:Sl,clusterColors:Hl,clusteringResult:$l,clusterMetrics:Il,objectiveValue:ql,objectiveComponents:Gl,portfolioStats:Ll,clusterAllocations:Yl,getDeltaClass:Jl,getOptimalWeight:Nl,getWeightDelta:Ql,getAssetAllocation:Tl,recomputeOptimization:Xl,portfolioPositions:Zl,selectedBank:as}=function(){const s=y(),t=f(),e=a(()=>s.positions),o=a(()=>s.correlationMatrix),i=a(()=>s.selectedBank),n=l(!1),c=l(null),r=l({Delta:3,bar_w:.25,gamma:2,method:"delta"}),d=a(()=>{if(!c.value){const a=e.value,l=a.length,s=[...a].sort((a,l)=>l.allocation-a.allocation),t=Math.ceil(s.length/3),o=[];for(let e=0;e<s.length;e+=t){const a=s.slice(e,e+t).map(a=>a.symbol);a.length>0&&o.push({assets:a})}return{numClusters:o.length||3,numAssets:l,clusters:o.length>0?o:[{assets:s.slice(0,Math.ceil(s.length/3)).map(a=>a.symbol)},{assets:s.slice(Math.ceil(s.length/3),Math.ceil(2*s.length/3)).map(a=>a.symbol)},{assets:s.slice(Math.ceil(2*s.length/3)).map(a=>a.symbol)}].filter(a=>a.assets.length>0)}}const a=c.value;return{numClusters:a.clusters.length,numAssets:a.optimal_weights.length,clusters:a.clusters.map(a=>({assets:a.assets}))}}),u=a(()=>{if(!c.value)return[{expectedReturn:.085,volatility:.18,avgCorrelation:.75,deltaK:2,alphaK:"delta"===r.value.method?.33:.35},{expectedReturn:.045,volatility:.08,avgCorrelation:.65,deltaK:1,alphaK:"delta"===r.value.method?.33:.3},{expectedReturn:.055,volatility:.12,avgCorrelation:.4,deltaK:1,alphaK:"delta"===r.value.method?.34:.35}];const a=c.value,l=o.value;return a.clusters.map(a=>{let s=0,t=0;for(let e=0;e<a.asset_indices.length;e++)for(let o=e+1;o<a.asset_indices.length;o++){const i=a.asset_indices[e],n=a.asset_indices[o];s+=l[i]?.values[n]||0,t++}return s=t>0?s/t:0,{expectedReturn:.06,volatility:.15,avgCorrelation:s,deltaK:a.delta_k,alphaK:a.alpha_k}})}),p=a(()=>{if(!c.value){const a={};return e.value.forEach(l=>{a[l.symbol]=l.allocation/100}),{weights:a,method:r.value.method}}const a=c.value,l={};return a.optimal_weights.forEach((a,s)=>{const t=e.value[s]?.symbol;t&&(l[t]=a)}),{weights:l,method:a.method}}),v=a(()=>c.value?c.value.portfolio_stats.objective_value:.0185-.0625*r.value.gamma),m=a(()=>{if(!c.value)return{variance:.0185,return:.0625};const a=c.value.portfolio_stats;return{variance:a.volatility*a.volatility,return:a.expected_return}}),h=a(()=>{if(!c.value)return{expectedReturn:.0625,volatility:.136,sharpeRatio:.15073529411764702,numPositions:Object.values(p.value.weights).filter(a=>a>.001).length};const a=c.value,l=a.portfolio_stats;return{expectedReturn:l.expected_return,volatility:l.volatility,sharpeRatio:l.sharpe_ratio,numPositions:a.optimal_weights.filter(a=>a>.001).length}}),g=a(()=>c.value?c.value.clusters.map(a=>({percentage:100*a.alpha_k})):u.value.map(a=>({percentage:100*a.alphaK}))),b=a=>{const l=p.value.weights[a];if(null!=l)return 100*l;const s=e.value.find(l=>l.symbol===a);return s?.allocation||0};return{isComputing:n,params:r,clusterColors:["#3b82f6","#10b981","#f59e0b"],clusteringResult:d,clusterMetrics:u,optimizationResult:p,objectiveValue:v,objectiveComponents:m,portfolioStats:h,clusterAllocations:g,ccmvOptimizationResult:c,getDeltaClass:a=>Math.abs(a)<.1?"neutral":a>0?"positive":"negative",getOptimalWeight:b,getWeightDelta:a=>b(a.symbol)-a.allocation,getAssetAllocation:a=>{if(c.value){const l=e.value.findIndex(l=>l.symbol===a);if(l>=0&&l<c.value.optimal_weights.length){const a=c.value.optimal_weights[l];return a>.001?100*a:null}}const l=e.value.find(l=>l.symbol===a);return l?.allocation||null},recomputeOptimization:async a=>{n.value=!0;try{const l=e.value,s=l.length;if(0===s)throw new Error("Портфель пуст");const i=252,n=[];for(let a=0;a<i;a++){const a=[];l.forEach(l=>{const s=l.dayChange/100/252+(Math.random()-.5)*(l.dayChange/100)/10;a.push(s)}),n.push(a)}const d=l.map(a=>{const l=a.dayChange/100*252;return Math.max(.01,.05+l)}),u=o.value,p=l.map(()=>.2),v=[];for(let a=0;a<s;a++){const l=[];for(let t=0;t<s;t++){const s=u[a]?.values[t]||(a===t?1:0);l.push(s*p[a]*p[t])}v.push(l)}const m=await x({R:n,mu:d,cov_matrix:v,Delta:r.value.Delta,bar_w:r.value.bar_w,gamma:r.value.gamma,method:r.value.method,asset_names:l.map(a=>a.symbol)});c.value=m;const h=24e5,g=m.portfolio_stats,b=t.calculateVaR(h,g.volatility,.95,1),y=t.calculateVaR(h,g.volatility,.99,1),f=l.map((a,l)=>{const s=m.optimal_weights[l]||0;return{symbol:a.symbol,allocation:100*s,notional:h*s,color:a.color}}),w=t.calculateRiskContributions(f,g.volatility,o.value,h);t.updateMetrics({var95:b.var,var99:y.var,cvar95:b.cvar,cvar99:y.cvar,expectedReturn:g.expected_return,volatility:g.volatility,sharpeRatio:g.sharpe_ratio,portfolioBeta:.85,riskContributions:w,maxDrawdown:.124}),a(`Оптимизация завершена (${"delta"===r.value.method?"Δ-CCMV":"α-CCMV"}). Sharpe = ${m.portfolio_stats.sharpe_ratio.toFixed(2)}`,"success")}catch(l){console.error("CCMV Optimization Error:",l),a(`Ошибка оптимизации: ${l instanceof Error?l.message:"Unknown error"}`,"error")}finally{n.value=!1}},portfolioPositions:e,selectedBank:i}}(),ls=()=>{Xl((a,l)=>{Ul("toast",{message:a,type:l})})};return(a,l)=>(b(),t("div",null,[e("div",C,[e("div",k,[l[13]||(l[13]=e("h1",null,"CCMV Optimization",-1)),e("div",_,[e("span",R,[l[9]||(l[9]=o("Метод: ",-1)),e("strong",null,i("delta"===n(Sl).method?"Δ-CCMV":"α-CCMV"),1)]),e("span",M,[l[10]||(l[10]=o("Кластеров: ",-1)),e("strong",null,i(n($l).numClusters),1)]),e("span",V,[l[11]||(l[11]=o("Банк: ",-1)),e("strong",null,i(n(as).name),1)]),e("span",F,[l[12]||(l[12]=o("Активов: ",-1)),e("strong",null,i(n(Zl).length),1)])])]),e("div",j,[e("button",{class:"btn-glass primary",onClick:ls,disabled:n(Wl)},[n(Wl)?(b(),t("span",D)):(b(),t("svg",K,[...l[14]||(l[14]=[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"},null,-1)])])),o(" "+i(n(Wl)?"Расчёт...":"Пересчитать"),1)],8,A)])]),e("div",O,[e("div",z,[e("div",E,[l[16]||(l[16]=e("div",{class:"panel-header"},[e("h3",null,"Состав портфеля")],-1)),e("div",U,[e("div",B,[e("div",P,[e("table",W,[l[15]||(l[15]=e("thead",null,[e("tr",null,[e("th",null,"Инструмент"),e("th",{class:"text-right"},"Цена"),e("th",{class:"text-right"},"День %"),e("th",{class:"text-right"},"Позиция"),e("th",{class:"text-right"},"Вес")])],-1)),e("tbody",null,[(b(!0),t(c,null,r(n(Zl),a=>(b(),t("tr",{key:a.symbol},[e("td",null,[e("div",S,[e("div",{class:"asset-icon",style:d({background:a.color})},i(a.symbol[0]),5),e("div",H,[e("span",$,i(a.symbol),1),e("span",I,i(a.name),1)])])]),e("td",q,"₽"+i(a.price),1),e("td",G,[e("span",{class:u(["change-pill",a.dayChange>0?"text-green":"text-red"])},i(a.dayChange>0?"+":"")+i(a.dayChange)+"% ",3)]),e("td",L,"₽"+i((a.notional/1e3).toFixed(1))+"k",1),e("td",Y,i(a.allocation)+"%",1)]))),128))])])])])])])]),e("div",J,[e("div",N,[e("div",Q,[l[17]||(l[17]=e("h3",null,"Параметры оптимизации",-1)),e("div",T,[e("button",{class:u(["tab-btn",{active:"basic"===Pl.value}]),onClick:l[0]||(l[0]=a=>Pl.value="basic")}," Основные ",2),e("button",{class:u(["tab-btn",{active:"methodology"===Pl.value}]),onClick:l[1]||(l[1]=a=>Pl.value="methodology")}," Методология ",2)])]),e("div",X,["basic"===Pl.value?(b(),t("div",Z,[e("div",aa,[l[18]||(l[18]=e("label",null,"Максимум активов (Δ)",-1)),e("div",la,[v(e("input",{type:"number","onUpdate:modelValue":l[2]||(l[2]=a=>n(Sl).Delta=a),min:"1",max:n($l).numAssets},null,8,sa),[[m,n(Sl).Delta,void 0,{number:!0}]]),e("span",ta,"из "+i(n($l).numAssets),1)])]),e("div",ea,[l[19]||(l[19]=e("label",null,"Макс. вес на актив (w̄)",-1)),e("div",oa,[v(e("input",{type:"number","onUpdate:modelValue":l[3]||(l[3]=a=>n(Sl).bar_w=a),min:"0.01",max:"1",step:"0.01"},null,512),[[m,n(Sl).bar_w,void 0,{number:!0}]]),e("span",ia,i((100*n(Sl).bar_w).toFixed(1))+"%",1)])]),e("div",na,[l[21]||(l[21]=e("label",null,"Коэффициент неприятия риска (γ)",-1)),e("div",ca,[v(e("input",{type:"number","onUpdate:modelValue":l[4]||(l[4]=a=>n(Sl).gamma=a),min:"0.1",max:"10",step:"0.1"},null,512),[[m,n(Sl).gamma,void 0,{number:!0}]]),l[20]||(l[20]=e("span",{class:"param-hint"},"выше = консервативнее",-1))])])])):p("",!0),"methodology"===Pl.value?(b(),t("div",ra,[e("div",da,[l[24]||(l[24]=e("label",null,"Методология",-1)),e("div",ua,[e("label",pa,[v(e("input",{type:"radio","onUpdate:modelValue":l[5]||(l[5]=a=>n(Sl).method=a),value:"delta"},null,512),[[h,n(Sl).method]]),l[22]||(l[22]=e("span",null,"Δ-CCMV (по количеству активов)",-1))]),e("label",va,[v(e("input",{type:"radio","onUpdate:modelValue":l[6]||(l[6]=a=>n(Sl).method=a),value:"alpha"},null,512),[[h,n(Sl).method]]),l[23]||(l[23]=e("span",null,"α-CCMV (по распределению)",-1))])])])])):p("",!0)])]),e("div",ma,[l[28]||(l[28]=e("div",{class:"panel-header"},[e("h3",null,"Целевая функция")],-1)),e("div",ha,[e("div",ga,[l[25]||(l[25]=e("span",{class:"label"},"f*(Δ, α) =",-1)),e("span",ba,i(n(ql).toFixed(6)),1)]),e("div",ya,[e("div",fa,[l[26]||(l[26]=e("span",{class:"comp-label"},"Риск",-1)),e("span",xa,i(n(Gl).variance.toFixed(6)),1)]),e("div",wa,[l[27]||(l[27]=e("span",{class:"comp-label"},"Возврат",-1)),e("span",Ca,i((n(Gl).return*n(Sl).gamma).toFixed(6)),1)])])])])])]),e("div",ka,[e("div",_a,[e("div",Ra,[e("div",Ma,[l[29]||(l[29]=e("h3",null,"Сравнение весов",-1)),e("div",Va,[e("button",{class:u(["tab-btn",{active:"comparison"===Bl.value}]),onClick:l[7]||(l[7]=a=>Bl.value="comparison")}," Сравнение ",2),e("button",{class:u(["tab-btn",{active:"optimal"===Bl.value}]),onClick:l[8]||(l[8]=a=>Bl.value="optimal")}," Оптимальные ",2)])]),e("div",Fa,["comparison"===Bl.value?(b(),t("div",ja,[e("div",Aa,[e("table",Ka,[l[30]||(l[30]=e("thead",null,[e("tr",null,[e("th",null,"Инструмент"),e("th",{class:"text-right"},"Текущий вес"),e("th",{class:"text-right"},"Оптимальный вес"),e("th",{class:"text-right"},"Изменение")])],-1)),e("tbody",null,[(b(!0),t(c,null,r(n(Zl),a=>(b(),t("tr",{key:a.symbol},[e("td",null,[e("div",Da,[e("div",{class:"asset-icon",style:d({background:a.color})},i(a.symbol[0]),5),e("div",Oa,[e("span",za,i(a.symbol),1),e("span",Ea,i(a.name),1)])])]),e("td",Ua,i(a.allocation)+"%",1),e("td",Ba,i(n(Nl)(a.symbol).toFixed(1))+"%",1),e("td",Pa,[e("span",{class:u(["change-pill",n(Jl)(n(Ql)(a))])},i(n(Ql)(a)>0?"+":"")+i(n(Ql)(a).toFixed(1))+"% ",3)])]))),128))])])])])):p("",!0),"optimal"===Bl.value?(b(),t("div",Wa,[e("div",Sa,[(b(!0),t(c,null,r(n(Zl),a=>(b(),t("div",{key:a.symbol,class:"weight-bar-container"},[e("div",Ha,[e("div",{class:"asset-icon-small",style:d({background:a.color})},i(a.symbol[0]),5),e("div",$a,i(a.symbol),1)]),e("div",Ia,[e("div",{class:"weight-bar-fill",style:d({width:n(Nl)(a.symbol)+"%",background:a.color})},null,4)]),e("div",qa,i(n(Nl)(a.symbol).toFixed(1))+"%",1)]))),128))])])):p("",!0)])])]),e("div",Ga,[e("div",La,[l[34]||(l[34]=e("div",{class:"panel-header"},[e("h3",null,"Иерархическая кластеризация")],-1)),e("div",Ya,[e("div",Ja,[e("div",Na,[l[31]||(l[31]=e("span",{class:"label"},"Количество кластеров:",-1)),e("span",Qa,i(n($l).numClusters),1)]),e("div",Ta,[l[32]||(l[32]=e("span",{class:"label"},"Активов в портфеле:",-1)),e("span",Xa,i(n(Zl).length),1)]),l[33]||(l[33]=g('<div class="info-row" data-v-b440f426><span class="label" data-v-b440f426>Метрика расстояния:</span><span class="value mono" data-v-b440f426>1 - ρ (корреляция)</span></div><div class="info-row" data-v-b440f426><span class="label" data-v-b440f426>Метод кластеризации:</span><span class="value mono" data-v-b440f426>Иерархическая (Ward)</span></div>',2))]),e("div",Za,[(b(!0),t(c,null,r(n($l).clusters,(a,l)=>(b(),t("div",{class:"cluster-row",key:l},[e("div",{class:"cluster-badge",style:d({background:n(Hl)[l%n(Hl).length]})}," C"+i(l+1),5),e("div",al,[e("div",ll,"Кластер "+i(l+1),1),e("div",sl,[(b(!0),t(c,null,r(a.assets,a=>(b(),t("div",{class:"asset-tag",key:a},[e("span",tl,i(a),1),n(Tl)(a)?(b(),t("span",el,i(n(Tl)(a))+"%",1)):p("",!0)]))),128))])]),e("div",ol,i(a.assets.length)+" "+i(1===a.assets.length?"актив":a.assets.length<5?"актива":"активов"),1)]))),128))])])])])]),e("div",il,[e("div",nl,[e("div",cl,[l[36]||(l[36]=e("div",{class:"panel-header"},[e("h3",null,"Метрики по кластерам")],-1)),e("div",rl,[e("table",dl,[l[35]||(l[35]=e("thead",null,[e("tr",null,[e("th",null,"Кластер"),e("th",null,"μ (E[R])"),e("th",null,"σ (Vol)"),e("th",null,"ρ̄"),e("th",null,"Δₖ"),e("th",null,"αₖ")])],-1)),e("tbody",null,[(b(!0),t(c,null,r(n(Il),(a,l)=>(b(),t("tr",{key:l},[e("td",null,[e("div",ul,[e("div",{class:"cluster-dot",style:d({background:n(Hl)[l]})},null,4),e("span",null,"C"+i(l+1),1)])]),e("td",pl,i((100*a.expectedReturn).toFixed(2))+"%",1),e("td",vl,i((100*a.volatility).toFixed(2))+"%",1),e("td",ml,i(a.avgCorrelation.toFixed(3)),1),e("td",hl,i(a.deltaK),1),e("td",gl,i((100*a.alphaK).toFixed(1))+"%",1)]))),128))])])])])]),e("div",bl,[e("div",yl,[l[38]||(l[38]=e("div",{class:"panel-header"},[e("h3",null,"Распределение по кластерам")],-1)),e("div",fl,[e("div",xl,[(b(!0),t(c,null,r(n(Yl),(a,s)=>(b(),t("div",{key:s,class:"alloc-segment",style:d({flexGrow:a.percentage,background:n(Hl)[s]})},[e("span",wl,[o("C"+i(s+1),1),l[37]||(l[37]=e("br",null,null,-1)),o(i(a.percentage.toFixed(1))+"%",1)])],4))),128))]),e("div",Cl,[(b(!0),t(c,null,r(n(Yl),(a,l)=>(b(),t("div",{key:l,class:"alloc-row"},[e("div",{class:"alloc-dot",style:d({background:n(Hl)[l]})},null,4),e("span",kl,"Кластер "+i(l+1),1),e("span",_l,i(a.percentage.toFixed(1))+"%",1)]))),128))])])])]),e("div",Rl,[e("div",Ml,[l[43]||(l[43]=e("div",{class:"panel-header"},[e("h3",null,"Статистика портфеля")],-1)),e("div",Vl,[e("div",Fl,[l[39]||(l[39]=e("span",{class:"stat-label"},"Expected Return",-1)),e("span",jl,i((100*n(Ll).expectedReturn).toFixed(2))+"%",1)]),e("div",Al,[l[40]||(l[40]=e("span",{class:"stat-label"},"Volatility",-1)),e("span",Kl,i((100*n(Ll).volatility).toFixed(2))+"%",1)]),e("div",Dl,[l[41]||(l[41]=e("span",{class:"stat-label"},"Sharpe Ratio",-1)),e("span",Ol,i(n(Ll).sharpeRatio.toFixed(3)),1)]),e("div",zl,[l[42]||(l[42]=e("span",{class:"stat-label"},"Кол-во позиций",-1)),e("span",El,i(n(Ll).numPositions),1)])])])])])]))}}),[["__scopeId","data-v-b440f426"]]);export{Ul as default};
