import{g as t}from"./index-Ba4DjugF.js";const e="   https://stochastic-dashbord-v1-production.up.railway.app";async function n(t,e={}){const n=new URL(`https://iss.moex.com/iss${t}.json`);n.searchParams.set("iss.json","extended"),n.searchParams.set("iss.meta","off"),n.searchParams.set("lang","ru");for(const[r,i]of Object.entries(e))n.searchParams.set(r,i);const a=await fetch(n.toString());if(!a.ok)throw new Error(`MOEX ISS ${a.status}: ${t}`);return a.json()}function a(t,e){if(!t||!t[1]||!t[1][e])return[];const n=t[1][e];return Array.isArray(n)?n:n.data&&n.columns?n.data.map(t=>{const e={};return n.columns.forEach((n,a)=>{e[n]=t[a]}),e}):[]}async function r(t){const e=await n(`/securities/${t}`),r=a(e,"description"),i={};r.forEach(t=>{const e=(t.name||t.NAME||"").toLowerCase();i[e]=t.value||t.VALUE||""});const o=a(e,"boards"),u=o.find(t=>"TQCB"===t.boardid||"TQCB"===t.BOARDID),s=o[0]||{},c=(u||s)?.secid||(u||s)?.SECID||t;return{isin:i.isin||t,secid:c,shortname:i.shortname||i.name||"",name:i.name||i.shortname||"",issuer:i.emitter_id||i.issuername||i.name||"",facevalue:parseFloat(i.facevalue)||1e3,faceunit:i.faceunit||"RUB",issuedate:i.issuedate||"",matdate:i.matdate||"",couponpercent:parseFloat(i.couponpercent)||0,couponfrequency:parseInt(i.couponfrequency)||0,couponvalue:parseFloat(i.couponvalue)||0,type:i.type||"",typename:i.typename||"",group:i.group||"",listlevel:parseInt(i.listlevel)||0,initialfacevalue:parseFloat(i.initialfacevalue)||parseFloat(i.facevalue)||1e3}}async function i(t,e,r,i="TQCB"){const o=[];let u=0;for(;;){const s=a(await n(`/history/engines/stock/markets/bonds/boards/${i}/securities/${t}`,{from:e,till:r,start:u.toString()}),"history");if(!s.length)break;for(const t of s)o.push({date:t.TRADEDATE||t.tradedate||"",close:t.CLOSE||t.close||0,yield_close:t.YIELDCLOSE??t.yieldclose??null,volume:t.VOLUME||t.volume||0,num_trades:t.NUMTRADES||t.numtrades||0,value:t.VALUE||t.value||0,waprice:t.WAPRICE??t.waprice??null,duration:t.DURATION??t.duration??null});if(s.length<100)break;u+=s.length}return o}async function o(t){const e=await n(`/engines/stock/markets/bonds/securities/${t}`),r=a(e,"marketdata"),i=a(e,"securities"),o=r.find(e=>(e.SECID||e.secid)===t)||r[0]||{},u=i.find(e=>(e.SECID||e.secid)===t)||i[0]||{};return{last:o.LAST??o.last??null,bid:o.BID??o.bid??null,offer:o.OFFER??o.offer??null,spread:o.SPREAD??o.spread??null,yield:o.YIELD??o.yield??null,duration:o.DURATION??o.duration??null,accruedint:u.ACCRUEDINT??u.accruedint??null,waprice:o.WAPRICE??o.waprice??null,closeprice:o.CLOSEPRICE??o.closeprice??null,marketprice:o.MARKETPRICE2??u.PREVWAPRICE??u.prevwaprice??null}}function u(){const t=localStorage.getItem("rudata_credentials");if(!t)return null;try{return JSON.parse(atob(t))}catch{return null}}async function s(n,a={},r){const i=r||u();if(!i)return null;try{const r=await fetch(`${e}/api/rudata/query`,{method:"POST",headers:t(),body:JSON.stringify({login:i.login,password:i.password,path_method:n,body:a})});if(!r.ok)return null;const o=await r.json();return o.success?o.data:null}catch{return null}}async function c(n,a){const r=a||u();if(!r)return null;try{const a=await fetch(`${e}/api/rudata/fintool/reference?id=${n}`,{method:"POST",headers:t(),body:JSON.stringify({login:r.login,password:r.password})});if(!a.ok)return null;const i=await a.json();return i.success?i.data:null}catch{return null}}async function l(n,a,r,i){const o=i||u();if(!o)return null;try{const i=await fetch(`${e}/api/rudata/bond/calculate`,{method:"POST",headers:t(),body:JSON.stringify({login:o.login,password:o.password,isin:n,calc_date:a,price:r})});if(!i.ok)return null;const u=await i.json();if(!u.success||!u.data)return null;const s=Array.isArray(u.data)?u.data[0]:u.data;return s?{ytm:s.ytm??s.YTM??s.yld??s.yield_to_maturity??null,ytp:s.ytp??s.YTP??s.yield_to_put??s.y2o_last??s.Y2O_LAST??null,duration_days:s.duration??s.DURATION??null,duration_years:s.duration?s.duration/365:null,mod_duration:s.duration_n??s.modified_duration??s.mod_duration??null,convexity:s.convexity??s.CONVEXITY??null,offer_date:s.offer_date??s.offerdate??null,coupon_rate:s.cpn_rate??s.coupon_rate??s.couponrate??null,facevalue:s.current_fv??s.facevalue??s.nominal??null,accrued_interest:s.accruedint??s.accrued_interest??null,dm_bps:s.dm??s.discount_margin??null}:null}catch{return null}}async function d(t,e,n){const a=n||u();if(!a)return{offer_date:null,cpn_rate:null,current_fv:null};try{const n=await s("Bond/DateParams",{isin:t,date:e,fields:"offer_date,cpn_rate,current_fv"},a);if(!n)return{offer_date:null,cpn_rate:null,current_fv:null};const r=Array.isArray(n)?n[0]:n;return{offer_date:r?.offer_date??null,cpn_rate:r?.cpn_rate??null,current_fv:r?.current_fv??null}}catch{return{offer_date:null,cpn_rate:null,current_fv:null}}}async function f(t,e){const n=e||u();if(!n)return[];try{const e=await s("Rating/List",{filter:`fintoolid = '${t}' OR isin_code = '${t}'`,count:100},n);return e&&Array.isArray(e)?e.map(t=>({agency:t.ra_name||t.agency||"",rating:t.last_rating||t.rating||"",outlook:t.forecast||t.outlook||null,date:t.last_dt?String(t.last_dt).split("T")[0]:null})):[]}catch{return[]}}async function p(t,e){const n=e||u();if(!n)return[];try{const e=await s("Rating/List",{filter:`org_name LIKE '%${t}%'`,count:100},n);return e&&Array.isArray(e)?e.map(t=>({agency:t.ra_name||t.agency||"",rating:t.last_rating||t.rating||"",outlook:t.forecast||t.outlook||null,date:t.last_dt?String(t.last_dt).split("T")[0]:null})):[]}catch{return[]}}async function y(t){try{const e=await n(`/cci/rating/securities/${t}`),r=a(e,"ratings")||a(e,"rating"),i=[],o=[];for(const t of r){const e={agency:t.agency||t.AGENCY||t.ra_name||"",rating:t.rating||t.RATING||t.last_rating||"",outlook:t.outlook||t.OUTLOOK||t.forecast||null,date:t.date||t.DATE||t.last_dt||null},n=(t.type||t.TYPE||"").toLowerCase();n.includes("issuer")||n.includes("эмитент")?o.push(e):i.push(e)}return{issue:i,issuer:o}}catch{return{issue:[],issuer:[]}}}function m(t,e){const n=!!t&&""!==t.trim(),a=!!e&&""!==e.trim();return a&&!n?{type:"Call",date:e}:a&&n?{type:"Put",date:t}:{type:"Нет",date:null}}async function _(n,a){try{const r={term:n.toString(),method:"nelson_siegel"};a&&(r.date=a);const i=await fetch(`${e}/api/zcyc/interpolate`,{method:"POST",headers:t(),body:JSON.stringify(r)});if(!i.ok)return await g(n,a);return((await i.json()).value||0)/100}catch{return await g(n,a)}}async function g(t,e){try{const r={};e&&(r.date=e);const i=await n("/statistics/engines/stock/zcyc",r),o=a(i,"yearyields")||a(i,"params");if(!o.length)return 0;const u=o[0],s=u.b0??u.B0??0,c=u.b1??u.B1??0,l=u.b2??u.B2??0,d=u.g1??u.G1??1,f=(t||1)/d,p=Math.exp(-f);return(s+c*((1-p)/f)+l*((1-p)/f-p))/100}catch{return 0}}async function A(t,e,n,a,r){const i=new Date(n),o=new Date(i.getTime()-2592e6),c=o.toISOString().split("T")[0],l=new Date(i.getTime()-864e5).toISOString().split("T")[0],d=await async function(t,e,n,a){const r=u();if(!r)return{};try{const i=await s("Efir/HistoryAgg",{isin:t,dateFrom:e,dateTo:n,mode:"DO",fields:a.join(",")},r);return i&&(Array.isArray(i)?i[0]:i)||{}}catch{return{}}}(t,c,l,["DEAL_ACC.SUM","DEAL_ACC.CNN","VAL_ACC.SUM"]);let f=0,p=0,y=0;if(!d||void 0===d["DEAL_ACC.SUM"]&&void 0===d["DEAL_ACC.CNN"]){const t=r.filter(t=>{const e=new Date(t.date);return e>=o&&e<=i});p=t.filter(t=>t.num_trades>0).length,f=t.reduce((t,e)=>t+e.num_trades,0),y=t.reduce((t,e)=>t+e.value,0)}else f=Number(d["DEAL_ACC.SUM"])||0,p=Number(d["DEAL_ACC.CNN"])||0,y=Number(d["VAL_ACC.SUM"])||0;const m=a>0?y/a:0;return{trading_days:p,trades:f,turnover_to_outstanding:m,traded_last_30d:p>0,total_volume:y,is_active:f>=10&&p>=5&&m>=.001}}function h(t,e,n,a,r){if(r<=0||a<=0)return 0;const i=n*e/a,o=Math.round(a*r),u=t/100*e;let s=n||.1;for(let c=0;c<200;c++){let t=0,n=0;for(let u=1;u<=o;u++){const r=u===o?i+e:i,c=Math.pow(1+s/a,-u);t+=r*c,n-=u/a*r*c/(1+s/a)}const r=t-u;if(Math.abs(r)<1e-4)break;if(Math.abs(n)<1e-12)break;s-=r/n,s<-.5&&(s=.001),s>2&&(s=1.999)}return s}function w(t,e,n,a,r){if(r<=0||a<=0)return 0;const i=n*e/a,o=Math.round(a*r);let u=0,s=0;for(let c=1;c<=o;c++){const n=c/a,r=(c===o?i+e:i)*Math.pow(1+t/a,-c);u+=n*r,s+=r}return s>0?u/s:0}const v=["TQCB","TQOB","TQIR"];async function T(t,e){try{const r={};e&&(r.from=e,r.till=e);const i=await n(`/statistics/engines/stock/markets/index/analytics/${t}`,r),o=a(i,"analytics")||a(i,"indices");if(o.length){const t=o[o.length-1],e=t.close??t.CLOSE??t.currentvalue??t.CURRENTVALUE??null;return null!==e?e/100:null}return await b(t,e)}catch{return await b(t,e)}}async function b(t,e){try{const r=e||(new Date).toISOString().split("T")[0],i=new Date(new Date(r).getTime()-864e6).toISOString().split("T")[0],o=a(await n(`/history/engines/stock/markets/index/boards/SNDX/securities/${t}`,{from:i,till:r}),"history");if(!o.length)return null;const u=o[o.length-1],s=u.CLOSE??u.close??null;return null!==s?s/100:null}catch{return null}}async function R(t,e){const g=u(),b=await r(t),R=await c(t,g??void 0),D=R&&Array.isArray(R)&&R.length>0?R[0]:null,S=D?.sumissueval||D?.issueval||D?.summarketval||1e6*b.facevalue,E=D?.offer_date||D?.offerdate||null,C=await d(t,e,g??void 0),O=C.offer_date,k=C.cpn_rate??b.couponpercent/100,B=C.current_fv??b.facevalue,N=m(O,E),U="Нет"!==N.type,M=await o(b.secid),I=e,L=new Date(new Date(I).getTime()-34128e6).toISOString().split("T")[0],{history:P}=await async function(t,e,n){for(const a of v){const r=await i(t,e,n,a);if(r.length>0)return{history:r,board:a}}return{history:[],board:"TQCB"}}(b.secid,L,I),$=await async function(t){try{const e=await n(`/securities/${t}/bondization`),r=a(e,"coupons"),i=a(e,"amortizations"),o=a(e,"offers"),u=r.map(t=>({date:t.coupondate||t.COUPONDATE||"",value:t.value||t.VALUE||0,valueprc:t.valueprc||t.VALUEPRC||0,value_rub:t.value_rub||t.VALUE_RUB||t.value||t.VALUE||0}));return{coupons:u,amortizations:i.map(t=>({date:t.amortdate||t.AMORTDATE||"",value:t.value||t.VALUE||0,valueprc:t.valueprc||t.VALUEPRC||0})),offers:o.map(t=>({date:t.offerdate||t.OFFERDATE||"",type:t.offertypename||t.OFFERTYPENAME||""}))}}catch{return{coupons:[],amortizations:[],offers:[]}}}(t),Y=new Date(e),x=(new Date(b.matdate).getTime()-Y.getTime())/31536e6,F=M.last??M.waprice??M.closeprice??M.marketprice??100,q=await l(t,e,F,g??void 0),V=await async function(t,e,n){const a=n||u();if(!a)return{convexity:null,duration_n:null};try{const n=await s("Efir/Yields",{isin:t,date:e,fields:"convexity,duration_n"},a);if(!n)return{convexity:null,duration_n:null};const r=Array.isArray(n)?n[0]:n;return{convexity:r?.convexity??null,duration_n:r?.duration_n??null}}catch{return{convexity:null,duration_n:null}}}(t,e,g??void 0),j=await async function(t,e,n,a){const r=a||u();if(!r)return{};try{const a=await s("Efir/EndOfDay",{isin:t,date:e,fields:n.join(",")},r);return a&&(Array.isArray(a)?a[0]:a)||{}}catch{return{}}}(t,e,["duration","Y2O_LAST","DURATION_O"],g??void 0);let z,G="YTM";U?(G="YTP",z=null!==(q?.ytp??null)?q.ytp:null!=j.Y2O_LAST?Number(j.Y2O_LAST)/100:M.yield&&M.yield>0?M.yield/100:h(F,B,k,b.couponfrequency||2,x)):(G="YTM",z=null!==(q?.ytm??null)?q.ytm:M.yield&&M.yield>0?M.yield/100:h(F,B,k,b.couponfrequency||2,x));const Q=100*z;let J,K,W;if(U){const t=j.DURATION_O??j.duration_o??null;J=null!=t?Number(t)/365:null!==(q?.duration_years??null)?q.duration_years:M.duration?M.duration/365:w(z,B,k,b.couponfrequency||2,x)}else{const t=j.duration??null;J=null!=t?Number(t)/365:null!==(q?.duration_years??null)?q.duration_years:M.duration?M.duration/365:w(z,B,k,b.couponfrequency||2,x)}K=V.duration_n??q?.mod_duration??null,null==K&&(K=J/(1+z/(b.couponfrequency||2))),W=V.convexity??q?.convexity??null,null==W&&(W=function(t,e,n,a,r){if(r<=0||a<=0)return 0;const i=n*e/a,o=Math.round(a*r);let u=0,s=0;const c=t/a;for(let l=1;l<=o;l++){const t=l===o?i+e:i;u+=t*l*(l+1)*Math.pow(1+c,-(l+2)),s+=t*Math.pow(1+c,-l)}return s<=0?0:u/(s*a*a)}(z,B,k,b.couponfrequency||2,x));const X=await _(J,e),H=100*X,Z=100*(Q-H),tt=Math.round(100*Z)/100,et=function(t,e){return Math.abs(1e6*(1e-4*-t+.5*e*1e-4*1e-4))}(K,W),nt=F/100*B+(M.accruedint??q?.accrued_interest??0),[at,rt,it]=await Promise.all([y(t),f(t,g??void 0),b.issuer?p(b.issuer,g??void 0):Promise.resolve([])]),ot=rt.length>0?rt:at.issue,ut=it.length>0?it:at.issuer,st=await A(t,b.secid,e,S,P),ct=await async function(t,e){const n=function(t){return t<1?{gov:{ticker:"RUGBITR1Y",name:"Доходность индекса государственных облигаций (менее года)"},aaa:{ticker:"RUCBTRAAANS",name:"Доходность индекса корпоративных облигаций с рейтингом AAA"},aa:{ticker:"RUCBTRAANS",name:"Доходность индекса корпоративных облигаций с рейтингом AA"},a:{ticker:"RUCBTRANS",name:"Доходность индекса корпоративных облигаций с рейтингом A"},bbb:{ticker:"RUCBTRBBBNS",name:"Доходность индекса корпоративных облигаций с рейтингом BBB"}}:t<3?{gov:{ticker:"RUGBITR3Y",name:"Доходность индекса государственных облигаций (1-3 года)"},aaa:{ticker:"RUCBTR3A3YNS",name:"Доходность индекса корпоративных облигаций с рейтингом AAA (1-3 года)"},aa:{ticker:"RUCBTRAA3YNS",name:"Доходность индекса корпоративных облигаций с рейтингом AA (1-3 года)"},a:{ticker:"RUCBTRA3YNS",name:"Доходность индекса корпоративных облигаций с рейтингом A (1-3 года)"},bbb:{ticker:"RUCBTRBBBNS",name:"Доходность индекса корпоративных облигаций с рейтингом BBB"}}:t<5?{gov:{ticker:"RUGBITR5Y",name:"Доходность индекса государственных облигаций (3-5 лет)"},aaa:{ticker:"RUCBTR3A5YNS",name:"Доходность индекса корпоративных облигаций с рейтингом AAA (3-5 лет)"},aa:{ticker:"RUCBTRAA5YNS",name:"Доходность индекса корпоративных облигаций с рейтингом AA (3-5 лет)"},a:{ticker:"RUCBTRA5YNS",name:"Доходность индекса корпоративных облигаций с рейтингом A (3-5 лет)"},bbb:{ticker:"RUCBTRBBBNS",name:"Доходность индекса корпоративных облигаций с рейтингом BBB"}}:{gov:{ticker:"RUGBITR5+",name:"Доходность индекса государственных облигаций (более 5 лет)"},aaa:{ticker:"RUCBTR3A5YNS",name:"Доходность индекса корпоративных облигаций с рейтингом AAA (3-5 лет)"},aa:{ticker:"RUCBTRAA5YNS",name:"Доходность индекса корпоративных облигаций с рейтингом AA (3-5 лет)"},a:{ticker:"RUCBTRA5YNS",name:"Доходность индекса корпоративных облигаций с рейтингом A (3-5 лет)"},bbb:{ticker:"RUCBTRBBBNS",name:"Доходность индекса корпоративных облигаций с рейтингом BBB"}}}(t),a={},[r,i,o,u,s]=await Promise.allSettled([T(n.gov.ticker,e),T(n.aaa.ticker,e),T(n.aa.ticker,e),T(n.a.ticker,e),T(n.bbb.ticker,e)]);return"fulfilled"===r.status&&null!==r.value&&(t<1?a.gov_less_1y=r.value:t<3?a.gov_1_3y=r.value:t<5?a.gov_3_5y=r.value:a.gov_5plus=r.value),"fulfilled"===i.status&&null!==i.value&&(a.corp_aaa=i.value),"fulfilled"===o.status&&null!==o.value&&(a.corp_aa=o.value),"fulfilled"===u.status&&null!==u.value&&(a.corp_a=u.value),"fulfilled"===s.status&&null!==s.value&&(a.corp_bbb=s.value),a}(J,e),lt=await async function(t){const e=u();if(e)try{const n=await s("News/List",{filter:`isin_code = '${t}'`,count:20},e);if(n&&Array.isArray(n)&&n.length>0)return n.map(t=>({date:t.pub_date?String(t.pub_date).split("T")[0]:null,description:t.title||t.subject||t.text||""}))}catch{}try{const e=a(await n(`/securities/${t}/bondization`),"offers"),r=[];for(const t of e)r.push({date:t.offerdate||t.OFFERDATE||null,description:`Оферта: ${t.offertypename||t.OFFERTYPENAME||"Без типа"}`});return r}catch{return[]}}(t),dt=function(t){return t.filter(t=>t.close>0||t.waprice&&t.waprice>0).map(t=>({date:t.date,price:t.waprice||t.close}))}(P),ft=await async function(t,e,n,a,r){const i=[],o=new Date(e),u=new Date(r.matdate),s=[];for(let c=0;c<13;c++){const t=new Date(o);t.setMonth(t.getMonth()-c),s.push(t.toISOString().split("T")[0])}for(const c of s){const t=new Date(c);let e=null,a=1/0;for(const r of n){if(!r.close&&!r.waprice)continue;const n=new Date(r.date),i=Math.abs(n.getTime()-t.getTime());i<a&&(a=i,e=r)}if(!e||a>864e6)continue;const o=new Date(e.date),s=(u.getTime()-o.getTime())/31536e6;let l=0;if(e.yield_close&&e.yield_close>0?l=e.yield_close/100:e.close>0&&(l=h(e.close,r.facevalue,r.couponpercent/100,r.couponfrequency||2,s)),l<=0)continue;let d=e.duration||0;!d&&s>0&&(d=365*s);const f=d/365,p=await _(f,e.date),y=100*l,m=100*p,g=1e4*(l-p);i.push({date:e.date,ytm:y,gcurve:m,gspread:Math.round(100*g)/100})}return i.sort((t,e)=>new Date(t.date).getTime()-new Date(e.date).getTime()),i}(b.secid,e,P,0,b);let pt="Россия",yt="",mt="";D&&(pt=D.country||D.issuercountry||"Россия",yt=D.sectorbond||D.sector||"",mt=D.branch||D.industry||"");const _t=M.accruedint??q?.accrued_interest??null,gt=function(t,e,n){return n<=0?0:t*e/(n/100*e)*100}(k,B,F),At=$.coupons.filter(t=>new Date(t.date)>Y);return $.coupons.filter(t=>new Date(t.date)<=Y),{isin:b.isin||t,issuer:b.name||b.shortname||b.issuer||t,risk_country:pt,sector:yt||"Корпоративный",industry:mt,outstanding_amount:S,listing_level:b.listlevel||null,currency:b.faceunit||"RUB",nkd:_t,current_yield:gt>0?Math.round(100*gt)/100:null,issue_info:{issue_date:D?.begdistdate||b.issuedate||null,maturity_date:D?.endmtydate||b.matdate||null,coupon_rate:k,coupon_per_year:D?.couponperyear||b.couponfrequency||null,nominal:B,offer:N},ratings:{issue:ot,issuer:ut,guarantor:[]},market_activity:st,pricing:{clean_price_pct:F,dirty_price:nt,ytm:z,ytm_pct:Q,g_spread_bps:tt,g_curve_yield:X,g_curve_pct:H,yield_type:G},risk_indicators:{duration:Math.round(1e4*J)/1e4,mod_duration:Math.round(1e4*K)/1e4,convexity:Math.round(100*W)/100,dv01:Math.round(100*et)/100},indices:ct,corporate_events:lt,price_history:dt,yield_history:ft,analogous_bonds:[],coupon_schedule:At,amortization_schedule:$.amortizations.filter(t=>new Date(t.date)>Y)}}async function D(t,e){const o=u(),d=await R(t,e),f=await r(t);let p="",y=0,m=null,_=null;const g=await c(t,o??void 0);if(g&&Array.isArray(g)&&g.length>0){const t=g[0];p=t.coupon_type_desc||t.floatratename||t.coupondesc||"",t.floatratemargin&&(y=100*t.floatratemargin),m=t.floatratename||t.base_rate_name||null,null!=t.floatratevalue&&(_=t.floatratevalue)}if(!m&&p&&(/КС|ключев/i.test(p)?m="Ключевая ставка ЦБ РФ":/RUONIA/i.test(p)?m="RUONIA":/MosPrime/i.test(p)?m="MosPrime Rate":/ИПЦ|CPI/i.test(p)&&(m="ИПЦ")),p&&0===y){const t=p.match(/([+-])\s*([\d,.]+)\s*%?\s*$/);t&&(y=parseFloat(t[2].replace(",","."))*("-"===t[1]?-100:100))}!p&&f.couponpercent>0&&(p=`Переменная ставка (${f.couponpercent}%)`);let A=null;const h=await l(t,e,d.pricing.clean_price_pct,o??void 0);if(null!=h?.dm_bps&&(A=h.dm_bps),null==A&&d.pricing.dirty_price&&d.coupon_schedule.length>0){const t=new Date(e),n=_??d.pricing.ytm_pct-y/100,a=d.coupon_schedule.map(e=>({yearFraction:(new Date(e.date).getTime()-t.getTime())/31536e6,amount:e.value||e.valueprc/100*(f.facevalue||1e3),refRate:n>0?n:15}));a.length>0&&(a[a.length-1].amount+=f.facevalue||1e3);const r=d.issue_info.coupon_per_year||f.couponfrequency||4;A=function(t,e,n,a,r=100,i=1e-8){if(!n.length||t<=0||a<=0)return 0;const o=a;let u=0;for(let s=0;s<r;s++){let e=0,a=0;const r=u/1e4;for(const t of n){const n=t.refRate/100/o+r/o,i=t.yearFraction*o,u=Math.pow(1+n,i);u<=0||(e+=t.amount/u,a+=-t.amount*i*(1/o)/Math.pow(1+n,i+1))}const s=e-t;if(Math.abs(s)<i)break;if(Math.abs(a)<1e-12)break;u-=s/a,u<-5e3&&(u=-4999),u>5e4&&(u=49999)}return u}(d.pricing.dirty_price,f.facevalue,a,r),A=Math.round(100*A)/100}const w=a(await n(`/securities/${t}/bondization`),"coupons"),v=new Date(e),T=w.filter(t=>new Date(t.coupondate||t.COUPONDATE||"")>v).sort((t,e)=>new Date(t.coupondate||t.COUPONDATE||"").getTime()-new Date(e.coupondate||e.COUPONDATE||"").getTime()),b=T.length>0?(T[0].valueprc??T[0].VALUEPRC??T[0].value??T[0].VALUE??0)/100:null;let D=null;if(o&&d.issuer)try{const t=await s("Bond/List",{filter:`issuername LIKE '%${d.issuer.substring(0,20)}%' AND status = 'В обращении'`,count:200},o);t&&Array.isArray(t)&&(D=t.length)}catch{}const S=`с ${E(new Date(new Date(e).getTime()-2592e6))} по ${E(new Date(e))}`,C=await async function(t,e,n,a){const r=u(),o=[],s=new Date(n);for(let i=0;i<13;i++){const e=new Date(s);e.setMonth(e.getMonth()-i);const n=e.toISOString().split("T")[0],u=await l(t,n,void 0,r??void 0);null!=u?.dm_bps&&o.push({date:n,dm:u.dm_bps,qm:a,price:void 0})}if(0===o.length){const t=new Date(s.getTime()-34128e6).toISOString().split("T")[0],r=await i(e,t,n);for(let e=0;e<13;e++){const t=new Date(s);t.setMonth(t.getMonth()-e);const n=t.getTime();let i=null,u=1/0;for(const e of r){const t=Math.abs(new Date(e.date).getTime()-n);t<u&&null!=e.yield_close&&(u=t,i=e)}if(i&&u<864e6){const t=100*(i.yield_close||0)-a;o.push({date:i.date,dm:t,qm:a,price:i.close||void 0})}}}return o.sort((t,e)=>new Date(t.date).getTime()-new Date(e.date).getTime()),o}(t,f.secid,e,y);return{...d,issues_count:D,analysis_period:S,coupon_formula:p||null,base_rate_name:m,base_rate_value:_,dm_bps:A,qm_bps:y||null,issue_info:{...d.issue_info,coupon_formula:p||null,next_coupon:b,nominal:f.facevalue},margin_history:C,analogous_bonds_note:void 0}}async function S(t,e){try{const n=u(),a=await r(t),i=await o(a.secid),s=new Date(a.matdate),f=new Date(e),p=(s.getTime()-f.getTime())/31536e6,y=i.last??i.waprice??i.closeprice??i.marketprice??100,_=await d(t,e,n??void 0),g=await c(t,n??void 0),A=g&&Array.isArray(g)&&g.length>0&&(g[0].offer_date||g[0].offerdate)||null,v="Нет"!==m(_.offer_date,A).type,T=await l(t,e,y,n??void 0);let b,R;return b=v&&null!=T?.ytp?100*T.ytp:null!=T?.ytm?100*T.ytm:i.yield&&i.yield>0?i.yield:100*h(y,a.facevalue,a.couponpercent/100,a.couponfrequency||2,p),R=null!=T?.duration_years?T.duration_years:i.duration&&i.duration>0?i.duration/365:w(b/100,a.facevalue,a.couponpercent/100,a.couponfrequency||2,p),{isin:a.isin||t,name:a.shortname||a.name||t,duration:R,yield:b,has_offer:v}}catch{return null}}function E(t){return`${String(t.getDate()).padStart(2,"0")}.${String(t.getMonth()+1).padStart(2,"0")}.${t.getFullYear()}`}export{S as a,D as b,R as f};
