import{d as e,r as a,v as l,o as t,b as s,G as o,c as n,e as i,f as r,x as c,L as d,F as u,i as v,t as p,y as m,j as h,n as g,M as f,k as b,N as y,q as w,O as x,g as k,C,P,w as z,T as M,h as D,B as T}from"./vendor-DLyKmMu8.js";import{u as S}from"./useIsMobile-grjU_tOe.js";import{_ as F}from"./index-AoYxWDki.js";import{usePortfolioStore as N,defaultBank as E}from"./portfolio-t34lcnLk.js";import{g as _}from"./apiHeaders-DCeXWvJ_.js";const B={class:"correlation-scatter-3d"},R={class:"main-layout"},L={class:"controls-column"},I={class:"control-panel"},H={class:"controls-two-column"},A={class:"controls-col-1"},V={class:"control-group"},G=["value"],U={class:"control-group"},$=["value"],O={class:"control-group"},q=["value"],Q={class:"control-group full-width"},j=["max"],Y={class:"controls-col-2"},W={class:"control-group"},Z={class:"toggle-buttons"},K={class:"control-group"},J={class:"toggle-buttons"},X={class:"controls-row regime-row"},ee=["value"],ae={class:"control-group"},le={class:"dropdown-controls"},te={width:"12",height:"12",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},se=["d"],oe={class:"dropdown-content"},ne={class:"checkbox-item"},ie={class:"checkbox-item"},re={class:"checkbox-item"},ce={class:"checkbox-item"},de={class:"checkbox-item"},ue={class:"checkbox-item"},ve={key:0,class:"controls-row playback-controls"},pe={class:"speed-label"},me={class:"stats-panel"},he={class:"stats-section"},ge={class:"correlation-stats"},fe={class:"stat-item"},be={class:"stat-label-large"},ye={class:"stat-value-large"},we={class:"stat-item"},xe={class:"stat-label-large"},ke={class:"stat-value-large"},Ce={class:"stat-item"},Pe={class:"stat-label-large"},ze={class:"stat-value-large"},Me={class:"stats-section"},De={class:"stats-grid-compact"},Te={class:"stat-label-large"},Se={class:"stat-details-large"},Fe={class:"plot-column"},Ne={key:0,class:"loading-overlay"},Ee=F(e({__name:"CorrelationScatter3D",props:{availableAssets:{}},setup(e){const x=e,k=a(null),C=a(!0),P=a(null),{isMobile:z}=S(),M=a(x.availableAssets||["SPY","TLT","GLD","QQQ","BTC"]),D=a([M.value[0],M.value[1],M.value[2]]),T=a(z.value?"2d":"3d"),F=a("correlation"),N=a(0),E=a(["",""]),_=a(["low","medium","high"]),Ee=a(!1),_e=a(!1),Be=a(!1),Re=a(!1),Le=a(!1),Ie=a(!0),He=a(!1),Ae=a(!1),Ve=a(0),Ge=a(1);let Ue=null;const $e=a([]),Oe=l(()=>$e.value.filter((e,a)=>!(a<N.value)&&_.value.includes(e.regime))),qe=[{id:"low",name:"Low",color:"#10b981"},{id:"medium",name:"Medium",color:"#fbbf24"},{id:"high",name:"High",color:"#ef4444"}],Qe=a([{mean:0,std:0,min:0,max:0},{mean:0,std:0,min:0,max:0},{mean:0,std:0,min:0,max:0}]),je=a([[1,0,0],[0,1,0],[0,0,1]]),Ye=a([]),We=a([]),Ze=async()=>{if(console.log("CorrelationScatter3D: updatePlot called",{hasPlotly:!!P.value,hasContainer:!!k.value,dataLength:Oe.value.length}),!P.value)return void console.error("CorrelationScatter3D: Plotly not loaded");if(!k.value)return void console.error("CorrelationScatter3D: Container not found");const e=Oe.value;if(0===e.length)return void console.warn("CorrelationScatter3D: No data to plot");console.log("CorrelationScatter3D: Plotting",e.length,"data points"),"pca"===F.value&&(e=>{if(0===e.length)return;const a=D.value[0],l=D.value[1],t=D.value[2],s=e.map(e=>e.returns[a]||0),o=e.map(e=>e.returns[l]||0),n=e.map(e=>e.returns[t]||0),i=e.length,r=s.reduce((e,a)=>e+a,0)/i,c=o.reduce((e,a)=>e+a,0)/i,d=n.reduce((e,a)=>e+a,0)/i,u=s.reduce((e,a)=>e+(a-r)**2,0)/i,v=o.reduce((e,a)=>e+(a-c)**2,0)/i;n.reduce((e,a)=>e+(a-d)**2,0);const p=s.reduce((e,a,l)=>e+(a-r)*(o[l]-c),0)/i;s.reduce((e,a,l)=>e+(a-r)*(n[l]-d),0),o.reduce((e,a,l)=>e+(a-c)*(n[l]-d),0);const m=[[u,p],[p,v]],h=m[0][0]+m[1][1],g=h**2-4*(m[0][0]*m[1][1]-m[0][1]**2);if(g<0)return;const f=(h+Math.sqrt(g))/2,b=(h-Math.sqrt(g))/2,y=[m[0][1],f-m[0][0]],w=Math.sqrt(y[0]**2+y[1]**2);w>0&&(y[0]/=w,y[1]/=w);const x=[m[0][1],b-m[0][0]],k=Math.sqrt(x[0]**2+x[1]**2);k>0&&(x[0]/=k,x[1]/=k),Ye.value=e.map((e,a)=>{const l=s[a]-r,t=o[a]-c,i=n[a]-d;return[l*y[0]+t*y[1],l*x[0]+t*x[1],i]})})(e),Re.value&&((e,a=3)=>{const l=D.value[0],t=D.value[1],s=D.value[2],o=e.map(e=>[e.returns[l]||0,e.returns[t]||0,e.returns[s]||0]);if(0===o.length)return;let n=[];for(let c=0;c<a;c++){const e=Math.floor(Math.random()*o.length);n.push([...o[e]])}let i=[],r=0;for(;r<100;){i=o.map(e=>{let a=1/0,l=0;return n.forEach((t,s)=>{const o=Math.sqrt((e[0]-t[0])**2+(e[1]-t[1])**2+(e[2]-t[2])**2);o<a&&(a=o,l=s)}),l});const e=Array(a).fill(null).map(()=>[0,0,0]),l=Array(a).fill(0);o.forEach((a,t)=>{const s=i[t];e[s][0]+=a[0],e[s][1]+=a[1],e[s][2]+=a[2],l[s]++});let t=!0;if(e.forEach((e,a)=>{if(l[a]>0){e[0]/=l[a],e[1]/=l[a],e[2]/=l[a];const s=n[a];Math.sqrt((e[0]-s[0])**2+(e[1]-s[1])**2+(e[2]-s[2])**2)>.001&&(t=!1)}}),t)break;n=e,r++}We.value=i})(e,3),(()=>{const e=D.value[0],a=D.value[1],l=D.value[2],t=Oe.value.map(a=>100*(a.returns[e]||0)),s=Oe.value.map(e=>100*(e.returns[a]||0)),o=Oe.value.map(e=>100*(e.returns[l]||0)),n=e=>{if(0===e.length)return{mean:0,std:0,min:0,max:0};const a=e.reduce((e,a)=>e+a,0)/e.length,l=e.reduce((e,l)=>e+(l-a)**2,0)/e.length,t=Math.sqrt(l);return{mean:a,std:t,min:Math.min(...e),max:Math.max(...e)}};Qe.value=[n(t),n(s),n(o)];const i=Oe.value.length;if(i>1){const t=Qe.value[0].mean/100,s=Qe.value[1].mean/100,o=Qe.value[2].mean/100,n=Qe.value[0].std/100,r=Qe.value[1].std/100,c=Qe.value[2].std/100,d=Oe.value.reduce((l,o)=>l+((o.returns[e]||0)-t)*((o.returns[a]||0)-s),0)/(i*n*r),u=Oe.value.reduce((a,s)=>a+((s.returns[e]||0)-t)*((s.returns[l]||0)-o),0)/(i*n*c),v=Oe.value.reduce((e,t)=>e+((t.returns[a]||0)-s)*((t.returns[l]||0)-o),0)/(i*r*c);je.value=[[1,d,u],[d,1,v],[u,v,1]]}})();const a=D.value[0],l=D.value[1],t=D.value[2];let s,o,n;"pca"===F.value&&Ye.value.length>0?(s=Ye.value.map(e=>100*e[0]),o=Ye.value.map(e=>100*e[1]),n=Ye.value.map(e=>100*e[2])):(s=e.map(e=>100*(e.returns[a]||0)),o=e.map(e=>100*(e.returns[l]||0)),n=e.map(e=>100*(e.returns[t]||0)));const i=e.map(e=>{const a=qe.find(a=>a.id===e.regime);return a?a.color:"#888"}),r=e.map(e=>Math.sqrt(e.volume/1e4)),c=e.map((e,i)=>`${e.date}<br>${a}: ${s[i].toFixed(2)}%<br>${l}: ${o[i].toFixed(2)}%<br>${t}: ${n[i].toFixed(2)}%<br>Режим: ${qe.find(a=>a.id===e.regime)?.name||e.regime}`),d=[],u=Qe.value[0],v=Qe.value[1],p=Qe.value[2];e.forEach((e,a)=>{const l=Math.abs(s[a]-u.mean)>3*u.std||Math.abs(o[a]-v.mean)>3*v.std||Math.abs(n[a]-p.mean)>3*p.std;d.push(l)});const m=[];if(qe.forEach(a=>{if(!_.value.includes(a.id))return;const l=e.map((e,a)=>({d:e,i:a})).filter(({d:e})=>e.regime===a.id).map(({i:e})=>e);if(0===l.length)return;l.map(e=>s[e]),l.map(e=>o[e]),l.map(e=>n[e]),l.map(e=>i[e]),l.map(e=>r[e]),l.map(e=>c[e]);const t=l.map(e=>d[e]),u=l.filter((e,a)=>!t[a]||!Ie.value);if(u.length>0&&m.push({x:u.map(e=>s[e]),y:u.map(e=>o[e]),z:"3d"===T.value?u.map(e=>n[e]):void 0,mode:Ee.value?"lines+markers":"markers",type:"3d"===T.value?"scatter3d":"scatter",name:a.name,marker:{color:a.color,size:u.map(e=>r[e]),sizeref:.1,sizemode:"diameter",opacity:.7,line:{color:"rgba(0,0,0,0.2)",width:1}},line:Ee.value?{color:a.color,width:1,opacity:.3}:void 0,text:u.map(e=>c[e]),hovertemplate:"<b>%{text}</b><extra></extra>",showlegend:!1}),Ie.value){const e=l.filter((e,a)=>t[a]);e.length>0&&m.push({x:e.map(e=>s[e]),y:e.map(e=>o[e]),z:"3d"===T.value?e.map(e=>n[e]):void 0,mode:"markers",type:"3d"===T.value?"scatter3d":"scatter",name:`${a.name} (Outliers)`,marker:{color:"#ff00ff",size:12,symbol:"x",opacity:.9,line:{color:"#fff",width:2}},text:e.map(e=>c[e]),hovertemplate:"<b>%{text}</b><br><b>OUTLIER</b><extra></extra>",showlegend:!1})}}),Ee.value&&e.length>1&&m.push({x:s,y:o,z:"3d"===T.value?n:void 0,mode:"lines",type:"3d"===T.value?"scatter3d":"scatter",name:"Траектория",line:{color:"rgba(255,255,255,0.2)",width:2},showlegend:!1,hoverinfo:"skip"}),_e.value&&qe.forEach(s=>{if(!_.value.includes(s.id))return;const o=e.filter(e=>e.regime===s.id);if(o.length<3)return;const n=o.map(e=>100*(e.returns[a]||0)),i=o.map(e=>100*(e.returns[l]||0)),r=o.map(e=>100*(e.returns[t]||0)),c=n.reduce((e,a)=>e+a,0)/n.length,d=i.reduce((e,a)=>e+a,0)/i.length,u=r.reduce((e,a)=>e+a,0)/r.length,v=Math.sqrt(n.reduce((e,a)=>e+(a-c)**2,0)/n.length),p=Math.sqrt(i.reduce((e,a)=>e+(a-d)**2,0)/i.length);if(Math.sqrt(r.reduce((e,a)=>e+(a-u)**2,0)/r.length),"2d"===T.value){const e=Array.from({length:50},(e,a)=>a/50*2*Math.PI),a=e.map(e=>c+2*v*Math.cos(e)),l=e.map(e=>d+2*p*Math.sin(e));m.push({x:a,y:l,mode:"lines",type:"scatter",name:`${s.name} Ellipse`,line:{color:s.color,width:1,dash:"dash"},showlegend:!1,hoverinfo:"skip"})}}),Be.value&&"2d"===T.value){const e=s.length,a=s.reduce((e,a)=>e+a,0),l=o.reduce((e,a)=>e+a,0),t=(e*s.reduce((e,a,l)=>e+a*o[l],0)-a*l)/(e*s.reduce((e,a)=>e+a*a,0)-a*a),n=(l-t*a)/e,i=[Math.min(...s),Math.max(...s)],r=i.map(e=>t*e+n);m.push({x:i,y:r,mode:"lines",type:"scatter",name:"Регрессия",line:{color:"rgba(96, 165, 250, 0.5)",width:2,dash:"dot"},showlegend:!1,hoverinfo:"skip"})}Le.value&&qe.forEach(s=>{if(!_.value.includes(s.id))return;const o=e.filter(e=>e.regime===s.id);if(0===o.length)return;const n=o.reduce((e,l)=>e+100*(l.returns[a]||0),0)/o.length,i=o.reduce((e,a)=>e+100*(a.returns[l]||0),0)/o.length,r=o.reduce((e,a)=>e+100*(a.returns[t]||0),0)/o.length;m.push({x:[n],y:[i],z:"3d"===T.value?[r]:void 0,mode:"markers",type:"3d"===T.value?"scatter3d":"scatter",name:`${s.name} Центроид`,marker:{color:s.color,size:20,symbol:"diamond",line:{color:"#fff",width:2}},showlegend:!1,hoverinfo:"skip"})});const h={paper_bgcolor:"transparent",plot_bgcolor:"transparent",font:{color:"#fff",family:"system-ui"},margin:{l:50,r:20,t:20,b:40},showlegend:!1,autosize:!0,height:void 0};"3d"===T.value?h.scene={xaxis:{title:`${a} Доходность (%)`,backgroundcolor:"rgba(0,0,0,0)",gridcolor:"rgba(255,255,255,0.15)",showbackground:!0,titlefont:{color:"rgba(255,255,255,0.9)",size:12},tickfont:{size:10,color:"rgba(255,255,255,0.6)"}},yaxis:{title:`${l} Доходность (%)`,backgroundcolor:"rgba(0,0,0,0)",gridcolor:"rgba(255,255,255,0.15)",showbackground:!0,titlefont:{color:"rgba(255,255,255,0.9)",size:12},tickfont:{size:10,color:"rgba(255,255,255,0.6)"}},zaxis:{title:`${t} Доходность (%)`,backgroundcolor:"rgba(0,0,0,0)",gridcolor:"rgba(255,255,255,0.15)",showbackground:!0,titlefont:{color:"rgba(255,255,255,0.9)",size:12},tickfont:{size:10,color:"rgba(255,255,255,0.6)"}},bgcolor:"rgba(0,0,0,0)",camera:{eye:{x:1.6,y:1.6,z:1.2},center:{x:0,y:0,z:0},up:{x:0,y:0,z:1}},aspectratio:{x:1,y:1,z:1},aspectmode:"cube"}:(h.xaxis={title:`${a} Доходность (%)`,gridcolor:"rgba(255,255,255,0.1)",titlefont:{color:"rgba(255,255,255,0.9)",size:12},tickfont:{size:10,color:"rgba(255,255,255,0.6)"}},h.yaxis={title:`${l} Доходность (%)`,gridcolor:"rgba(255,255,255,0.1)",titlefont:{color:"rgba(255,255,255,0.9)",size:12},tickfont:{size:10,color:"rgba(255,255,255,0.6)"}});const g={responsive:!0,displayModeBar:!0,displaylogo:!1,modeBarButtonsToRemove:["lasso2d","select2d"],modeBarButtonsToAdd:[],toImageButtonOptions:{format:"png",filename:"correlation_scatter",height:800,width:1200,scale:2}};if(P.value&&k.value){if(console.log("CorrelationScatter3D: Creating plot with",m.length,"traces"),console.log("CorrelationScatter3D: Container dimensions:",k.value.clientWidth,k.value.clientHeight),0===k.value.clientWidth||0===k.value.clientHeight){if(console.warn("CorrelationScatter3D: Container has zero dimensions, waiting for layout..."),await new Promise(e=>requestAnimationFrame(e)),0===k.value.clientWidth||0===k.value.clientHeight)return void console.error("CorrelationScatter3D: Container still has zero dimensions after wait");console.log("CorrelationScatter3D: Container dimensions after wait:",k.value.clientWidth,k.value.clientHeight)}try{await P.value.newPlot(k.value,m,h,g),console.log("CorrelationScatter3D: Plot created successfully"),P.value.Plots&&k.value&&P.value.Plots.resize(k.value)}catch(f){console.error("CorrelationScatter3D: Error creating plot:",f)}}else console.error("CorrelationScatter3D: Cannot create plot - missing Plotly or container")},Ke=()=>{const e=$e.value;if(0===e.length)return;const a=N.value;E.value=[e[a]?.date||"",e[e.length-1]?.date||""],Ze()},Je=()=>{if(Ae.value=!Ae.value,Ae.value){const e=()=>{if(Ae.value){if(Ve.value+=Ge.value,Ve.value>=100)return Ve.value=100,void(Ae.value=!1);N.value=Math.floor(Ve.value/100*($e.value.length-1)),Ke(),Ae.value&&(Ue=window.setTimeout(e,100))}};e()}else Ue&&(clearTimeout(Ue),Ue=null)},Xe=()=>{N.value=Math.floor(Ve.value/100*($e.value.length-1)),Ke()},ea=()=>{P.value&&k.value&&(N.value=0,Ve.value=0,Ae.value=!1,Ue&&(clearTimeout(Ue),Ue=null),Ke(),P.value.relayout(k.value,{"scene.camera.eye":{x:1.6,y:1.6,z:1.2},"scene.camera.center":{x:0,y:0,z:0}}))};return t(async()=>{C.value=!0,console.log("CorrelationScatter3D: Initializing...");try{const e=await(async()=>{if("undefined"==typeof window)return console.error("Window is undefined"),null;if(window.Plotly)return P.value=window.Plotly,console.log("Plotly already loaded in CorrelationScatter3D"),P.value;if(document.querySelector('script[src*="plotly"]'))return new Promise(e=>{const a=setInterval(()=>{window.Plotly&&(clearInterval(a),P.value=window.Plotly,console.log("Plotly loaded from existing script in CorrelationScatter3D"),e(P.value))},100);setTimeout(()=>{clearInterval(a),console.error("Plotly script timeout in CorrelationScatter3D"),e(null)},1e4)});const e=document.createElement("script");return e.src="https://cdn.plot.ly/plotly-latest.min.js",e.async=!0,e.crossOrigin="anonymous",new Promise((a,l)=>{e.onload=()=>{window.Plotly?(P.value=window.Plotly,console.log("Plotly loaded successfully in CorrelationScatter3D"),a(P.value)):(console.error("Plotly not found after script load in CorrelationScatter3D"),l(new Error("Plotly not found")))},e.onerror=e=>{console.error("Failed to load Plotly script in CorrelationScatter3D:",e),l(e)},document.head.appendChild(e)})})();if(!e)return console.error("CorrelationScatter3D: Plotly not loaded"),void(C.value=!1);P.value=e,console.log("CorrelationScatter3D: Plotly loaded successfully"),$e.value=(()=>{const e=[],a=new Date("2024-01-01"),l={SPY:{TLT:-.35,GLD:.15,QQQ:.92,BTC:.45},TLT:{SPY:-.35,GLD:.25,QQQ:-.42,BTC:-.15},GLD:{SPY:.15,TLT:.25,QQQ:.1,BTC:.2},QQQ:{SPY:.92,TLT:-.42,GLD:.1,BTC:.55},BTC:{SPY:.45,TLT:-.15,GLD:.2,QQQ:.55}},t={low:{vol:.008,trend:.001},medium:{vol:.015,trend:5e-4},high:{vol:.03,trend:-.001}};let s="low",o=0,n=30+60*Math.random();const i={};M.value.forEach(e=>{i[e]=[]});for(let r=0;r<252;r++){if(o++,o>n){const e=Math.random();s="low"===s?e>.7?"high":"medium":"medium"===s?e>.6?"high":"low":e>.7?"low":"medium",o=0,n=30+60*Math.random()}const c=t[s],d={},u=M.value[0],v=(Math.random()-.5)*c.vol*2+c.trend;i[u].push(v),d[u]=v;for(let e=1;e<M.value.length;e++){const a=M.value[e],t=M.value[e-1],s=l[t]?.[a]||0,o=(Math.random()-.5)*c.vol*2,n=s*i[t][r]+Math.sqrt(1-s*s)*o+c.trend;i[a].push(n),d[a]=n}const p=new Date(a);p.setDate(p.getDate()+r),e.push({date:p.toISOString().split("T")[0],returns:d,regime:s,volume:1e6*Math.random()+1e5,index:r})}return e})(),console.log("CorrelationScatter3D: Generated",$e.value.length,"data points"),$e.value.length>0&&(N.value=0,E.value=[$e.value[0].date,$e.value[$e.value.length-1].date]),await new Promise(e=>setTimeout(e,100)),await Ze(),console.log("CorrelationScatter3D: Initial plot created"),C.value=!1}catch(l){console.error("CorrelationScatter3D: Error during initialization:",l),C.value=!1}let e=null;const a=()=>{e&&clearTimeout(e),e=window.setTimeout(()=>{P.value&&k.value&&P.value.Plots.resize(k.value)},250)};window.addEventListener("resize",a),setTimeout(()=>{P.value&&k.value&&P.value.Plots.resize(k.value)},500),s(()=>{window.removeEventListener("resize",a),e&&clearTimeout(e),Ue&&clearTimeout(Ue)})}),o(()=>D.value,()=>{Ze()},{deep:!0}),(e,a)=>(w(),n("div",B,[i("div",R,[i("div",L,[i("div",I,[i("div",H,[i("div",A,[i("div",V,[a[18]||(a[18]=i("label",null,"Актив 1 (X):",-1)),c(i("select",{"onUpdate:modelValue":a[0]||(a[0]=e=>D.value[0]=e),onChange:Ze},[(w(!0),n(u,null,v(M.value,e=>(w(),n("option",{key:e,value:e},p(e),9,G))),128))],544),[[d,D.value[0]]])]),i("div",U,[a[19]||(a[19]=i("label",null,"Актив 2 (Y):",-1)),c(i("select",{"onUpdate:modelValue":a[1]||(a[1]=e=>D.value[1]=e),onChange:Ze},[(w(!0),n(u,null,v(M.value,e=>(w(),n("option",{key:e,value:e},p(e),9,$))),128))],544),[[d,D.value[1]]])]),i("div",O,[a[20]||(a[20]=i("label",null,"Актив 3 (Z):",-1)),c(i("select",{"onUpdate:modelValue":a[2]||(a[2]=e=>D.value[2]=e),onChange:Ze},[(w(!0),n(u,null,v(M.value,e=>(w(),n("option",{key:e,value:e},p(e),9,q))),128))],544),[[d,D.value[2]]])]),i("div",Q,[i("label",null,"Период: "+p(E.value[0])+" - "+p(E.value[1]),1),c(i("input",{type:"range",min:0,max:Oe.value.length-1,"onUpdate:modelValue":a[3]||(a[3]=e=>N.value=e),onInput:Ke,class:"time-slider full-width-slider"},null,40,j),[[m,N.value]])]),i("button",{class:"btn-reset full-width",onClick:ea},[...a[21]||(a[21]=[i("svg",{width:"14",height:"14",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[i("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"})],-1),h(" Сброс ",-1)])])]),i("div",Y,[i("div",W,[a[22]||(a[22]=i("label",null,"Режим:",-1)),i("div",Z,[i("button",{class:g(["toggle-btn",{active:"3d"===T.value}]),onClick:a[4]||(a[4]=e=>{T.value="3d",Ze()})}," 3D ",2),i("button",{class:g(["toggle-btn",{active:"2d"===T.value}]),onClick:a[5]||(a[5]=e=>{T.value="2d",Ze()})}," 2D ",2)])]),i("div",K,[a[23]||(a[23]=i("label",null,"Пространство:",-1)),i("div",J,[i("button",{class:g(["toggle-btn",{active:"correlation"===F.value}]),onClick:a[6]||(a[6]=e=>{F.value="correlation",Ze()})}," Correlation ",2),i("button",{class:g(["toggle-btn",{active:"pca"===F.value}]),onClick:a[7]||(a[7]=e=>{F.value="pca",Ze()})}," PCA ",2)])])])]),i("div",X,[a[24]||(a[24]=i("label",{class:"regime-filter-label"},"Режимы:",-1)),(w(),n(u,null,v(qe,e=>i("label",{class:"regime-checkbox",key:e.id},[c(i("input",{type:"checkbox",value:e.id,"onUpdate:modelValue":a[8]||(a[8]=e=>_.value=e),onChange:Ze},null,40,ee),[[f,_.value]]),i("span",{class:"regime-dot",style:b({backgroundColor:e.color})},null,4),h(" "+p(e.name),1)])),64))]),i("div",ae,[i("div",le,[i("button",{class:"dropdown-toggle",onClick:a[9]||(a[9]=e=>He.value=!He.value)},[a[25]||(a[25]=i("span",null,"Дополнительные настройки",-1)),(w(),n("svg",te,[i("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:He.value?"M5 15l7-7 7 7":"M19 9l-7 7-7-7"},null,8,se)]))]),c(i("div",oe,[i("label",ne,[c(i("input",{type:"checkbox","onUpdate:modelValue":a[10]||(a[10]=e=>Ee.value=e),onChange:Ze},null,544),[[f,Ee.value]]),a[26]||(a[26]=i("span",null,"Траектория",-1))]),i("label",ie,[c(i("input",{type:"checkbox","onUpdate:modelValue":a[11]||(a[11]=e=>Be.value=e),onChange:Ze},null,544),[[f,Be.value]]),a[27]||(a[27]=i("span",null,"Регрессии",-1))]),i("label",re,[c(i("input",{type:"checkbox","onUpdate:modelValue":a[12]||(a[12]=e=>Ie.value=e),onChange:Ze},null,544),[[f,Ie.value]]),a[28]||(a[28]=i("span",null,"Outliers",-1))]),i("label",ce,[c(i("input",{type:"checkbox","onUpdate:modelValue":a[13]||(a[13]=e=>_e.value=e),onChange:Ze},null,544),[[f,_e.value]]),a[29]||(a[29]=i("span",null,"Эллипсоиды",-1))]),i("label",de,[c(i("input",{type:"checkbox","onUpdate:modelValue":a[14]||(a[14]=e=>Re.value=e),onChange:Ze},null,544),[[f,Re.value]]),a[30]||(a[30]=i("span",null,"Кластеры",-1))]),i("label",ue,[c(i("input",{type:"checkbox","onUpdate:modelValue":a[15]||(a[15]=e=>Le.value=e),onChange:Ze},null,544),[[f,Le.value]]),a[31]||(a[31]=i("span",null,"Центроиды",-1))])],512),[[y,He.value]])])]),Ee.value?(w(),n("div",ve,[i("button",{class:g(["btn-playback",{active:Ae.value}]),onClick:Je},p(Ae.value?"⏸":"▶"),3),c(i("input",{type:"range",min:0,max:100,"onUpdate:modelValue":a[16]||(a[16]=e=>Ve.value=e),onInput:Xe,class:"playback-slider"},null,544),[[m,Ve.value]]),c(i("input",{type:"range",min:1,max:10,"onUpdate:modelValue":a[17]||(a[17]=e=>Ge.value=e),class:"speed-slider",title:"Speed"},null,512),[[m,Ge.value]]),i("span",pe,p(Ge.value)+"x",1)])):r("",!0)]),i("div",me,[i("div",he,[a[32]||(a[32]=i("h4",null,"Корреляции",-1)),i("div",ge,[i("div",fe,[i("span",be,p(D.value[0])+" ↔ "+p(D.value[1]),1),i("span",ye,p(je.value[0][1].toFixed(3)),1)]),i("div",we,[i("span",xe,p(D.value[0])+" ↔ "+p(D.value[2]),1),i("span",ke,p(je.value[0][2].toFixed(3)),1)]),i("div",Ce,[i("span",Pe,p(D.value[1])+" ↔ "+p(D.value[2]),1),i("span",ze,p(je.value[1][2].toFixed(3)),1)])])]),i("div",Me,[a[33]||(a[33]=i("h4",null,"Статистика",-1)),i("div",De,[(w(!0),n(u,null,v(Qe.value,(e,a)=>(w(),n("div",{class:"stat-item-compact",key:a},[i("span",Te,p(D.value[a]),1),i("div",Se,[i("span",null,"μ: "+p(e.mean.toFixed(2))+"%",1),i("span",null,"σ: "+p(e.std.toFixed(2))+"%",1)])]))),128))])])])]),i("div",Fe,[C.value?(w(),n("div",Ne,[...a[34]||(a[34]=[i("div",{class:"spinner-large"},null,-1),i("p",null,"Загрузка данных...",-1)])])):r("",!0),i("div",{ref_key:"plotContainer",ref:k,class:"plot-container"},null,512)])])]))}}),[["__scopeId","data-v-ef488a4f"]]),_e={class:"portfolio-page"},Be={class:"hero-section"},Re={class:"hero-left"},Le={class:"hero-title-row"},Ie={class:"bank-selector-inline-wrapper"},He={class:"bank-selector-wrapper"},Ae={class:"bank-selector-content"},Ve={class:"bank-selector-name"},Ge={class:"bank-selector-reg"},Ue={key:0,class:"bank-dropdown"},$e={class:"bank-dropdown-search"},Oe={class:"bank-dropdown-list"},qe=["onClick"],Qe={class:"bank-item-content"},je={class:"bank-item-name"},Ye={class:"bank-item-reg"},We={key:0,width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"3"},Ze={class:"hero-actions"},Ke={class:"last-update"},Je={class:"mono"},Xe={class:"kpi-grid"},ea={class:"glass-card kpi-card glow-green"},aa={class:"kpi-header"},la={width:"10",height:"10",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"4"},ta={key:0,d:"M18 15l-6-6-6 6"},sa={key:1,d:"M6 9l6 6 6-6"},oa={class:"kpi-content"},na={class:"kpi-value text-gradient-green"},ia={class:"kpi-sub"},ra={class:"glass-card kpi-card"},ca={class:"kpi-header"},da={class:"trend-badge negative"},ua={class:"kpi-content"},va={class:"kpi-value text-white"},pa={class:"glass-card kpi-card glow-blue"},ma={class:"kpi-content"},ha={class:"kpi-value text-gradient-blue"},ga={class:"kpi-sub"},fa={class:"glass-card kpi-card"},ba={class:"kpi-content"},ya={class:"kpi-value text-white"},wa={class:"kpi-sub"},xa={class:"dashboard-grid"},ka={class:"col-main"},Ca={class:"glass-panel"},Pa={class:"panel-body p-0"},za={class:"table-container"},Ma={class:"glass-table"},Da=["onClick"],Ta={class:"asset-cell"},Sa={class:"asset-info"},Fa={class:"symbol"},Na={class:"name"},Ea={class:"text-right mono"},_a={class:"text-right mono"},Ba={class:"text-right mono opacity-80"},Ra={class:"text-right mono font-bold"},La={class:"text-right mono opacity-50"},Ia={class:"text-right"},Ha={class:"glass-panel"},Aa={class:"panel-body heatmap-body"},Va={class:"heatmap-wrapper"},Ga={class:"heatmap-header-row"},Ua={class:"heatmap-rh"},$a={class:"glass-panel heatmap-panel",style:{"margin-bottom":"0"}},Oa={class:"panel-body",style:{padding:"8px 10px 0 10px",position:"relative","margin-bottom":"0"}},qa={key:0,class:"asset-tooltip-3d"},Qa={class:"tooltip-header"},ja={class:"tooltip-symbol"},Ya={class:"tooltip-name"},Wa={class:"tooltip-details"},Za={class:"tooltip-row"},Ka={key:0,class:"tooltip-row"},Ja={key:1,class:"tooltip-row"},Xa={class:"tooltip-row"},el={class:"tooltip-row"},al={class:"tooltip-row"},ll={key:2,class:"tooltip-row"},tl={class:"col-side-flex"},sl={key:0,class:"glass-panel inspector-card"},ol={class:"panel-header"},nl={class:"inspector-header-top"},il={class:"inspector-title"},rl={class:"badge-glass"},cl={class:"panel-body"},dl={class:"mini-chart-container"},ul={class:"chart-bars"},vl={class:"glass-panel optimizer-link-card"},pl={class:"optimizer-link-content"},ml={class:"glass-panel combined-metrics metrics-panel"},hl={class:"metrics-section"},gl={class:"metric-row"},fl={class:"metric-value text-red"},bl={class:"metric-row"},yl={class:"metric-value text-green"},wl={class:"metric-row"},xl={class:"metric-value text-green"},kl={class:"metric-row"},Cl={class:"metric-value text-white"},Pl={class:"metric-row"},zl={class:"metric-row"},Ml={class:"metric-value text-red"},Dl={class:"glass-panel scatter-3d-panel"},Tl={class:"panel-body scatter-3d-body"},Sl={class:"modal-body"},Fl={class:"modal-search"},Nl={class:"modal-table-container"},El={class:"glass-table modal-table"},_l=["onClick"],Bl={class:"asset-cell"},Rl={class:"asset-info"},Ll={class:"symbol"},Il={class:"name"},Hl={class:"text-right mono"},Al={class:"text-right mono"},Vl={class:"text-right mono opacity-80"},Gl={class:"text-right mono font-bold"},Ul={class:"text-right mono opacity-50"},$l={class:"text-right"},Ol={class:"modal-footer"},ql={class:"modal-stats"},Ql=F(e({__name:"Portfolio",setup(e){const d=new Set,f=new Set,y=(e,a)=>{const l=setTimeout(()=>{d.delete(l),e()},a);return d.add(l),l};let S=null;const F=async()=>{if("undefined"==typeof window)return console.error("Window is undefined"),null;if(window.Plotly)return S=window.Plotly,console.log("Plotly already loaded"),S;if(document.querySelector('script[src*="plotly"]'))return new Promise(e=>{const a=((e,a)=>{const l=setInterval(e,a);return f.add(l),l})(()=>{window.Plotly&&(clearInterval(a),f.delete(a),S=window.Plotly,console.log("Plotly loaded from existing script"),e(S))},100);y(()=>{clearInterval(a),f.delete(a),console.error("Plotly script timeout"),e(null)},1e4)});const e=document.createElement("script");return e.src="https://cdn.plot.ly/plotly-latest.min.js",e.async=!0,e.crossOrigin="anonymous",new Promise((a,l)=>{e.onload=()=>{window.Plotly?(S=window.Plotly,console.log("Plotly loaded successfully"),a(S)):(console.error("Plotly not found after script load"),l(new Error("Plotly not found")))},e.onerror=e=>{console.error("Failed to load Plotly script:",e),l(e)},document.head.appendChild(e)})};a({currentRegime:"TRENDING",positionSize:100,lambda:5,jaggedness:.42,pctChoppy:32,volRatio:1.5,history:["TRENDING","TRENDING","CHOPPY","TRENDING","TRENDING","TRENDING","CHOPPY","CHOPPY","CHOPPY","TRENDING","TRENDING","TRENDING","TRENDING","TRENDING","CHOPPY","CHOPPY","TRENDING","TRENDING","TRENDING","TRENDING"]}),a({isActive:!1,severity:"normal",title:"Предварительный сигнал тревоги",message:"Пик волатильности сдвинулся. Рекомендуется снизить long-позиции на 50%"}),a({currentZscore:.12,precision:42,recall:35,recentAlerts:3,truePositives:2,alertHistory:[{date:"2026-01-06",zscore:.12,outcome:!1},{date:"2026-01-05",zscore:-.45,outcome:!1},{date:"2026-01-04",zscore:2.12,outcome:!0},{date:"2026-01-03",zscore:1.85,outcome:!0},{date:"2026-01-02",zscore:-.32,outcome:!1}]});const B=N(),R=a((new Date).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}));a(!1);const L=a(""),I=a({show:!1,message:"",type:"success"}),H=a(null),A=a(!1),{selectedBank:V,positions:G,banks:U}=x(B),$=a(!1),O=a(""),q=a(null),Q=a(null),j=async()=>{if(G.value&&0!==G.value.length){A.value=!0;try{const e=G.value.map(e=>({symbol:e.symbol,name:e.name,price:parseFloat(e.price)||0,dayChange:e.dayChange||0,notional:e.notional||0,allocation:e.allocation||0,targetAllocation:e.targetAllocation||0,color:e.color||""})),a=await(async e=>{try{const a=await fetch("   https://stochastic-dashbord-v1-production.up.railway.app/api/portfolio/metrics",{method:"POST",headers:_(),body:JSON.stringify(e)});if(!a.ok){const e=await a.json().catch(()=>({detail:"Unknown error"}));throw new Error(e.detail||`HTTP error! status: ${a.status}`)}return await a.json()}catch(a){throw console.error("Portfolio Metrics Calculation Failed:",a),a}})({positions:e,risk_free_rate:.042,market_return:.1,market_volatility:.15});H.value=a}catch(e){console.error("Failed to load portfolio metrics:",e),H.value=null}finally{A.value=!1}}else H.value=null};o(G,e=>{!(e.length>0)||q.value&&e.find(e=>e.symbol===q.value?.symbol)||(q.value=e[0]),j()},{immediate:!0,deep:!0});const Y=l(()=>{if(!O.value.trim())return U.value;const e=O.value.toLowerCase().trim();return U.value.filter(a=>a.name.toLowerCase().includes(e)||a.regNumber.includes(e))}),W=()=>{$.value=!$.value,$.value&&(O.value="")},Z=e=>{e.target.closest(".bank-selector-wrapper")||($.value=!1)},K=l(()=>[...G.value].sort((e,a)=>a.allocation-e.allocation).slice(0,5));l(()=>{if(!L.value)return G.value;const e=L.value.toLowerCase();return G.value.filter(a=>a.symbol.toLowerCase().includes(e)||a.name.toLowerCase().includes(e))});const J=a(!1),X=a(""),ee=l(()=>{if(!X.value)return G.value;const e=X.value.toLowerCase();return G.value.filter(a=>a.symbol.toLowerCase().includes(e)||a.name.toLowerCase().includes(e))}),ae=()=>{J.value=!0,X.value="","undefined"!=typeof document&&(document.body.style.overflow="hidden")},le=()=>{J.value=!1,"undefined"!=typeof document&&(document.body.style.overflow="")},te=l(()=>{const e=[...G.value];return e.map(a=>{const l=e.map(e=>((e,a)=>{if(e===a)return 1;const l=e.includes("SU")||e.includes("RU000"),t=a.includes("SU")||a.includes("RU000"),s=e=>{let a=0;for(let l=0;l<e.length;l++)a=(a<<5)-a+e.charCodeAt(l),a&=a;return Math.abs(a)};if(l&&t)return.7+s(e+a)%100/100*.2;if(!l&&!t)return e.includes("SBER")&&a.includes("VTBR")||e.includes("VTBR")&&a.includes("SBER")||e.includes("GAZP")&&a.includes("ROSN")||e.includes("ROSN")&&a.includes("GAZP")||e.includes("LKOH")&&a.includes("TATN")||e.includes("TATN")&&a.includes("LKOH")||e.includes("NVTK")&&a.includes("GAZP")||e.includes("GAZP")&&a.includes("NVTK")?.6+s(e+a)%100/100*.3:.3+s(e+a)%100/100*.4;return s(e+a)%100/100*.3-.1})(a.symbol,e.symbol));return{label:a.symbol,values:l}})}),se=l(()=>[...G.value].sort((e,a)=>a.allocation-e.allocation).slice(0,10).map(e=>e.symbol)),oe=async()=>{try{console.log("Initializing 3D Correlation Heatmap...");const a=await F();if(!a)return void console.error("Plotly not loaded");S=a;const l=document.getElementById("correlation-3d-heatmap");if(!l)return void console.error("Container correlation-3d-heatmap not found");if(console.log("Container found, dimensions:",l.clientWidth,l.clientHeight),0===l.clientWidth||0===l.clientHeight){if(console.warn("Container has zero dimensions, waiting for layout..."),await new Promise(e=>requestAnimationFrame(e)),0===l.clientWidth||0===l.clientHeight)return void console.error("Container still has zero dimensions after wait");console.log("Container dimensions after wait:",l.clientWidth,l.clientHeight)}const t=[...G.value];if(0===t.length)return;const s=te.value,o=((e,a)=>e.map(e=>{const l=e.symbol.includes("SU")||e.symbol.includes("RU000"),t=l?"#3b82f6":"#10b981",s=l?3+4*Math.random():15+20*Math.random(),o=a.findIndex(a=>a.label===e.symbol);let n=0;if(-1!==o){const e=a[o].values;n=e.reduce((e,a)=>e+a,0)/e.length}return{x:s,y:n,z:e.allocation,asset:{...e,color:t}}}))(t,s);if(0===o.length)return void console.error("No 3D positions calculated");const n=o.map(e=>e.x),i=o.map(e=>e.y),r=o.map(e=>e.z),c=Math.min(...n),d=Math.max(...n),u=Math.min(...i),v=Math.max(...i),p=Math.min(...r),m=Math.max(...r),h=(e,a,l)=>l===a?5:(e-a)/(l-a)*10,g=o.map(e=>({...e,nx:h(e.x,c,d),ny:h(e.y,u,v),nz:h(e.z,p,m)})),f=(e,a,l,t,s,o)=>{const n=[],i=[],r=[];for(let c=0;c<16;c++){const s=c/15*Math.PI;for(let o=0;o<16;o++){const c=o/15*2*Math.PI;n.push(e+t*Math.sin(s)*Math.cos(c)),i.push(a+t*Math.sin(s)*Math.sin(c)),r.push(l+t*Math.cos(s))}}return{type:"mesh3d",x:n,y:i,z:r,color:s,alphahull:0,opacity:1,flatshading:!1,lighting:{ambient:.6,diffuse:.9,specular:1,roughness:.1,fresnel:.8},lightposition:{x:10,y:10,z:20},hoverinfo:"none",customdata:o,name:o.symbol}},b=[];g.forEach(e=>{const a=e.asset,l=.3+a.allocation/25;b.push(f(e.nx,e.ny,e.nz,l,a.color,a))}),b.push({x:g.map(e=>e.nx),y:g.map(e=>e.ny),z:g.map(e=>e.nz),mode:"markers",type:"scatter3d",marker:{size:g.map(e=>Math.max(40,40*(.3+e.asset.allocation/25))),color:"rgba(255,255,255,0)",opacity:0,line:{width:0}},hoverinfo:"skip",customdata:g.map(e=>e.asset)});const y={showlegend:!1,hovermode:"closest",scene:{xaxis:{title:"РИСК (Волатильность %)",backgroundcolor:"rgba(20, 22, 28, 0.8)",gridcolor:"rgba(255,255,255,0.08)",zeroline:!1,showbackground:!0,titlefont:{color:"#ffffff",size:12,weight:"bold"},tickfont:{size:9,color:"rgba(255,255,255,0.6)"},tickvals:[0,2.5,5,7.5,10],ticktext:[c.toFixed(0)+"%",((c+d)/4*1+3*c/4).toFixed(0)+"%",((c+d)/2).toFixed(0)+"%",((c+d)/4*3+1*d/4).toFixed(0)+"%",d.toFixed(0)+"%"],showspikes:!1},yaxis:{title:"СВЯЗЬ (Корреляция)",backgroundcolor:"rgba(30, 32, 38, 0.6)",gridcolor:"rgba(255,255,255,0.08)",zeroline:!1,showbackground:!0,titlefont:{color:"#ffffff",size:12,weight:"bold"},tickfont:{size:9,color:"rgba(255,255,255,0.6)"},tickvals:[0,2.5,5,7.5,10],ticktext:[u.toFixed(2),((u+v)/4*1+3*u/4).toFixed(2),((u+v)/2).toFixed(2),((u+v)/4*3+1*v/4).toFixed(2),v.toFixed(2)],showspikes:!1},zaxis:{title:"ДОЛЯ (Вес %)",backgroundcolor:"rgba(20, 22, 28, 0.8)",gridcolor:"rgba(255,255,255,0.08)",zeroline:!1,showbackground:!0,titlefont:{color:"#ffffff",size:12,weight:"bold"},tickfont:{size:9,color:"rgba(255,255,255,0.6)"},tickvals:[0,2.5,5,7.5,10],ticktext:[p.toFixed(1)+"%",((p+m)/4*1+3*p/4).toFixed(1)+"%",((p+m)/2).toFixed(1)+"%",((p+m)/4*3+1*m/4).toFixed(1)+"%",m.toFixed(1)+"%"],showspikes:!1},bgcolor:"rgba(0,0,0,0)",camera:{eye:{x:1.8,y:1.8,z:1.2},center:{x:0,y:0,z:0},up:{x:0,y:0,z:1}},aspectmode:"cube"},paper_bgcolor:"transparent",plot_bgcolor:"transparent",font:{color:"#fff",family:"system-ui"},margin:{l:0,r:0,b:0,t:0},autosize:!0},w={responsive:!0,displayModeBar:!1,staticPlot:!1,displaylogo:!1};console.log("Portfolio: Creating 3D plot with",b.length,"traces"),console.log("Portfolio: Container dimensions:",l.clientWidth,l.clientHeight);try{S.newPlot(l,b,y,w),console.log("Portfolio: 3D plot created successfully")}catch(e){return void console.error("Portfolio: Error creating 3D plot:",e)}const x=l;x.on("plotly_hover",e=>{if(e&&e.points&&e.points.length>0)for(const a of e.points){if(a.customdata){const e=Array.isArray(a.customdata)?a.customdata[0]:a.customdata;if(e)return void(Q.value=e)}const e=b.length-1;if(a.curveNumber===e&&void 0!==a.pointNumber){const e=a.pointNumber;if(e>=0&&e<g.length&&g[e])return void(Q.value=g[e].asset)}if(a.curveNumber<e&&a.curveNumber<g.length){const e=a.curveNumber;if(g[e])return void(Q.value=g[e].asset)}}}),x.on("plotly_unhover",()=>{Q.value=null})}catch(a){console.error("Error initializing 3D Correlation Heatmap:",a)}};o([G,V],()=>{G.length>0&&y(()=>{oe()},200)},{deep:!1});const ne=()=>{"undefined"!=typeof window&&y(()=>{document.querySelector(".metrics-panel")},100)};t(async()=>{V.value||B.setSelectedBank(E),G?.value?.length>0&&!q.value&&(q.value=G.value[0]),ne(),y(async()=>{try{await oe(),console.log("3D Correlation Heatmap initialized")}catch(e){console.error("Failed to initialize 3D Correlation Heatmap:",e)}},500),window.addEventListener("resize",ne),document.addEventListener("click",Z)}),s(()=>{window.removeEventListener("resize",ne),document.removeEventListener("click",Z)});const ie=e=>q.value=e,re=()=>{ce("PDF экспорт инициирован...","info"),y(()=>{ce("Файл portfolio_2026-01-06.pdf загружен","success")},1200)},ce=(e,a="success")=>{I.value={show:!0,message:e,type:a},y(()=>{I.value.show=!1},3e3)},de=e=>{const a=Math.abs(e);return 1===e?"rgba(255,255,255,0.05)":e>0?`rgba(59, 130, 246, ${a})`:`rgba(239, 68, 68, ${a})`},ue=e=>Math.abs(e.allocation-e.targetAllocation)<.5?"text-muted":e.allocation-e.targetAllocation>0?"text-green":"text-red";return(e,a)=>{const l=D("router-link");return w(),n("div",_e,[i("div",Be,[i("div",Re,[i("div",Le,[i("h1",null,[a[7]||(a[7]=h("Управление портфелем ценных бумаг банка: ",-1)),i("span",Ie,[i("div",He,[i("div",{class:g(["bank-selector",{"is-open":$.value}]),onClick:W},[i("div",Ae,[i("span",Ve,p(P(V)?.name||"Выберите банк"),1),i("span",Ge,"№ "+p(P(V)?.regNumber||""),1)]),a[4]||(a[4]=i("svg",{class:"bank-selector-chevron",width:"12",height:"8",viewBox:"0 0 12 8",fill:"none",stroke:"currentColor","stroke-width":"2"},[i("path",{d:"M1 1L6 6L11 1"})],-1))],2),k(M,{name:"dropdown-fade"},{default:z(()=>[$.value?(w(),n("div",Ue,[i("div",$e,[a[5]||(a[5]=i("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[i("circle",{cx:"11",cy:"11",r:"8"}),i("line",{x1:"21",y1:"21",x2:"16.65",y2:"16.65"})],-1)),c(i("input",{type:"text","onUpdate:modelValue":a[0]||(a[0]=e=>O.value=e),placeholder:"Поиск банка...",class:"bank-search-input",onClick:a[1]||(a[1]=T(()=>{},["stop"]))},null,512),[[m,O.value]])]),i("div",Oe,[(w(!0),n(u,null,v(Y.value,e=>(w(),n("div",{key:e.regNumber,class:g(["bank-dropdown-item",{"is-selected":e.regNumber===P(V).regNumber}]),onClick:a=>(e=>{B.setSelectedBank(e),$.value=!1,O.value="",ce(`Выбран банк: ${e.name} (№ ${e.regNumber})`,"info")})(e)},[i("div",Qe,[i("span",je,p(e.name),1),i("span",Ye,"№ "+p(e.regNumber),1)]),e.regNumber===P(V).regNumber?(w(),n("svg",We,[...a[6]||(a[6]=[i("polyline",{points:"20 6 9 17 4 12"},null,-1)])])):r("",!0)],10,qe))),128))])])):r("",!0)]),_:1})])])])]),a[8]||(a[8]=C('<div class="hero-meta" data-v-0c611fad><span class="glass-pill" data-v-0c611fad>Стратегия: <strong data-v-0c611fad>Мультиактив</strong></span><span class="glass-pill" data-v-0c611fad>Ребалансировка: <strong data-v-0c611fad>Ежемесячно</strong></span><span class="glass-pill risk-aggressive" data-v-0c611fad><span class="status-dot" data-v-0c611fad></span> Риск: Агрессивный </span></div>',1))]),i("div",Ze,[i("div",Ke,[a[9]||(a[9]=h("Обновлено: ",-1)),i("span",Je,p(R.value),1)]),i("button",{class:"btn-glass outline",onClick:re},[...a[10]||(a[10]=[i("svg",{width:"16",height:"16",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[i("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})],-1),h(" Экспорт PDF ",-1)])])])]),i("div",Xe,[i("div",ea,[i("div",aa,[a[11]||(a[11]=i("span",{class:"kpi-label"},"Общий P&L",-1)),i("div",{class:g(["trend-badge",H.value?.annual_return&&H.value.annual_return>=0?"positive":"negative"])},[(w(),n("svg",la,[H.value?.annual_return&&H.value.annual_return>=0?(w(),n("path",ta)):(w(),n("path",sa))])),h(" "+p(H.value?(100*H.value.annual_return).toFixed(1)+"%":"12.4%"),1)],2)]),i("div",oa,[i("div",na,[h(p(H.value?H.value.total_pnl.toLocaleString("ru-RU",{maximumFractionDigits:0}):"452,109")+" ",1),a[12]||(a[12]=i("small",null,"RUB",-1))]),i("div",ia,"ЧСА: "+p(H.value?(H.value.nav/1e6).toFixed(2)+"M":"3.64M"),1)])]),i("div",ra,[i("div",ca,[a[14]||(a[14]=i("span",{class:"kpi-label"},"VaR 95%",-1)),i("div",da,[a[13]||(a[13]=i("svg",{width:"10",height:"10",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"4"},[i("path",{d:"M6 9l6 6 6-6"})],-1)),h(" "+p(H.value?H.value.var_95_percent.toFixed(1)+"%":"1.2%"),1)])]),i("div",ua,[i("div",va,p(H.value?H.value.var_95_percent.toFixed(2)+"%":"2.45%"),1),a[15]||(a[15]=i("div",{class:"kpi-sub"},"Дневной риск",-1))])]),i("div",pa,[a[16]||(a[16]=i("div",{class:"kpi-header"},[i("span",{class:"kpi-label"},"Sharpe Ratio")],-1)),i("div",ma,[i("div",ha,p(H.value?H.value.sharpe_ratio.toFixed(2):"1.85"),1),i("div",ga,"Безрисковая ставка: "+p(H.value?(100*H.value.risk_free_rate).toFixed(1)+"%":"4.2%"),1)])]),i("div",fa,[a[17]||(a[17]=i("div",{class:"kpi-header"},[i("span",{class:"kpi-label"},"Диверсификация")],-1)),i("div",ba,[i("div",ya,p(H.value?H.value.diversification.toFixed(2):"0.34"),1),i("div",wa,"Коэфф. корреляции: "+p(H.value?H.value.avg_correlation.toFixed(2):"0.34"),1)])])]),i("div",xa,[i("div",ka,[i("div",Ca,[i("div",{class:"panel-header"},[a[19]||(a[19]=i("div",null,[i("h3",null,"Открытые позиции"),i("span",{class:"panel-subtitle"},"Топ-5 по весу в портфеле")],-1)),i("div",{class:"panel-header-actions"},[i("button",{class:"btn-glass outline compact",onClick:ae},[...a[18]||(a[18]=[C('<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-v-0c611fad><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" data-v-0c611fad></path><polyline points="14 2 14 8 20 8" data-v-0c611fad></polyline><line x1="16" y1="13" x2="8" y2="13" data-v-0c611fad></line><line x1="16" y1="17" x2="8" y2="17" data-v-0c611fad></line><polyline points="10 9 9 9 8 9" data-v-0c611fad></polyline></svg> Детализация ',2)])])])]),i("div",Pa,[i("div",za,[i("table",Ma,[a[20]||(a[20]=i("thead",null,[i("tr",null,[i("th",null,"Инструмент"),i("th",{class:"text-right"},"Цена"),i("th",{class:"text-right"},"День %"),i("th",{class:"text-right"},"Позиция"),i("th",{class:"text-right"},"Вес"),i("th",{class:"text-right"},"Таргет"),i("th",{class:"text-right"},"Дрифт")])],-1)),i("tbody",null,[(w(!0),n(u,null,v(K.value,e=>(w(),n("tr",{key:e.symbol,onClick:a=>ie(e),class:g({active:q.value?.symbol===e.symbol})},[i("td",null,[i("div",Ta,[i("div",{class:"asset-icon",style:b({background:e.color})},p(e.symbol[0]),5),i("div",Sa,[i("span",Fa,p(e.symbol),1),i("span",Na,p(e.name),1)])])]),i("td",Ea,"$"+p(e.price),1),i("td",_a,[i("span",{class:g(["change-pill",e.dayChange>0?"text-green":"text-red"])},p(e.dayChange>0?"+":"")+p(e.dayChange)+"%",3)]),i("td",Ba,"$"+p((e.notional/1e3).toFixed(1))+"k",1),i("td",Ra,p(e.allocation)+"%",1),i("td",La,p(e.targetAllocation)+"%",1),i("td",Ia,[i("div",{class:g(["drift-val",ue(e)])},p((e.allocation-e.targetAllocation).toFixed(1))+"%",3)])],10,Da))),128))])])])])]),i("div",Ha,[a[22]||(a[22]=i("div",{class:"panel-header"},[i("h3",null,"Матрица Корреляций")],-1)),i("div",Aa,[i("div",Va,[i("div",Ga,[a[21]||(a[21]=i("div",{class:"heatmap-empty"},null,-1)),(w(!0),n(u,null,v(te.value.slice(0,10),e=>(w(),n("div",{key:e.label,class:"heatmap-th"},p(e.label),1))),128))]),(w(!0),n(u,null,v(te.value.slice(0,10),(e,a)=>(w(),n("div",{class:"heatmap-row",key:a},[i("div",Ua,p(e.label),1),(w(!0),n(u,null,v(e.values.slice(0,10),(e,a)=>(w(),n("div",{class:"heatmap-cell",key:a,style:b({backgroundColor:de(e)})},p(1===e?"1.0":e.toFixed(2)),5))),128))]))),128))])])]),i("div",$a,[a[32]||(a[32]=i("div",{class:"panel-header"},[i("h3",null,"3D Тепловая карта активов"),i("span",{class:"panel-badge"},"Интерактивная визуализация")],-1)),i("div",Oa,[a[30]||(a[30]=i("p",{class:"section-description",style:{"margin-bottom":"8px",padding:"6px 10px",border:"1px solid rgba(255,255,255,0.1)","border-radius":"6px",background:"rgba(0,0,0,0.2)","font-size":"11px","line-height":"1.4"}},[h(" Каждый актив представлен шариком. Размер = вес в портфеле, цвет = цвет актива. Позиция в 3D пространстве основана на корреляциях между активами. "),i("br"),i("strong",null,"Наведите на шарик"),h(" для детализации позиции. ")],-1)),a[31]||(a[31]=i("div",{id:"correlation-3d-heatmap",style:{width:"100%",height:"500px",position:"relative","min-height":"500px",background:"rgba(0,0,0,0.1)","border-radius":"8px","margin-bottom":"0",display:"block",visibility:"visible",opacity:"1"}},null,-1)),Q.value?(w(),n("div",qa,[i("div",Qa,[i("div",{class:"asset-icon",style:b({background:Q.value.color})},p(Q.value.symbol[0]),5),i("div",null,[i("div",ja,p(Q.value.symbol),1),i("div",Ya,p(Q.value.name),1)])]),i("div",Wa,[i("div",Za,[a[23]||(a[23]=i("span",null,"Тип:",-1)),i("strong",null,p(Q.value.symbol.includes("ОФЗ")||Q.value.symbol.includes("Облигац")?"Облигация":"Акция"),1)]),void 0!==Q.value.volatility?(w(),n("div",Ka,[a[24]||(a[24]=i("span",null,"Волатильность:",-1)),i("strong",null,p(Q.value.volatility?.toFixed(1)||"Н/Д")+"%",1)])):r("",!0),void 0!==Q.value.avgCorrelation?(w(),n("div",Ja,[a[25]||(a[25]=i("span",null,"Ср. корреляция:",-1)),i("strong",null,p(Q.value.avgCorrelation?.toFixed(2)||"Н/Д"),1)])):r("",!0),i("div",Xa,[a[26]||(a[26]=i("span",null,"Вес в портфеле:",-1)),i("strong",null,p(Q.value.allocation?.toFixed(2)||Q.value.allocation)+"%",1)]),i("div",el,[a[27]||(a[27]=i("span",null,"Цена:",-1)),i("strong",null,p(Q.value.price?.toLocaleString("ru-RU")||Q.value.price)+" ₽",1)]),i("div",al,[a[28]||(a[28]=i("span",null,"Дневное изм.:",-1)),i("strong",{class:g(Q.value.dayChange>=0?"text-green":"text-red")},p(Q.value.dayChange>=0?"+":"")+p(Q.value.dayChange?.toFixed(2)||Q.value.dayChange)+"% ",3)]),Q.value.notional?(w(),n("div",ll,[a[29]||(a[29]=i("span",null,"Позиция:",-1)),i("strong",null,"$"+p((Q.value.notional/1e3).toFixed(1))+"k",1)])):r("",!0)])])):r("",!0)])])]),i("aside",tl,[k(M,{name:"fade"},{default:z(()=>[q.value?(w(),n("div",sl,[i("div",ol,[i("div",nl,[i("div",{class:"asset-lg-icon",style:b({background:q.value.color})},p(q.value.symbol[0]),5),i("div",il,[i("h2",null,p(q.value.symbol),1),i("span",null,p(q.value.name),1)])]),i("div",rl,p(q.value.symbol.includes("ОФЗ")||q.value.symbol.includes("Облигац")||q.value.symbol.includes("обл")?"Облигация":"Акция"),1)]),i("div",cl,[i("div",dl,[i("div",ul,[(w(!0),n(u,null,v((q.value.symbol,Array.from({length:20},()=>80*Math.random()+20)),(e,a)=>(w(),n("div",{key:a,class:"chart-bar",style:b({height:e+"%",backgroundColor:a>15?"#4ade80":"rgba(255,255,255,0.2)"})},null,4))),128))]),a[33]||(a[33]=i("div",{class:"chart-meta"},[i("span",{class:"active"},"1Д"),i("span",null,"1Н"),i("span",null,"1М"),i("span",null,"3М"),i("span",null,"1Г")],-1))]),a[34]||(a[34]=i("div",{class:"inspector-grid"},[i("div",{class:"metric-cell"},[i("label",null,"Доходность"),i("span",{class:"text-green"},"+14.2%")]),i("div",{class:"metric-cell"},[i("label",null,"Волатильность"),i("span",null,"18.5%")]),i("div",{class:"metric-cell"},[i("label",null,"Beta"),i("span",null,"1.12")]),i("div",{class:"metric-cell"},[i("label",null,"Max DD"),i("span",{class:"text-red"},"-12.4%")])],-1)),a[35]||(a[35]=i("div",{class:"micro-metrics"},[i("div",{class:"micro-metric"},[i("span",{class:"label"},"Sharpe"),i("span",{class:"value"},"0.92")]),i("div",{class:"micro-metric"},[i("span",{class:"label"},"Sortino"),i("span",{class:"value"},"1.38")]),i("div",{class:"micro-metric"},[i("span",{class:"label"},"Skew"),i("span",{class:"value"},"-0.24")])],-1))])])):r("",!0)]),_:1}),i("div",vl,[i("div",pl,[a[37]||(a[37]=C('<div class="optimizer-link-icon" data-v-0c611fad><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" data-v-0c611fad><path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" data-v-0c611fad></path></svg></div><h3 class="optimizer-link-title" data-v-0c611fad>Оптимизация портфеля</h3><p class="optimizer-link-description" data-v-0c611fad> Стохастическое оптимизирование с HJB-стратегией и CCMV модель оптимизации </p><div class="optimizer-link-features" data-v-0c611fad><span class="feature-tag" data-v-0c611fad>HJB-стратегия</span><span class="feature-tag" data-v-0c611fad>CCMV</span></div>',4)),k(l,{to:"/CCMVoptimization",class:"btn-glass primary w-full optimizer-link-btn"},{default:z(()=>[...a[36]||(a[36]=[i("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[i("path",{d:"M9 5l7 7-7 7"})],-1),h(" Перейти к оптимизации ",-1)])]),_:1})])]),i("div",ml,[a[47]||(a[47]=i("div",{class:"panel-header-mini"},[i("span",{class:"panel-title-mini"},"Риск и Статистика")],-1)),i("div",hl,[a[44]||(a[44]=i("div",{class:"metric-row"},[i("div",{class:"metric-label"},[i("span",null,"Expected Shortfall"),i("span",{class:"meta-hint"},"CVaR 95%")]),i("div",{class:"metric-value text-red"},"-3.78%")],-1)),i("div",gl,[a[38]||(a[38]=i("div",{class:"metric-label"},[i("span",null,"Max Drawdown"),i("span",{class:"meta-hint"},"От пика до минимума")],-1)),i("div",fl,p(H.value?(100*H.value.max_drawdown).toFixed(2)+"%":"-18.24%"),1)]),a[45]||(a[45]=C('<div class="metric-row" data-v-0c611fad><div class="metric-label" data-v-0c611fad><span data-v-0c611fad>Calmar Ratio</span><span class="meta-hint" data-v-0c611fad>Доходность / Max DD</span></div><div class="metric-value text-white" data-v-0c611fad>1.41</div></div><div class="metric-row" data-v-0c611fad><div class="metric-label" data-v-0c611fad><span data-v-0c611fad>Скользящая волатильность (30Д)</span><span class="meta-hint" data-v-0c611fad>Годовая</span></div><div class="metric-value text-white" data-v-0c611fad>12.8%</div></div><div class="metric-row" data-v-0c611fad><div class="metric-label" data-v-0c611fad><span data-v-0c611fad>Доходность с начала года</span><span class="meta-hint" data-v-0c611fad>YTD</span></div><div class="metric-value text-green" data-v-0c611fad>+8.42%</div></div><div class="metric-row" data-v-0c611fad><div class="metric-label" data-v-0c611fad><span data-v-0c611fad>Процент выигрышей</span><span class="meta-hint" data-v-0c611fad>% прибыльных</span></div><div class="metric-value text-green" data-v-0c611fad>58.3%</div></div><div class="metric-row" data-v-0c611fad><div class="metric-label" data-v-0c611fad><span data-v-0c611fad>Фактор прибыли</span><span class="meta-hint" data-v-0c611fad>Валовая П / Валовая У</span></div><div class="metric-value text-white" data-v-0c611fad>1.87x</div></div><div class="metric-row" data-v-0c611fad><div class="metric-label" data-v-0c611fad><span data-v-0c611fad>Средняя сделка</span><span class="meta-hint" data-v-0c611fad>Средняя доходность</span></div><div class="metric-value text-white" data-v-0c611fad>+0.34%</div></div>',6)),i("div",bl,[a[39]||(a[39]=i("div",{class:"metric-label"},[i("span",null,"Sharpe Ratio"),i("span",{class:"meta-hint"},"Скорректированный на риск")],-1)),i("div",yl,p(H.value?H.value.sharpe_ratio.toFixed(2):"1.52"),1)]),i("div",wl,[a[40]||(a[40]=i("div",{class:"metric-label"},[i("span",null,"Sortino Ratio"),i("span",{class:"meta-hint"},"Риск снижения")],-1)),i("div",xl,p(H.value?H.value.sortino_ratio.toFixed(2):"2.14"),1)]),i("div",kl,[a[41]||(a[41]=i("div",{class:"metric-label"},[i("span",null,"Beta"),i("span",{class:"meta-hint"},"относительно бенчмарка")],-1)),i("div",Cl,p(H.value?H.value.beta.toFixed(2):"0.87"),1)]),i("div",Pl,[a[42]||(a[42]=i("div",{class:"metric-label"},[i("span",null,"Alpha"),i("span",{class:"meta-hint"},"Избыточная доходность")],-1)),i("div",{class:g(["metric-value",H.value?.alpha&&H.value.alpha>=0?"text-green":"text-red"])},p(H.value?(H.value.alpha>=0?"+":"")+(100*H.value.alpha).toFixed(2)+"%":"+2.31%"),3)]),i("div",zl,[a[43]||(a[43]=i("div",{class:"metric-label"},[i("span",null,"VaR (95%)"),i("span",{class:"meta-hint"},"Дневной")],-1)),i("div",Ml,p(H.value?(-1*H.value.var_95_percent).toFixed(2)+"%":"-2.15%"),1)]),a[46]||(a[46]=C('<div class="metric-row" data-v-0c611fad><div class="metric-label" data-v-0c611fad><span data-v-0c611fad>Information Ratio</span><span class="meta-hint" data-v-0c611fad>Активная доходность / Ошибка отслеживания</span></div><div class="metric-value text-green" data-v-0c611fad>0.94</div></div><div class="metric-row" data-v-0c611fad><div class="metric-label" data-v-0c611fad><span data-v-0c611fad>Treynor Ratio</span><span class="meta-hint" data-v-0c611fad>Доходность / Beta</span></div><div class="metric-value text-white" data-v-0c611fad>9.67%</div></div><div class="metric-row" data-v-0c611fad><div class="metric-label" data-v-0c611fad><span data-v-0c611fad>Tracking Error</span><span class="meta-hint" data-v-0c611fad>относительно индекса</span></div><div class="metric-value text-white" data-v-0c611fad>3.42%</div></div>',3))])])])]),i("div",Dl,[a[48]||(a[48]=i("div",{class:"panel-header"},[i("h3",null,"3D Визуализация Корреляций"),i("span",{class:"panel-badge"},"Интерактивный анализ")],-1)),i("div",Tl,[k(Ee,{"available-assets":se.value},null,8,["available-assets"])])]),k(M,{name:"modal-fade"},{default:z(()=>[J.value?(w(),n("div",{key:0,class:"modal-overlay",onClick:le},[i("div",{class:g(["modal-container",{"modal-compact":ee.value.length<=20}]),onClick:a[3]||(a[3]=T(()=>{},["stop"]))},[i("div",{class:"modal-header"},[a[50]||(a[50]=i("h2",null,"Детализация портфеля ценных бумаг",-1)),i("button",{class:"modal-close",onClick:le},[...a[49]||(a[49]=[i("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[i("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),i("line",{x1:"6",y1:"6",x2:"18",y2:"18"})],-1)])])]),i("div",Sl,[i("div",Fl,[a[51]||(a[51]=i("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[i("circle",{cx:"11",cy:"11",r:"8"}),i("line",{x1:"21",y1:"21",x2:"16.65",y2:"16.65"})],-1)),c(i("input",{type:"text","onUpdate:modelValue":a[2]||(a[2]=e=>X.value=e),placeholder:"Поиск по инструменту или названию...",class:"modal-search-input"},null,512),[[m,X.value]])]),i("div",Nl,[i("table",El,[a[52]||(a[52]=i("thead",null,[i("tr",null,[i("th",null,"Инструмент"),i("th",{class:"text-right"},"Цена"),i("th",{class:"text-right"},"День %"),i("th",{class:"text-right"},"Позиция"),i("th",{class:"text-right"},"Вес"),i("th",{class:"text-right"},"Таргет"),i("th",{class:"text-right"},"Дрифт")])],-1)),i("tbody",null,[(w(!0),n(u,null,v(ee.value,e=>(w(),n("tr",{key:e.symbol,onClick:a=>{ie(e),le()},class:g({active:q.value?.symbol===e.symbol})},[i("td",null,[i("div",Bl,[i("div",{class:"asset-icon",style:b({background:e.color})},p(e.symbol[0]),5),i("div",Rl,[i("span",Ll,p(e.symbol),1),i("span",Il,p(e.name),1)])])]),i("td",Hl,"$"+p(e.price),1),i("td",Al,[i("span",{class:g(["change-pill",e.dayChange>0?"text-green":"text-red"])},p(e.dayChange>0?"+":"")+p(e.dayChange)+"%",3)]),i("td",Vl,"$"+p((e.notional/1e3).toFixed(1))+"k",1),i("td",Gl,p(e.allocation)+"%",1),i("td",Ul,p(e.targetAllocation)+"%",1),i("td",$l,[i("div",{class:g(["drift-val",ue(e)])},p((e.allocation-e.targetAllocation).toFixed(1))+"%",3)])],10,_l))),128))])])]),i("div",Ol,[i("div",ql,[i("span",null,[a[53]||(a[53]=h("Всего позиций: ",-1)),i("strong",null,p(P(G).length),1)]),i("span",null,[a[54]||(a[54]=h("Отображается: ",-1)),i("strong",null,p(ee.value.length),1)])])])])],2)])):r("",!0)]),_:1}),k(M,{name:"slide-up"},{default:z(()=>[I.value.show?(w(),n("div",{key:0,class:g(["toast-notification","toast-"+I.value.type])},p(I.value.message),3)):r("",!0)]),_:1})])}}}),[["__scopeId","data-v-0c611fad"]]);export{Ql as default};
