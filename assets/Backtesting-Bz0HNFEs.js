import{g as a,_ as s}from"./index-Ba4DjugF.js";import{usePortfolioStore as e}from"./portfolio-t34lcnLk.js";import{d as t,v as l,r,o as c,c as i,e as n,t as d,F as o,i as v,n as u,j as p,C as h,f as m,k as g,q as b}from"./vendor-DLyKmMu8.js";const f={class:"page-container custom-scroll"},x={class:"section-header"},y={class:"header-right"},k={class:"glass-pill control-pill"},_={class:"text-white font-bold"},w={class:"glass-segmented-control"},M=["onClick"],F={class:"kpi-cards-grid"},T={class:"glass-card kpi-card"},$={class:"kpi-value text-gradient-green"},A={class:"glass-card kpi-card"},j={class:"kpi-value text-white"},L={class:"glass-card kpi-card"},O={class:"kpi-value text-gradient-blue"},q={class:"glass-card kpi-card"},P={class:"kpi-value text-red"},S={class:"glass-card chart-panel"},C={class:"chart-container"},Y={viewBox:"0 0 1000 250",preserveAspectRatio:"none",class:"main-svg"},B=["d"],R=["d"],D=["d"],E=["cx","cy"],G={class:"dashboard-grid"},J={class:"col-left"},N={class:"glass-card panel-full"},Q={class:"table-wrapper custom-scroll"},U={class:"heatmap-table"},H={class:"col-month"},V={class:"col-right"},Z={class:"glass-card panel-full"},z={class:"stats-grid-mini"},I={class:"stat-box"},W={class:"val"},K={class:"stat-box"},X={class:"val text-green"},aa={class:"stat-box"},sa={class:"val text-green"},ea={class:"stat-box"},ta={class:"val text-green"},la={class:"stat-box"},ra={class:"val text-red"},ca={class:"stat-box"},ia={class:"val"},na={class:"glass-card panel-full"},da={class:"drawdown-list"},oa={class:"dd-info"},va={class:"dd-period"},ua={class:"dd-rec"},pa={class:"dd-right"},ha={class:"dd-val text-red"},ma={class:"dd-bar-bg"},ga=s(t({__name:"Backtesting",setup(s){const t=e(),ga=l(()=>t.selectedBank),ba=r(["1M","3M","6M","YTD","1Y","All"]),fa=r("YTD"),xa=r(!1),ya=r(null),ka=r(["2024","2025"]),_a=r(["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"]),wa=r([{2024:"+2.1",2025:"+1.8"},{2024:"+3.4",2025:"-1.2"},{2024:"-0.5",2025:"+2.9"},{2024:"+1.7",2025:"+0.8"},{2024:"+2.3",2025:"-0.3"},{2024:"+1.9",2025:"+1.5"},{2024:"+2.8",2025:"+2.1"},{2024:"-1.1",2025:"+0.9"},{2024:"+3.2",2025:"+1.4"},{2024:"+2.5",2025:"+3.1"},{2024:"+1.8",2025:"+2.2"},{2024:"+4.1",2025:"+2.8"}]),Ma=[{period:"Mar 23 — May 23",amount:-14.2,recovery:"6 mo"},{period:"Sep 23 — Oct 23",amount:-8.5,recovery:"3 mo"},{period:"Feb 24 — Mar 24",amount:-5.3,recovery:"2 mo"}],Fa=a=>{const s="string"==typeof a?parseFloat(a):a;return s>=3?"bg-green-strong":s>0?"bg-green-soft":0===s?"bg-neutral":s>-2?"bg-red-soft":"bg-red-strong"},Ta=l(()=>{if(!ya.value?.metrics?.monthly_returns)return wa.value;const a=ya.value.metrics.monthly_returns,s=[],e=Object.keys(a).sort();for(let t=0;t<12;t++){const l={};for(const s of e){const e=a[s]?.[t+1];l[s]=void 0!==e?e>0?"+"+e.toFixed(1):e.toFixed(1):"0.0"}s.push(l)}return s}),$a=l(()=>ya.value?.metrics?.monthly_returns?Object.keys(ya.value.metrics.monthly_returns).sort():ka.value),Aa=async()=>{if(!xa.value){xa.value=!0;try{const s=t.positions.length||23,e=t.positions.map(a=>a.symbol),l=Array.from({length:s},()=>.05+.1*Math.random()),r=t.correlationMatrix,c=Array.from({length:s},()=>.15+.15*Math.random()),i=[];for(let a=0;a<s;a++){const e=[];for(let t=0;t<s;t++){let s=.3;r.length>a&&void 0!==r[a]?.values?.[t]?s=r[a].values[t]:a===t&&(s=1),e.push(s*c[a]*c[t])}i.push(e)}const n=await(async s=>{try{const e=await fetch("   https://stochastic-dashbord-v1-production.up.railway.app/api/backtest/run",{method:"POST",headers:a(),body:JSON.stringify(s)});if(!e.ok){const a=await e.json().catch(()=>({detail:"Unknown error"}));throw new Error(a.detail||`HTTP error! status: ${e.status}`)}return await e.json()}catch(e){throw console.error("Backtest Failed:",e),e}})({mu:l,cov_matrix:i,initial_capital:1e6,risk_free_rate:.1394,gamma:3,horizon_years:1,n_steps:252,asset_names:e,n_paths:1e3,seed:42});ya.value=n}catch(s){console.error("Ошибка бэктестинга:",s)}finally{xa.value=!1}}},ja=()=>{if(!ya.value?.equity_curve||0===ya.value.equity_curve.length)return"M0,220 Q150,200 300,150 T600,100 T1000,40";const a=ya.value.equity_curve,s=Math.min(...a),e=Math.max(...a)-s||1,t=a.length;let l="";for(let r=0;r<t;r++){const c=r/(t-1)*1e3,i=250-(a[r]-s)/e*200-25;l+=0===r?`M${c},${i}`:` L${c},${i}`}return l},La=()=>{if(!ya.value?.benchmark_curve||0===ya.value.benchmark_curve.length)return"M0,220 Q150,210 300,190 T600,160 T1000,120";const a=ya.value.benchmark_curve,s=Math.min(...ya.value.equity_curve||[0],...a),e=Math.max(...ya.value.equity_curve||[0],...a)-s||1,t=a.length;let l="";for(let r=0;r<t;r++){const c=r/(t-1)*1e3,i=250-(a[r]-s)/e*200-25;l+=0===r?`M${c},${i}`:` L${c},${i}`}return l},Oa=()=>{const a=ja();if(!a||"M0,220 Q150,200 300,150 T600,100 T1000,40"===a)return"M0,220 Q150,200 300,150 T600,100 T1000,40 V250 H0 Z";const s=a.match(/L([0-9.]+),([0-9.]+)$/);return s?a+` L${s[1]},250 L0,250 Z`:a+" V250 H0 Z"},qa=l(()=>{if(!ya.value?.metrics?.drawdowns||0===ya.value.metrics.drawdowns.length)return null;ya.value.metrics.drawdowns[0];const a=ya.value.equity_curve;if(!a||0===a.length)return null;const s=Math.min(...a),e=a.indexOf(s);if(-1===e)return null;const t=Math.min(...a),l=Math.max(...a)-t||1;return{x:e/(a.length-1)*1e3,y:250-(t-t)/l*200-25}});return c(()=>{Aa()}),(a,s)=>(b(),i("div",f,[n("div",x,[s[1]||(s[1]=n("div",{class:"header-left"},[n("h1",{class:"section-title"},"Результаты бэктеста"),n("p",{class:"section-subtitle"},"Историческая симуляция стратегии (Long/Short)")],-1)),n("div",y,[n("div",k,[s[0]||(s[0]=n("span",{class:"lbl-mini"},"Банк:",-1)),n("span",_,d(ga.value.name),1)]),n("div",w,[(b(!0),i(o,null,v(ba.value,a=>(b(),i("button",{key:a,onClick:s=>fa.value=a,class:u(["seg-btn",{active:fa.value===a}])},d(a),11,M))),128))])])]),n("div",F,[n("div",T,[s[2]||(s[2]=n("div",{class:"kpi-label"},"Общая доходность",-1)),n("div",$,d(ya.value?.metrics?(100*ya.value.metrics.total_return).toFixed(1)+"%":"+24.5%"),1),s[3]||(s[3]=n("div",{class:"kpi-change text-green"},[n("span",{class:"icon-up"},"↑"),p(" vs SPY: +6.2% ")],-1))]),n("div",A,[s[4]||(s[4]=n("div",{class:"kpi-label"},"CAGR (Годовая)",-1)),n("div",j,d(ya.value?.metrics?(100*ya.value.metrics.cagr).toFixed(1)+"%":"18.2%"),1),s[5]||(s[5]=n("div",{class:"kpi-change text-muted"},"Безрисковая ставка: 5.0%",-1))]),n("div",L,[s[6]||(s[6]=n("div",{class:"kpi-label"},"Коэф. Шарпа",-1)),n("div",O,d(ya.value?.metrics?ya.value.metrics.sharpe_ratio.toFixed(2):"1.58"),1),s[7]||(s[7]=n("div",{class:"kpi-change text-blue"},"Топ 15%",-1))]),n("div",q,[s[8]||(s[8]=n("div",{class:"kpi-label"},"Макс. Просадка",-1)),n("div",P,d(ya.value?.metrics?(100*ya.value.metrics.max_drawdown).toFixed(1)+"%":"-14.2%"),1),s[9]||(s[9]=n("div",{class:"kpi-change text-red"},"Высокий риск",-1))])]),n("div",S,[s[11]||(s[11]=h('<div class="panel-header" data-v-cbc555e1><div class="ph-left" data-v-cbc555e1><h3 data-v-cbc555e1>Кривая капитала</h3><span class="badge-live" data-v-cbc555e1>Накопительный</span></div><div class="chart-legend" data-v-cbc555e1><div class="legend-item" data-v-cbc555e1><span class="dot strategy" data-v-cbc555e1></span>Портфель</div><div class="legend-item" data-v-cbc555e1><span class="dot benchmark" data-v-cbc555e1></span>S&amp;P 500</div></div></div>',1)),n("div",C,[(b(),i("svg",Y,[s[10]||(s[10]=h('<defs data-v-cbc555e1><linearGradient id="grad-green" x1="0" y1="0" x2="0" y2="1" data-v-cbc555e1><stop offset="0%" stop-color="rgba(74, 222, 128, 0.3)" data-v-cbc555e1></stop><stop offset="100%" stop-color="rgba(74, 222, 128, 0)" data-v-cbc555e1></stop></linearGradient></defs><line x1="0" y1="50" x2="1000" y2="50" stroke="rgba(255,255,255,0.05)" data-v-cbc555e1></line><line x1="0" y1="125" x2="1000" y2="125" stroke="rgba(255,255,255,0.05)" data-v-cbc555e1></line><line x1="0" y1="200" x2="1000" y2="200" stroke="rgba(255,255,255,0.05)" data-v-cbc555e1></line>',4)),n("path",{d:La(),fill:"none",stroke:"rgba(255,255,255,0.2)","stroke-width":"2","stroke-dasharray":"6,4"},null,8,B),n("path",{d:Oa(),fill:"url(#grad-green)",stroke:"none"},null,8,R),n("path",{d:ja(),fill:"none",stroke:"#4ade80","stroke-width":"3","stroke-linecap":"round"},null,8,D),qa.value?(b(),i("circle",{key:0,cx:qa.value.x,cy:qa.value.y,r:"4",fill:"#1e293b",stroke:"#f87171","stroke-width":"2"},null,8,E)):m("",!0)]))])]),n("div",G,[n("div",J,[n("div",N,[s[14]||(s[14]=n("div",{class:"panel-header"},[n("h3",null,"Месячная доходность")],-1)),n("div",Q,[n("table",U,[n("thead",null,[n("tr",null,[s[12]||(s[12]=n("th",{class:"col-month"},null,-1)),(b(!0),i(o,null,v($a.value,a=>(b(),i("th",{key:a,class:"col-year"},d(a),1))),128))])]),n("tbody",null,[(b(!0),i(o,null,v(_a.value,(a,s)=>(b(),i("tr",{key:a},[n("td",H,d(a),1),(b(!0),i(o,null,v($a.value,e=>(b(),i("td",{key:`${a}-${e}`,class:"col-val"},[n("div",{class:u(["val-pill",Fa(Ta.value[s]?.[e]||"0.0")])},d(Ta.value[s]?.[e]||"0.0")+"% ",3)]))),128))]))),128)),s[13]||(s[13]=n("tr",{class:"row-total"},[n("td",{class:"col-month"},"YTD"),n("td",{class:"col-val"},[n("span",{class:"text-green font-bold"},"+24.1%")]),n("td",{class:"col-val"},[n("span",{class:"text-green font-bold"},"+18.5%")])],-1))])])])])]),n("div",V,[n("div",Z,[s[21]||(s[21]=n("div",{class:"panel-header"},[n("h3",null,"Статистика сделок")],-1)),n("div",z,[n("div",I,[s[15]||(s[15]=n("span",{class:"lbl"},"Всего сделок",-1)),n("span",W,d(ya.value?.metrics?.total_trades||243),1)]),n("div",K,[s[16]||(s[16]=n("span",{class:"lbl"},"Win Rate",-1)),n("span",X,d(ya.value?.metrics?(100*ya.value.metrics.win_rate).toFixed(1)+"%":"64.2%"),1)]),n("div",aa,[s[17]||(s[17]=n("span",{class:"lbl"},"Profit Factor",-1)),n("span",sa,d(ya.value?.metrics?ya.value.metrics.profit_factor.toFixed(2):"2.34"),1)]),n("div",ea,[s[18]||(s[18]=n("span",{class:"lbl"},"Средняя прибыль",-1)),n("span",ta,d(ya.value?.metrics?"+"+ya.value.metrics.avg_profit.toFixed(0):"+₽245"),1)]),n("div",la,[s[19]||(s[19]=n("span",{class:"lbl"},"Средний убыток",-1)),n("span",ra,d(ya.value?.metrics?"-"+ya.value.metrics.avg_loss.toFixed(0):"-₽145"),1)]),n("div",ca,[s[20]||(s[20]=n("span",{class:"lbl"},"Время удержания",-1)),n("span",ia,d(ya.value?.metrics?ya.value.metrics.hold_time.toFixed(1)+"d":"8.4d"),1)])])]),n("div",na,[s[22]||(s[22]=n("div",{class:"panel-header"},[n("h3",null,"Топ 3 просадки")],-1)),n("div",da,[(b(!0),i(o,null,v(ya.value?.metrics?.drawdowns||Ma,(a,s)=>(b(),i("div",{key:s,class:"dd-item"},[n("div",oa,[n("span",va,d(a.period),1),n("span",ua,"Восстановление: "+d(a.recovery),1)]),n("div",pa,[n("span",ha,d(a.amount.toFixed(1))+"%",1),n("div",ma,[n("div",{class:"dd-bar-fill",style:g({width:3*Math.abs(a.amount)+"px"})},null,4)])])]))),128))])])])])]))}}),[["__scopeId","data-v-cbc555e1"]]);export{ga as default};
