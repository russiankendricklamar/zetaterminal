import{d as a,r as e,v as l,G as t,c as s,e as i,f as r,x as n,y as o,t as c,F as u,n as d,i as p,A as v,q as m}from"./vendor-DLyKmMu8.js";import{i as b}from"./index-BjvaFruF.js";import{g as f,_ as y}from"./index-Ba4DjugF.js";const _={class:"ml-page"},h={class:"card input-card"},g={class:"form-grid"},x={class:"form-group"},k={class:"form-group"},S={class:"form-group"},w={class:"form-group"},L={class:"form-group"},F={class:"form-group"},P={class:"form-group",style:{"margin-bottom":"16px"}},C={key:0,class:"parse-info"},A={key:1,class:"parse-error"},R={class:"actions"},$=["disabled"],z={key:0,class:"error-msg"},I={class:"kpi-grid"},M={class:"kpi-card"},j={class:"kpi-card"},O={class:"kpi-card"},T={class:"kpi-card"},U={class:"kpi-card"},V={class:"kpi-value"},G={class:"kpi-card"},q={class:"kpi-value"},N={class:"kpi-sub"},B={class:"info-row"},E={class:"info-card"},H={class:"info-val"},J={class:"info-card"},W={class:"info-val"},D={class:"info-card"},K={class:"info-val"},Q={class:"info-card"},X={class:"info-label"},Y={class:"charts-row"},Z={class:"card chart-card"},aa={class:"card chart-card"},ea={class:"charts-row"},la={class:"card chart-card"},ta={class:"card chart-card"},sa={class:"card"},ia={class:"card"},ra={class:"stats-table"},na=y(a({__name:"MetaLabeling",setup(a){const y=e({pt_multiplier:1.5,sl_multiplier:1,max_holding:5,vol_window:20,train_ratio:.7,meta_threshold:.5}),na=e(""),oa=e(!1),ca=e(""),ua=e(null),da=e(null),pa=e(null),va=e(null),ma=e(null),ba=e(null);let fa=[];const ya=l(()=>{if(!na.value.trim())return null;const a=na.value.trim().replace(/\n/g,",").split(",").map(a=>parseFloat(a.trim())).filter(a=>!isNaN(a));return a.length>=50?a:null}),_a=l(()=>{if(!na.value.trim())return"";const a=na.value.trim().replace(/\n/g,",").split(",").map(a=>parseFloat(a.trim())).filter(a=>!isNaN(a));return a.length<50?`Нужно минимум 50 значений, получено ${a.length}`:""});function ha(){let a=7654;const e=()=>(a=1664525*a+1013904223&2147483647,a/2147483647*2-1),l=[100];for(let t=1;t<300;t++)l.push(l[t-1]*(1+.01*e()+2e-4));na.value=l.map(a=>a.toFixed(4)).join("\n")}async function ga(){if(ya.value){oa.value=!0,ca.value="",ua.value=null;try{const a=await fetch("   https://stochastic-dashbord-v1-production.up.railway.app/api/meta-labeling/analyze",{method:"POST",headers:{"Content-Type":"application/json",...f()},body:JSON.stringify({prices:ya.value,...y.value})});if(!a.ok){const e=await a.json();throw new Error(e.detail||`HTTP ${a.status}`)}const e=await a.json();ua.value=e.result,await v(),ka()}catch(a){ca.value=a.message}finally{oa.value=!1}}}function xa(a){if(!a)return null;const e=b(a,"dark");return fa.push(e),e}function ka(){fa.forEach(a=>a.dispose()),fa=[],function(){const a=xa(da.value);if(!a||!ua.value)return;const e=ua.value.equity_baseline,l=ua.value.equity_meta,t=e.map((a,e)=>e+1);a.setOption({backgroundColor:"transparent",tooltip:{trigger:"axis"},legend:{top:5,textStyle:{color:"#aaa"}},xAxis:{type:"category",data:t,axisLabel:{color:"#aaa"}},yAxis:{name:"Cumulative Log Return",splitLine:{lineStyle:{color:"#333"}}},series:[{name:"Baseline (все сигналы)",type:"line",data:e,lineStyle:{color:"#888",type:"dashed"},symbol:"none"},{name:"Meta (фильтровано)",type:"line",data:l,lineStyle:{color:"#4caf72",width:2},symbol:"none"}],grid:{left:65,right:20,top:35,bottom:30}})}(),function(){const a=xa(pa.value);if(!a||!ua.value)return;const e=ua.value.pr_curve,l=e.map(a=>[a.recall,a.precision]),t=e.map(a=>`thr=${a.threshold} n=${a.n_bets}`);a.setOption({backgroundColor:"transparent",tooltip:{trigger:"item",formatter:a=>`${t[a.dataIndex]}<br/>P=${a.data[1].toFixed(3)} R=${a.data[0].toFixed(3)}`},xAxis:{name:"Recall",nameLocation:"middle",nameGap:28,min:0,max:1,splitLine:{lineStyle:{color:"#333"}}},yAxis:{name:"Precision",nameLocation:"middle",nameGap:40,min:0,max:1,splitLine:{lineStyle:{color:"#333"}}},series:[{type:"line",data:l,lineStyle:{color:"#5b8af5"},itemStyle:{color:"#5b8af5"},symbol:"circle",symbolSize:5}],grid:{left:60,right:20,top:20,bottom:45}})}(),function(){const a=xa(va.value);if(!a||!ua.value)return;const{counts:e,bin_edges:l}=ua.value.prob_hist,t=ua.value.meta_threshold;a.setOption({backgroundColor:"transparent",tooltip:{trigger:"axis"},xAxis:{type:"category",data:l.slice(0,-1).map(a=>a.toFixed(2)),name:"P(profitable)",nameLocation:"middle",nameGap:28,axisLabel:{interval:4,color:"#aaa"}},yAxis:{name:"Частота",splitLine:{lineStyle:{color:"#333"}}},series:[{type:"bar",data:e,itemStyle:{color:a=>l[a.dataIndex]>=t?"#4caf72":"#5b8af5",opacity:.85}}],grid:{left:50,right:20,top:20,bottom:45}})}(),function(){const a=xa(ma.value);if(!a||!ua.value)return;const e=ua.value.feature_importances,l=ua.value.feature_names,t=l.map(a=>e[a]??0),s=l.map((a,e)=>({n:a,v:t[e]})).sort((a,e)=>Math.abs(e.v)-Math.abs(a.v));a.setOption({backgroundColor:"transparent",tooltip:{trigger:"axis"},xAxis:{type:"value",splitLine:{lineStyle:{color:"#333"}}},yAxis:{type:"category",data:s.map(a=>a.n),axisLabel:{color:"#aaa"}},series:[{type:"bar",data:s.map(a=>({value:+a.v.toFixed(4),itemStyle:{color:a.v>=0?"#4caf72":"#e05c5c"}}))}],grid:{left:75,right:20,top:10,bottom:30}})}(),function(){const a=xa(ba.value);if(!a||!ua.value)return;const e=ua.value.test_probs,l=ua.value.test_returns,t=ua.value.test_labels,s=ua.value.meta_threshold,i=e.map((a,e)=>({value:[a,l[e]],label:t[e],bet:a>=s})),r={1:"#4caf72"};a.setOption({backgroundColor:"transparent",tooltip:{trigger:"item",formatter:a=>{const e=i[a.dataIndex];return`P(profit)=${e.value[0].toFixed(3)}<br/>Return=${e.value[1].toFixed(4)}<br/>Bet: ${e.bet?"Да":"Нет"}`}},xAxis:{name:"P(profitable)",nameLocation:"middle",nameGap:28,min:0,max:1,splitLine:{lineStyle:{color:"#333"}}},yAxis:{name:"Realized Return",nameLocation:"middle",nameGap:45,splitLine:{lineStyle:{color:"#333"}}},series:[{type:"scatter",data:i.map(a=>a.value),symbolSize:8,itemStyle:{color:a=>1===i[a.dataIndex].label?r[1]:"#e05c5c",opacity:a=>i[a.dataIndex].bet?1:.35,borderColor:a=>i[a.dataIndex].bet?"#fff":"transparent",borderWidth:1}}],grid:{left:65,right:20,top:20,bottom:45}})}()}const Sa=a=>`${(100*a).toFixed(1)}%`,wa=a=>a>=.55?"ok-val":a>=.45?"warn-val":"danger-val",La=["precision","recall","f1","accuracy","sr","raw_sr","n_bets","avg_bet_size"],Fa=(a,e)=>["precision","recall","f1","accuracy","avg_bet_size"].includes(a)?Sa(e):["sr","raw_sr"].includes(a)?e.toFixed(3):String(Math.round(e)),Pa=(a,e)=>["sr","raw_sr"].includes(a)?e>0?"ok-val":"danger-val":["precision","recall","f1","accuracy"].includes(a)?wa(e):"";return t(ua,async a=>{a&&(await v(),ka())}),(a,e)=>(m(),s("div",_,[e[43]||(e[43]=i("div",{class:"page-header"},[i("h1",null,"Meta-Labeling"),i("p",{class:"subtitle"}," Triple-Barrier Labeling · Primary Side Rule · Logistic Meta-Model · Bet Sizing ")],-1)),i("div",h,[e[20]||(e[20]=i("h2",null,"Параметры",-1)),i("div",g,[i("div",x,[e[7]||(e[7]=i("label",null,"Profit-Take множитель",-1)),n(i("input",{"onUpdate:modelValue":e[0]||(e[0]=a=>y.value.pt_multiplier=a),type:"number",min:"0.1",step:"0.1"},null,512),[[o,y.value.pt_multiplier,void 0,{number:!0}]]),e[8]||(e[8]=i("span",{class:"hint"},"PT барьер = pt × daily_vol. Рекомендовано 1.5–3.",-1))]),i("div",k,[e[9]||(e[9]=i("label",null,"Stop-Loss множитель",-1)),n(i("input",{"onUpdate:modelValue":e[1]||(e[1]=a=>y.value.sl_multiplier=a),type:"number",min:"0.1",step:"0.1"},null,512),[[o,y.value.sl_multiplier,void 0,{number:!0}]]),e[10]||(e[10]=i("span",{class:"hint"},"SL барьер = sl × daily_vol. Рекомендовано 0.5–1.5.",-1))]),i("div",S,[e[11]||(e[11]=i("label",null,"Макс. горизонт (баров)",-1)),n(i("input",{"onUpdate:modelValue":e[2]||(e[2]=a=>y.value.max_holding=a),type:"number",min:"1",max:"100"},null,512),[[o,y.value.max_holding,void 0,{number:!0}]]),e[12]||(e[12]=i("span",{class:"hint"},"Временной барьер. 5 = 1 неделя для дневных.",-1))]),i("div",w,[e[13]||(e[13]=i("label",null,"Окно rolling vol",-1)),n(i("input",{"onUpdate:modelValue":e[3]||(e[3]=a=>y.value.vol_window=a),type:"number",min:"5",max:"252"},null,512),[[o,y.value.vol_window,void 0,{number:!0}]]),e[14]||(e[14]=i("span",{class:"hint"},"Используется для нормировки барьеров.",-1))]),i("div",L,[e[15]||(e[15]=i("label",null,"Обучающая выборка",-1)),n(i("input",{"onUpdate:modelValue":e[4]||(e[4]=a=>y.value.train_ratio=a),type:"number",min:"0.1",max:"0.9",step:"0.05"},null,512),[[o,y.value.train_ratio,void 0,{number:!0}]]),e[16]||(e[16]=i("span",{class:"hint"},"0.7 = первые 70% для обучения.",-1))]),i("div",F,[e[17]||(e[17]=i("label",null,"Порог вероятности",-1)),n(i("input",{"onUpdate:modelValue":e[5]||(e[5]=a=>y.value.meta_threshold=a),type:"number",min:"0.1",max:"0.9",step:"0.05"},null,512),[[o,y.value.meta_threshold,void 0,{number:!0}]]),e[18]||(e[18]=i("span",{class:"hint"},"Открывать позицию только при P(profit) ≥ порог.",-1))])]),i("div",P,[e[19]||(e[19]=i("label",null,"Ценовой ряд (одно значение на строку или через запятую)",-1)),n(i("textarea",{"onUpdate:modelValue":e[6]||(e[6]=a=>na.value=a),rows:"6",placeholder:"100.0\n100.5\n101.2\n..."},null,512),[[o,na.value]]),ya.value?(m(),s("div",C,c(ya.value.length)+" цен загружено",1)):r("",!0),_a.value?(m(),s("div",A,c(_a.value),1)):r("",!0)]),i("div",R,[i("button",{class:"btn-primary",onClick:ga,disabled:oa.value||!!_a.value||!na.value.trim()},c(oa.value?"Вычисление...":"Запустить анализ"),9,$),i("button",{class:"btn-secondary",onClick:ha},"Демо-данные (300 баров)")]),ca.value?(m(),s("div",z,c(ca.value),1)):r("",!0)]),ua.value?(m(),s(u,{key:0},[i("div",I,[i("div",M,[e[21]||(e[21]=i("div",{class:"kpi-label"},"Precision (тест)",-1)),i("div",{class:d(["kpi-value",wa(ua.value.test_metrics.precision)])},c(Sa(ua.value.test_metrics.precision)),3),e[22]||(e[22]=i("div",{class:"kpi-sub"},"точность мета-сигнала",-1))]),i("div",j,[e[23]||(e[23]=i("div",{class:"kpi-label"},"Recall (тест)",-1)),i("div",{class:d(["kpi-value",wa(ua.value.test_metrics.recall)])},c(Sa(ua.value.test_metrics.recall)),3),e[24]||(e[24]=i("div",{class:"kpi-sub"},"полнота",-1))]),i("div",O,[e[25]||(e[25]=i("div",{class:"kpi-label"},"F1 (тест)",-1)),i("div",{class:d(["kpi-value",wa(ua.value.test_metrics.f1)])},c(Sa(ua.value.test_metrics.f1)),3),e[26]||(e[26]=i("div",{class:"kpi-sub"},"гармоническое среднее",-1))]),i("div",T,[e[27]||(e[27]=i("div",{class:"kpi-label"},"SR (мета)",-1)),i("div",{class:d(["kpi-value",ua.value.test_metrics.sr>ua.value.test_metrics.raw_sr?"ok-val":"danger-val"])},c(ua.value.test_metrics.sr.toFixed(3)),3),e[28]||(e[28]=i("div",{class:"kpi-sub"},"фильтрованный Sharpe",-1))]),i("div",U,[e[29]||(e[29]=i("div",{class:"kpi-label"},"SR (baseline)",-1)),i("div",V,c(ua.value.test_metrics.raw_sr.toFixed(3)),1),e[30]||(e[30]=i("div",{class:"kpi-sub"},"без фильтра",-1))]),i("div",G,[e[31]||(e[31]=i("div",{class:"kpi-label"},"Ставок / Всего",-1)),i("div",q,c(ua.value.test_metrics.n_bets)+" / "+c(ua.value.test_metrics.n_total),1),i("div",N,"avg bet="+c(Sa(ua.value.test_metrics.avg_bet_size)),1)])]),i("div",B,[i("div",E,[e[32]||(e[32]=i("span",{class:"info-label"},"Выборок",-1)),i("span",H,c(ua.value.n_samples),1)]),i("div",J,[e[33]||(e[33]=i("span",{class:"info-label"},"Обучение",-1)),i("span",W,c(ua.value.n_train),1)]),i("div",D,[e[34]||(e[34]=i("span",{class:"info-label"},"Тест",-1)),i("span",K,c(ua.value.n_test),1)]),i("div",Q,[e[35]||(e[35]=i("span",{class:"info-label"},"Primary acc (тест)",-1)),i("span",{class:d(["info-val",wa(ua.value.primary_accuracy_test)])},c(Sa(ua.value.primary_accuracy_test)),3)]),(m(!0),s(u,null,p(ua.value.label_distribution,(a,e)=>(m(),s("div",{class:"info-card",key:e},[i("span",X,"Label "+c(e),1),i("span",{class:d(["info-val",1==e?"ok-val":-1==e?"danger-val":"neutral-val"])},c(a),3)]))),128))]),i("div",Y,[i("div",Z,[e[36]||(e[36]=i("h3",null,"Equity кривые (тест)",-1)),i("div",{ref_key:"equityChart",ref:da,class:"chart"},null,512)]),i("div",aa,[e[37]||(e[37]=i("h3",null,"Precision-Recall кривая (threshold sweep)",-1)),i("div",{ref_key:"prChart",ref:pa,class:"chart"},null,512)])]),i("div",ea,[i("div",la,[e[38]||(e[38]=i("h3",null,"Распределение мета-вероятностей (тест)",-1)),i("div",{ref_key:"probHistChart",ref:va,class:"chart"},null,512)]),i("div",ta,[e[39]||(e[39]=i("h3",null,"Feature Importances (мета-модель)",-1)),i("div",{ref_key:"featChart",ref:ma,class:"chart"},null,512)])]),i("div",sa,[e[40]||(e[40]=i("h3",null,"Ставки: вероятность vs реализованная доходность (тест)",-1)),i("div",{ref_key:"betScatter",ref:ba,class:"chart tall-chart"},null,512)]),i("div",ia,[e[42]||(e[42]=i("h3",null,"Метрики: обучение vs тест",-1)),i("table",ra,[e[41]||(e[41]=i("thead",null,[i("tr",null,[i("th",null,"Метрика"),i("th",null,"Обучение"),i("th",null,"Тест")])],-1)),i("tbody",null,[(m(),s(u,null,p(La,a=>{return i("tr",{key:a},[i("td",null,c((e=a,{precision:"Precision",recall:"Recall",f1:"F1",accuracy:"Accuracy",sr:"Sharpe (meta)",raw_sr:"Sharpe (raw)",n_bets:"Кол-во ставок",avg_bet_size:"Avg bet size"}[e]??e)),1),i("td",{class:d(Pa(a,ua.value.train_metrics[a]))},c(Fa(a,ua.value.train_metrics[a])),3),i("td",{class:d(Pa(a,ua.value.test_metrics[a]))},c(Fa(a,ua.value.test_metrics[a])),3)]);var e}),64))])])])],64)):r("",!0)]))}}),[["__scopeId","data-v-a801f343"]]);export{na as default};
