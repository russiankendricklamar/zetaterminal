const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-Ba4DjugF.js","assets/vendor-DLyKmMu8.js","assets/index-DwGIjbya.css","assets/multivariateHmmService-DuaXhU80.js","assets/portfolio-t34lcnLk.js"])))=>i.map(i=>d[i]);
import{_ as e,a as t,u as i}from"./index-Ba4DjugF.js";import{d as a,r as s,v as n,b as o,c as r,n as l,f as c,e as h,t as d,q as u,G as m,o as v,g as p,x as g,L as y,C as f,j as w,M as x,F as b,i as M,k as A,T as S,w as k,y as E,P as C,N as R}from"./vendor-DLyKmMu8.js";import{usePortfolioStore as P}from"./portfolio-t34lcnLk.js";import{V as D,S as j,C as T,F as I,P as L,W as F,a as _,A as N,D as V,R as H,M as O,b as q,c as z,G as B,d as $,e as U,f as X,L as Z,B as W,g as Y,h as G,i as Q,j as J,k as K,l as ee,E as te,m as ie,n as ae,o as se,p as ne,q as oe,r as re,s as le,t as ce,u as he}from"./three.module-7SAW-liO.js";import{O as de}from"./OrbitControls-CXwf_Mcn.js";const ue={key:0,class:"scrub-prefix"},me={class:"scrub-value"},ve={key:1,class:"scrub-suffix"},pe=e(a({__name:"ScrubInput",props:{modelValue:{type:Number,required:!0},step:{type:Number,default:1},min:{type:Number,default:-1/0},max:{type:Number,default:1/0},decimals:{type:Number,default:0},prefix:{type:String,default:""},suffix:{type:String,default:""},sensitivity:{type:Number,default:1}},emits:["update:modelValue","change"],setup(e,{emit:t}){const i=e,a=t,m=s(!1);let v=0,p=0;const g=n(()=>i.modelValue.toFixed(i.decimals)),y=e=>{m.value=!0,v=e.clientX,p=i.modelValue,document.body.style.cursor="ew-resize",document.body.style.userSelect="none",window.addEventListener("mousemove",f),window.addEventListener("mouseup",w)},f=e=>{if(!m.value)return;const t=e.clientX-v;let s=p+t*i.sensitivity*i.step;s<i.min&&(s=i.min),s>i.max&&(s=i.max),a("update:modelValue",s),a("change",s)},w=()=>{m.value=!1,document.body.style.cursor="",document.body.style.userSelect="",window.removeEventListener("mousemove",f),window.removeEventListener("mouseup",w)};return o(()=>{window.removeEventListener("mousemove",f),window.removeEventListener("mouseup",w)}),(t,i)=>(u(),r("div",{class:l(["scrub-container",{dragging:m.value}]),onMousedown:y},[e.prefix?(u(),r("span",ue,d(e.prefix),1)):c("",!0),h("span",me,d(g.value),1),e.suffix?(u(),r("span",ve,d(e.suffix),1)):c("",!0)],34))}}),[["__scopeId","data-v-53f41e1a"]]);class ge{nStates;transitionMatrix;initialStateDistribution;emissionMeans;emissionCovariances;constructor(e){e?(this.nStates=e.nStates,this.transitionMatrix=e.transitionMatrix,this.initialStateDistribution=e.initialStateDistribution,this.emissionMeans=e.emissionMeans,this.emissionCovariances=e.emissionCovariances):(this.nStates=4,this.initializeDefault())}initializeDefault(){this.transitionMatrix=[[.85,.1,.04,.01],[.15,.7,.12,.03],[.05,.15,.65,.15],[.02,.08,.3,.6]],this.initialStateDistribution=[.4,.4,.15,.05],this.emissionMeans=[[.15,8,.8],[.08,15,.6],[-.05,35,.4],[-.2,60,.2]],this.emissionCovariances=[[[2,.3,.1],[.3,5,.2],[.1,.2,.05]],[[4,.5,.2],[.5,12,.3],[.2,.3,.08]],[[8,1.5,.4],[1.5,40,.5],[.4,.5,.12]],[[15,3,.6],[3,80,.8],[.6,.8,.15]]]}forwardBackward(e){const t=e.length,i=[],a=[],s=[];for(let n=0;n<t;n++){if(i[n]=new Array(this.nStates).fill(0),0===n)for(let a=0;a<this.nStates;a++)i[n][a]=this.initialStateDistribution[a]*this.emissionProbability(e[n],a);else for(let a=0;a<this.nStates;a++){let t=0;for(let e=0;e<this.nStates;e++)t+=i[n-1][e]*this.transitionMatrix[e][a];i[n][a]=t*this.emissionProbability(e[n],a)}const t=i[n].reduce((e,t)=>e+t,0);if(t>0)for(let e=0;e<this.nStates;e++)i[n][e]/=t}for(let n=t-1;n>=0;n--){if(a[n]=new Array(this.nStates).fill(0),n===t-1)for(let e=0;e<this.nStates;e++)a[n][e]=1;else for(let t=0;t<this.nStates;t++){let i=0;for(let s=0;s<this.nStates;s++)i+=this.transitionMatrix[t][s]*this.emissionProbability(e[n+1],s)*a[n+1][s];a[n][t]=i}const i=a[n].reduce((e,t)=>e+t,0);if(i>0)for(let e=0;e<this.nStates;e++)a[n][e]/=i}for(let n=0;n<t;n++){s[n]=new Array(this.nStates).fill(0);let e=0;for(let t=0;t<this.nStates;t++)s[n][t]=i[n][t]*a[n][t],e+=s[n][t];if(e>0)for(let t=0;t<this.nStates;t++)s[n][t]/=e}return s}viterbi(e){const t=e.length,i=[],a=[],s=[];i[0]=new Array(this.nStates).fill(0);for(let r=0;r<this.nStates;r++)i[0][r]=Math.log(this.initialStateDistribution[r]+1e-10)+Math.log(this.emissionProbability(e[0],r)+1e-10);for(let r=1;r<t;r++){i[r]=new Array(this.nStates).fill(-1/0),a[r]=new Array(this.nStates).fill(0);for(let t=0;t<this.nStates;t++){let s=-1/0,n=0;for(let e=0;e<this.nStates;e++){const a=i[r-1][e]+Math.log(this.transitionMatrix[e][t]+1e-10);a>s&&(s=a,n=e)}i[r][t]=s+Math.log(this.emissionProbability(e[r],t)+1e-10),a[r][t]=n}}let n=-1/0,o=0;for(let r=0;r<this.nStates;r++)i[t-1][r]>n&&(n=i[t-1][r],o=r);s[t-1]=o;for(let r=t-2;r>=0;r--)s[r]=a[r+1][s[r+1]];return s}emissionProbability(e,t){const i=this.emissionMeans[t],a=this.emissionCovariances[t],s=[e[0]-i[0],e[1]-i[1],e[2]-i[2]],n=this.matrixDeterminant3x3(a);if(n<=0)return 1e-10;const o=this.matrixInverse3x3(a);if(!o)return 1e-10;let r=0;for(let c=0;c<3;c++){let e=0;for(let t=0;t<3;t++)e+=o[c][t]*s[t];r+=s[c]*e}const l=Math.exp(-.5*r)/Math.sqrt(Math.pow(2*Math.PI,3)*n);return Math.max(l,1e-10)}matrixDeterminant3x3(e){const t=e[0][0],i=e[0][1],a=e[0][2],s=e[1][0],n=e[1][1],o=e[1][2],r=e[2][0],l=e[2][1],c=e[2][2];return t*(n*c-o*l)-i*(s*c-o*r)+a*(s*l-n*r)}matrixInverse3x3(e){const t=this.matrixDeterminant3x3(e);if(Math.abs(t)<1e-10)return null;const i=[],a=e[0][0],s=e[0][1],n=e[0][2],o=e[1][0],r=e[1][1],l=e[1][2],c=e[2][0],h=e[2][1],d=e[2][2];return i[0]=[(r*d-l*h)/t,(n*h-s*d)/t,(s*l-n*r)/t],i[1]=[(l*c-o*d)/t,(a*d-n*c)/t,(n*o-a*l)/t],i[2]=[(o*h-r*c)/t,(s*c-a*h)/t,(a*r-s*o)/t],i}computeStationaryDistribution(){let e=new Array(this.nStates).fill(1/this.nStates);for(let t=0;t<100;t++){const t=new Array(this.nStates).fill(0);for(let a=0;a<this.nStates;a++)for(let i=0;i<this.nStates;i++)t[a]+=e[i]*this.transitionMatrix[i][a];const i=t.reduce((e,t)=>e+t,0);if(i>0)for(let e=0;e<this.nStates;e++)t[e]/=i;e=t}return e}computeExpectedDuration(e){return 1/(1-this.transitionMatrix[e][e])}getTransitionMatrix(){return this.transitionMatrix.map(e=>[...e])}getEmissionMeans(){return this.emissionMeans.map(e=>[...e])}getEmissionCovariances(){return this.emissionCovariances.map(e=>e.map(e=>[...e]))}getNStates(){return this.nStates}setParameters(e){void 0!==e.nStates&&(this.nStates=e.nStates),e.transitionMatrix&&(this.transitionMatrix=e.transitionMatrix),e.initialStateDistribution&&(this.initialStateDistribution=e.initialStateDistribution),e.emissionMeans&&(this.emissionMeans=e.emissionMeans),e.emissionCovariances&&(this.emissionCovariances=e.emissionCovariances)}}let ye=null;class fe{scene;camera;renderer;controls;container;trajectoryLine=null;trajectoryPoints=null;trajectoryNodes=[];transitionMarkers=[];regimeEllipsoids=[];regimeCentroids=[];axesHelper=null;gridHelper=null;marketData=[];hmmModel=null;regimeConfigs=[];regimeSphereRadii=new Map;animationId=null;isAnimating=!1;autoRotate=!1;autoAnimationPlaying=!1;autoAnimationStartTime=0;autoAnimationDuration=5e3;raycaster=null;mouse=new D;hoveredObject=null;onHoverCallback=null;showTrajectory=!0;showEllipsoids=!0;showCentroids=!1;showGrid=!0;currentTimeIndex=0;showTransitionArrows=!1;transitionArrows=[];renaissanceMode=!1;selectedTimeframe="daily";nonRandomSegments=[];arbitrageZones=[];meanReversionBands=[];momentumArrows=[];signalMarkers=[];probabilityWaves=[];decodingParticles=[];portfolioHeatmap=null;comparisonOverlay=null;constructor(e){this.container=e,this.initScene(),this.initCamera(),this.initRenderer(),this.initControls(),this.initLighting(),this.initInteractivity(),this.animate()}initScene(){this.scene=new j,this.scene.background=new T(0),this.scene.fog=new I(0,.008)}initCamera(){const e=this.container.clientWidth,t=this.container.clientHeight;this.camera=new L(60,e/t,.1,1e3),this.camera.position.set(90,90,90),this.camera.lookAt(60,40,60)}initRenderer(){this.renderer=new F({antialias:!0,alpha:!0,powerPreference:"high-performance"}),this.renderer.setSize(this.container.clientWidth,this.container.clientHeight),this.renderer.setPixelRatio(Math.min(window.devicePixelRatio,2)),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=_,this.container.appendChild(this.renderer.domElement)}initControls(){this.controls=new de(this.camera,this.renderer.domElement),this.controls.enableDamping=!0,this.controls.dampingFactor=.05,this.controls.minDistance=10,this.controls.maxDistance=200,this.controls.maxPolarAngle=Math.PI,this.controls.target.set(60,40,60),this.controls.update()}initLighting(){const e=new N(16777215,.6);this.scene.add(e);const t=new V(6333946,.7);t.position.set(30,30,30),t.castShadow=!0,this.scene.add(t);const i=new V(10980346,.5);i.position.set(-30,30,-30),this.scene.add(i);const a=new V(4906624,.4);a.position.set(0,-30,0),this.scene.add(a)}initInteractivity(){this.raycaster=new H;this.renderer.domElement.addEventListener("mousemove",e=>{if(!this.renderer||!this.camera)return;const t=this.renderer.domElement.getBoundingClientRect();this.mouse.x=(e.clientX-t.left)/t.width*2-1,this.mouse.y=-(e.clientY-t.top)/t.height*2+1,this.updateHover()}),this.renderer.domElement.addEventListener("mouseout",()=>{this.hoveredObject&&(this.hoveredObject=null,this.onHoverCallback&&this.onHoverCallback(null))})}updateHover(){if(!this.raycaster||!this.camera)return;this.raycaster.setFromCamera(this.mouse,this.camera);let e=null,t=1/0;const i=[...this.trajectoryNodes];if(this.regimeEllipsoids.forEach(e=>{e.children.forEach(e=>{e instanceof O&&e.userData.point&&!i.includes(e)&&i.push(e)})}),i.length>0){const a=this.raycaster.intersectObjects(i,!1);a.length>0&&a[0].distance<t&&(e=a[0].object,t=a[0].distance)}if(this.regimeCentroids.length>0){const i=this.raycaster.intersectObjects(this.regimeCentroids,!1);i.length>0&&i[0].distance<t&&(e=i[0].object,t=i[0].distance)}if(!e||t>5){const i=[];if(this.regimeEllipsoids.forEach(e=>{e.children.forEach(e=>{e instanceof O&&!(e instanceof ee)&&i.push(e)})}),i.length>0){const a=this.raycaster.intersectObjects(i,!1);a.length>0&&!e&&(e=a[0].object,t=a[0].distance)}}if(e){if(this.hoveredObject!==e){this.hoveredObject=e;const t=this.getHoverInfo(e);this.onHoverCallback&&this.onHoverCallback(t)}}else this.hoveredObject&&(this.hoveredObject=null,this.onHoverCallback&&this.onHoverCallback(null))}getHoverInfo(e){for(const t of this.trajectoryNodes)if(t===e)return this.createTrajectoryNodeInfo(t);for(const t of this.regimeEllipsoids)for(const i of t.children)if(i===e&&i instanceof O&&i.userData.point)return this.createTrajectoryNodeInfo(i);for(const t of this.regimeCentroids)if(t===e||t.parent&&t.parent.children.includes(e)){const e=t.userData.config;if(e&&this.hmmModel){const i=this.hmmModel.getEmissionMeans()[e.id];return{type:"centroid",title:`Ядро режима: ${e.name}`,data:{"Режим":e.name,"Доходность (mean)":i&&void 0!==i[0]?(100*i[0]).toFixed(2)+"%":"N/A","Волатильность (mean)":i&&void 0!==i[1]?i[1].toFixed(2)+"%":"N/A","Ликвидность (mean)":i&&void 0!==i[2]?i[2].toFixed(3):"N/A",X:t.position.x.toFixed(2),Y:t.position.y.toFixed(2),Z:t.position.z.toFixed(2)},position:[t.position.x,t.position.y,t.position.z]}}}for(let t=0;t<this.regimeEllipsoids.length;t++){const i=this.regimeEllipsoids[t];let a=!1,s=null;if(i===e)a=!0,s=i.children.find(e=>e instanceof O)||i;else for(const t of i.children)if(t===e){a=!0,s=t;break}if(a&&s){const e=i.userData?.regimeId??t,a=i.userData?.config||this.regimeConfigs.find(t=>t.id===e);if(a&&this.hmmModel){const e=this.hmmModel.getEmissionMeans()[a.id],t=this.regimeSphereRadii.get(a.id)||0,n=s.position.clone();return 0===n.lengthSq()&&i.children[0]&&n.copy(i.children[0].position),{type:"ellipsoid",title:`Сфера режима: ${a.name}`,data:{"Режим":a.name,"Радиус сферы":t.toFixed(2),"Доходность (mean)":e&&void 0!==e[0]?(100*e[0]).toFixed(2)+"%":"N/A","Волатильность (mean)":e&&void 0!==e[1]?e[1].toFixed(2)+"%":"N/A","Ликвидность (mean)":e&&void 0!==e[2]?e[2].toFixed(3):"N/A","Позиция X":n.x.toFixed(2),"Позиция Y":n.y.toFixed(2),"Позиция Z":n.z.toFixed(2),"Наблюдений в режиме":String(this.marketData.filter(e=>(e.regime||0)===a.id).length)},position:[n.x,n.y,n.z]}}}}return null}createTrajectoryNodeInfo(e){const t=e.userData,i=t.point;return i?{type:"trajectory-node",title:`Наблюдение #${t.timeIndex??"N/A"}`,data:{"Индекс":String(t.timeIndex??0),"Режим ID":String(t.regimeId??0),"Дата":i.date||"N/A","Доходность":void 0!==i.return?(100*i.return).toFixed(2)+"%":"N/A","Волатильность":void 0!==i.volatility?i.volatility.toFixed(2)+"%":"N/A","Ликвидность":void 0!==i.liquidity?i.liquidity.toFixed(3):"N/A","Режим":this.getRegimeName(t.regimeId??0),X:e.position.x.toFixed(2),Y:e.position.y.toFixed(2),Z:e.position.z.toFixed(2),point:i},position:[e.position.x,e.position.y,e.position.z]}:null}getRegimeName(e){const t=this.regimeConfigs.find(t=>t.id===e);return t?t.name:`Режим ${e}`}setOnHover(e){this.onHoverCallback=e}setData(e,t,i){console.log("RegimeSpaceRenderer.setData called:",{marketDataLength:e.length,hmmModelExists:!!t,regimeConfigsLength:i.length,showTrajectory:this.showTrajectory,samplePoint:e.length>0?e[0]:null}),this.marketData=e,this.hmmModel=t,this.regimeConfigs=i,this.currentTimeIndex=e.length-1,this.updateVisualization(),console.log("After updateVisualization:",{trajectoryNodesCount:this.trajectoryNodes.length,trajectoryLineExists:!!this.trajectoryLine,regimeEllipsoidsCount:this.regimeEllipsoids.length})}updateVisualization(){this.clearScene(),this.createAxes(),this.createGrid(),this.createRegimeEllipsoids(),this.createRegimeCentroids(),this.createTrajectory(),this.showTransitionArrows&&this.createTransitionArrows()}clearScene(){this.trajectoryLine&&this.scene.remove(this.trajectoryLine),this.trajectoryPoints&&this.scene.remove(this.trajectoryPoints),this.trajectoryNodes.forEach(e=>this.scene.remove(e)),this.transitionMarkers.forEach(e=>this.scene.remove(e)),this.axesHelper&&this.scene.remove(this.axesHelper),this.gridHelper&&this.scene.remove(this.gridHelper),this.regimeEllipsoids.forEach(e=>this.scene.remove(e)),this.regimeCentroids.forEach(e=>{e.parent&&this.scene.remove(e.parent)}),this.transitionArrows.forEach(e=>this.scene.remove(e)),this.clearRenaissanceOverlays(),this.regimeEllipsoids=[],this.regimeCentroids=[],this.transitionArrows=[],this.transitionMarkers=[]}getRegimeXPosition(e){if(!this.hmmModel)return 0;const t=this.hmmModel.getEmissionMeans();if(!t||!Array.isArray(t))return 0;const i=[];if(t.forEach((e,t)=>{if(e&&Array.isArray(e)&&e.length>=3){const a=void 0!==e[1]?e[1]:0;i.push({id:t,volatility:a})}}),0===i.length)return 0;i.sort((e,t)=>e.volatility-t.volatility);let a=i.map(e=>e.id).indexOf(e);3===i.length&&2===a?a=1:3===i.length&&1===a&&(a=2);return 15+a*(i.length>1?85/(i.length-1):0)}getRegimeZPosition(e){if(!this.hmmModel)return 0;const t=this.hmmModel.getEmissionMeans();if(!t||!Array.isArray(t))return 0;const i=[];if(t.forEach((e,t)=>{if(e&&Array.isArray(e)&&e.length>=3){const a=void 0!==e[1]?e[1]:0;i.push({id:t,volatility:a})}}),0===i.length)return 0;i.sort((e,t)=>e.volatility-t.volatility);let a=i.map(e=>e.id).indexOf(e);3===i.length&&2===a?a=1:3===i.length&&1===a&&(a=2);return 15+a*(i.length>1?85/(i.length-1):0)}getRegimePosition(e){if(!this.hmmModel)return new q(0,0,0);const t=this.hmmModel.getEmissionMeans();if(!t||!t[e]||!Array.isArray(t[e]))return new q(0,0,0);const i=t[e],a=this.getRegimeZPosition(e),s=Math.max(0,void 0!==i[1]?i[1]:0),n=this.getRegimeXPosition(e);return new q(a,s,n)}getRegimeColorByVolatility(e){return e<15?"#60a5fa":e<=30?"#fb923c":"#ef4444"}createTransitionArrows(){if(!this.hmmModel||0===this.marketData.length)return;const e=this.marketData[this.currentTimeIndex];if(!e||void 0===e.regime)return;const t=this.hmmModel.getTransitionMatrix(),i=e.regime;if(!this.regimeConfigs.find(e=>e.id===i))return;const a=this.getRegimePosition(i);t[i].forEach((e,t)=>{if(t===i||e<.1)return;const s=this.regimeConfigs.find(e=>e.id===t);if(!s)return;const n=this.getRegimePosition(t),o=new q;o.subVectors(n,a);const r=o.length();if(r<5)return;o.normalize();const l=e,c=new T(s.color),h=new z(o,a,.8*r,c.getHex(),2,1),d=h.line.material;d.opacity=l,d.transparent=!0,this.transitionArrows.push(h),this.scene.add(h)})}createAxes(){this.axesHelper=new B,this.scene.add(this.axesHelper)}addAxisLabel(e,t,i,a){const s=document.createElement("canvas");s.width=512,s.height=256;const n=s.getContext("2d");n.fillStyle=`#${i.toString(16).padStart(6,"0")}`,n.font="bold 48px Arial",n.textAlign="center",n.textBaseline="middle",n.fillText(e,256,128);const o=new $(s);o.needsUpdate=!0;const r=new U({map:o}),l=new X(r);l.scale.set(8,4,1),l.position.copy(t),a.add(l)}createGrid(){if(!this.showGrid)return;const e=new B,t=new Z({color:16777215,opacity:1,transparent:!1}),i=new Z({color:16777215,opacity:.7,transparent:!0}),a=120;for(let r=0;r<=24;r++){const s=5*r,n=new W,o=new Float32Array([0,0,s,a,0,s]);n.setAttribute("position",new Y(o,3));const l=new G(n,r%4==0?t:i);e.add(l)}for(let r=0;r<=24;r++){const s=5*r,n=new W,o=new Float32Array([s,0,0,s,0,a]);n.setAttribute("position",new Y(o,3));const l=new G(n,r%4==0?t:i);e.add(l)}for(let r=0;r<=24;r++){const a=5*r,s=new W,n=new Float32Array([0,0,a,0,80,a]);s.setAttribute("position",new Y(n,3));const o=new G(s,r%4==0?t:i);e.add(o)}for(let r=0;r<=16;r++){const s=5*r,n=new W,o=new Float32Array([0,s,0,0,s,a]);n.setAttribute("position",new Y(o,3));const l=new G(n,r%4==0?t:i);e.add(l)}const s=this.createAxisLabelAtEnd("Return",new q(a,5,10),6333946);s&&e.add(s);const n=this.createAxisLabelAtEnd("Volatility",new q(5,80,10),10980346);n&&e.add(n);const o=this.createAxisLabelAtEnd("Liquidity",new q(10,5,a),4906624);o&&e.add(o),this.gridHelper=e,this.scene.add(e)}createLongAxisLabel(e,t,i,a){try{const s=new B,n=i.length(),o=i.clone().normalize(),r=t.clone().add(o.clone().multiplyScalar(n/2)),l=document.createElement("canvas");l.width=8192,l.height=2048;const c=l.getContext("2d");if(!c)return null;c.fillStyle=`#${a.toString(16).padStart(6,"0")}`,c.font="bold 200px Arial",c.textAlign="center",c.textBaseline="middle",c.fillText(e,l.width/2,l.height/2);const h=new $(l);h.needsUpdate=!0;const d=new U({map:h,transparent:!0,alphaTest:.1}),u=new X(d);if(u.scale.set(.9*n,25,1),u.position.copy(r),0===o.y&&(u.position.y+=2),0!==o.x||0!==o.z){const e=Math.atan2(o.x,o.z);u.rotation.y=e}else 0!==o.y&&(u.rotation.x=Math.PI/2);return s.add(u),s}catch(s){return console.error("Error creating long axis label:",s),null}}createAxisLabelAtEnd(e,t,i){try{const a=document.createElement("canvas");a.width=2048,a.height=512;const s=a.getContext("2d");if(!s)return null;s.fillStyle=`#${i.toString(16).padStart(6,"0")}`,s.font="bold 120px Arial",s.textAlign="center",s.textBaseline="middle",s.fillText(e,a.width/2,a.height/2);const n=new $(a);n.needsUpdate=!0;const o=new U({map:n,transparent:!0,alphaTest:.1}),r=new X(o);return r.scale.set(20,5,1),r.position.copy(t),r}catch(a){return console.error("Error creating axis label at end:",a),null}}createGridLabel(e,t,i,a=!1,s=!1){try{const n=document.createElement("canvas");n.width=a?1024:s?512:256,n.height=a?512:s?256:128;const o=n.getContext("2d");if(!o)return null;o.fillStyle=`#${i.toString(16).padStart(6,"0")}`,o.font=a?"bold 48px Arial":s?"bold 36px Arial":"bold 20px Arial",o.textAlign="center",o.textBaseline="middle",o.fillText(e,n.width/2,n.height/2);const r=new $(n);r.needsUpdate=!0;const l=new U({map:r,transparent:!0,alphaTest:.1}),c=new X(l);return a?c.scale.set(16,8,1):s?c.scale.set(8,4,1):c.scale.set(4,2,1),c.position.copy(t),c}catch(n){return console.error("Error creating grid label:",n),null}}calculateSphereRadii(){if(!this.hmmModel)return;this.regimeSphereRadii.clear();this.hmmModel.getEmissionCovariances().forEach((e,t)=>{if(!e||!Array.isArray(e)||e.length<3)return;if(!e[0]||!e[1]||!e[2])return;const i=void 0!==e[0][0]?e[0][0]:1,a=void 0!==e[1][1]?e[1][1]:1,s=void 0!==e[2][2]?e[2][2]:1,n=4.5*((Math.sqrt(Math.max(0,i))+Math.sqrt(Math.max(0,a))+Math.sqrt(Math.max(0,s)))/3);this.regimeSphereRadii.set(t,n)})}createRegimeEllipsoids(){if(!this.hmmModel)return;if(this.calculateSphereRadii(),!this.showEllipsoids)return;const e=this.hmmModel.getEmissionMeans(),t=this.hmmModel.getEmissionCovariances();e.forEach((e,i)=>{const a=this.regimeConfigs.find(e=>e.id===i);if(!a)return;if(!e||!Array.isArray(e)||e.length<3)return;const s=t[i];if(!s||!Array.isArray(s)||s.length<3)return;if(!s[0]||!Array.isArray(s[0])||s[0].length<3)return;if(!s[1]||!Array.isArray(s[1])||s[1].length<3)return;if(!s[2]||!Array.isArray(s[2])||s[2].length<3)return;const n=void 0!==e[1]?e[1]:0,o=this.getRegimeColorByVolatility(n),r=new Q(1,32,32),l=new J({color:new T(o),transparent:!0,opacity:.5,side:K,emissive:new T(o),emissiveIntensity:.5}),c=new O(r,l),h=void 0!==s[0][0]?s[0][0]:1,d=void 0!==s[1][1]?s[1][1]:1,u=void 0!==s[2][2]?s[2][2]:1,m=(Math.sqrt(Math.max(0,h))+Math.sqrt(Math.max(0,d))+Math.sqrt(Math.max(0,u)))/3,v=this.regimeSphereRadii.get(i)||4.5*m;c.scale.set(v,v,v);const p=this.getRegimeZPosition(i),g=Math.max(0,void 0!==e[1]?e[1]:0),y=this.getRegimeXPosition(i);c.position.set(p,g,y);const f=new ee(new te(r),new Z({color:new T(o),opacity:.7,transparent:!0}));f.scale.copy(c.scale),f.position.copy(c.position);const w=new q(p,g+v+3,y),x=this.createRegimeLabel(a.name,w,o),b=[];if(this.marketData.length>0){const e=this.marketData.filter(e=>(e.regime||0)===i),t=50,a=Math.max(1,Math.floor(e.length/t));e.forEach((s,n)=>{if(n%a!==0&&e.length>t)return;if(void 0===s.return||void 0===s.volatility||void 0===s.liquidity)return;const o=.6*v;let r=2*(s.liquidity-.5),l=2*(s.volatility/60-.5),c=2.5*s.return;const h=Math.sqrt(r*r+l*l+c*c);if(h>0){const e=Math.min(1,1/h)*o;r*=e,l*=e,c*=e}const d=Math.max(5,Math.min(115,p+r)),u=Math.max(5,Math.min(75,g+l)),m=Math.max(5,Math.min(115,y+c)),f=s.regime||i;if(this.regimeConfigs.find(e=>e.id===f)&&this.hmmModel){const e=this.hmmModel.getEmissionMeans();if(e&&e[f]&&Array.isArray(e[f])){const t=void 0!==e[f][1]?e[f][1]:s.volatility;this.getRegimeColorByVolatility(t)}}const w=new Q(.8,12,12),x=new J({color:new T(16777215),emissive:new T(16777215),emissiveIntensity:.6,transparent:!0,opacity:1,shininess:100}),M=new O(w,x);M.position.set(d,u,m),M.userData={regimeId:f,point:s,timeIndex:n},b.push(M)})}const M=new B;M.userData={regimeId:i,config:a},M.add(c),M.add(f),x&&M.add(x),b.forEach(e=>M.add(e)),this.regimeEllipsoids.push(M),this.scene.add(M)})}createRegimeLabel(e,t,i){try{const a=document.createElement("canvas");a.width=512,a.height=256;const s=a.getContext("2d");if(!s)return null;s.fillStyle=i,s.font="bold 36px Arial",s.textAlign="center",s.textBaseline="middle",s.fillText(e,256,128);const n=new $(a);n.needsUpdate=!0;const o=new U({map:n,transparent:!0,alphaTest:.1}),r=new X(o);return r.scale.set(8,4,1),r.position.copy(t),r}catch(a){return console.error("Error creating regime label:",a),null}}createRegimeCentroids(){if(!this.showCentroids||!this.hmmModel)return;console.log("createRegimeCentroids called, showCentroids:",this.showCentroids);this.hmmModel.getEmissionMeans().forEach((e,t)=>{const i=this.regimeConfigs.find(e=>e.id===t);if(!i)return;if(!e||!Array.isArray(e)||e.length<3)return;const a=void 0!==e[1]?e[1]:0,s=this.getRegimeColorByVolatility(a),n=this.regimeSphereRadii.get(t)||10,o=Math.max(3,.25*n),r=Math.max(5,.4*n);console.log("Creating centroid for regime",t,"sphereRadius:",n,"coreRadius:",o);const l=new Q(o,24,24),c=new J({color:new T(16777215),emissive:new T(s),emissiveIntensity:1.5,transparent:!0,opacity:1,shininess:200,depthTest:!1}),h=new O(l,c);h.renderOrder=100;const d=this.getRegimeZPosition(t),u=Math.max(0,void 0!==e[1]?e[1]:0),m=this.getRegimeXPosition(t);h.position.set(d,u,m),h.userData={regimeId:t,config:i,pulsePhase:Math.random()*Math.PI*2,baseRadius:o};const v=new Q(r,24,24),p=new ie({color:new T(s),transparent:!0,opacity:.4,depthTest:!1}),g=new O(v,p);g.renderOrder=99,g.position.copy(h.position),g.userData={baseScale:1,baseOpacity:.3,pulsePhase:Math.random()*Math.PI*2,baseRadius:r};const y=new B;y.add(h),y.add(g),this.regimeCentroids.push(h),this.scene.add(y)})}createTrajectory(){if(console.log("createTrajectory called, marketData.length:",this.marketData.length,"showTrajectory:",this.showTrajectory),0===this.marketData.length)return;const e=[],t=[];if(this.marketData.forEach((i,a)=>{if(void 0===i.return||void 0===i.volatility||void 0===i.liquidity)return;const s=i.regime||0,n=this.getRegimeZPosition(s),o=this.getRegimeXPosition(s);let r=15;if(this.hmmModel){const e=this.hmmModel.getEmissionMeans();e&&e[s]&&void 0!==e[s][1]&&(r=e[s][1])}const l=.6*(this.regimeSphereRadii.get(s)||10);let c=2*(i.liquidity-.5),h=2*(i.volatility/60-.5),d=2.5*i.return;const u=Math.sqrt(c*c+h*h+d*d);if(u>0){const e=Math.min(1,1/u)*l;c*=e,h*=e,d*=e}const m=Math.max(5,Math.min(115,n+c)),v=Math.max(5,Math.min(75,r+h)),p=Math.max(5,Math.min(115,o+d));e.push(new q(m,v,p));let g=i.volatility;if(this.hmmModel){const e=this.hmmModel.getEmissionMeans();e&&e[s]&&Array.isArray(e[s])&&void 0!==e[s][1]&&(g=e[s][1])}const y=this.getRegimeColorByVolatility(g),f=new T(y);t.push(f)}),console.log("Trajectory points created:",e.length,"showTrajectory:",this.showTrajectory),e.length>0&&console.log("Sample point coordinates:",e[0],e[e.length-1]),this.showTrajectory&&e.length>1){if(e.length<2)return;const i=new ae(e,!1,"centripetal"),a=i.getPoints(Math.max(100,15*e.length)),s=[];for(let l=0;l<a.length;l++){const i=l/(a.length-1),n=Math.min(Math.floor(i*(e.length-1)),e.length-2),o=Math.min(n+1,e.length-1),r=i*(e.length-1)-n,c=t[n],h=t[o],d=(new T).lerpColors(c,h,r);s.push(d.r,d.g,d.b)}const n=new W,o=new Float32Array(3*a.length);a.forEach((e,t)=>{o[3*t]=e.x,o[3*t+1]=e.y,o[3*t+2]=e.z}),n.setAttribute("position",new Y(o,3)),n.setAttribute("color",new se(s,3));const r=new Z({vertexColors:!0,transparent:!0,opacity:.9,linewidth:3});this.trajectoryLine=new G(n,r),this.scene.add(this.trajectoryLine),this.createTransitionMarkers(i,e)}this.trajectoryNodes=[],this.showTrajectory&&e.length>1&&(this.marketData.forEach((e,t)=>{if(void 0===e.return||void 0===e.volatility||void 0===e.liquidity)return;const i=e.regime||0,a=this.getRegimeZPosition(i),s=this.getRegimeXPosition(i);let n=15;if(this.hmmModel){const e=this.hmmModel.getEmissionMeans();e&&e[i]&&void 0!==e[i][1]&&(n=e[i][1])}const o=.6*(this.regimeSphereRadii.get(i)||10);let r=2*(e.liquidity-.5),l=2*(e.volatility/60-.5),c=2.5*e.return;const h=Math.sqrt(r*r+l*l+c*c);if(h>0){const e=Math.min(1,1/h)*o;r*=e,l*=e,c*=e}const d=Math.max(5,Math.min(115,a+r)),u=Math.max(5,Math.min(75,n+l)),m=Math.max(5,Math.min(115,s+c)),v=new Q(.6,12,12),p=new J({color:new T(16777215),emissive:new T(16777215),emissiveIntensity:.6,transparent:!0,opacity:1,shininess:100}),g=new O(v,p);g.position.set(d,u,m),g.userData={timeIndex:t,point:e,regimeId:e.regime||0},g.visible=!0,this.trajectoryNodes.push(g),this.scene.add(g)}),console.log("Trajectory nodes created:",this.trajectoryNodes.length)),this.currentTimeIndex=this.marketData.length-1,console.log("createTrajectory finished:",{trajectoryLineExists:!!this.trajectoryLine,trajectoryNodesCount:this.trajectoryNodes.length})}startAutoAnimation(){0===this.trajectoryNodes.length||this.autoAnimationPlaying||(this.autoAnimationPlaying=!0,this.autoAnimationStartTime=Date.now(),this.currentTimeIndex=0,this.trajectoryNodes.forEach(e=>{e.visible=!1}),this.trajectoryLine&&(this.scene.remove(this.trajectoryLine),this.trajectoryLine=null))}updateAutoAnimation(){if(!this.autoAnimationPlaying||0===this.trajectoryNodes.length)return;const e=Date.now()-this.autoAnimationStartTime,t=Math.min(1,e/this.autoAnimationDuration),i=this.trajectoryNodes.length,a=Math.min(i-1,Math.floor(t*i));this.trajectoryNodes.forEach((e,t)=>{const i=t<=a;if(e.visible=i,i&&e.material instanceof J)if(t===a){const t=.3*Math.sin(.01*Date.now())+.7;e.material.emissiveIntensity=.8+.4*t,e.scale.setScalar(1+.3*t)}else e.material.emissiveIntensity=.6,e.scale.setScalar(1)});const s=Math.min(this.marketData.length-1,a);s!==this.currentTimeIndex&&(this.currentTimeIndex=s,a>0&&this.createTrajectoryLine()),(t>=1||a>=i-1)&&(this.autoAnimationPlaying=!1,this.trajectoryNodes.forEach(e=>{e.visible=!0,e.material instanceof J&&(e.material.emissiveIntensity=.6,e.scale.setScalar(1))}),this.currentTimeIndex=this.marketData.length-1,this.createTrajectoryLine())}createTransitionMarkers(e,t){if(this.marketData.length<2||t.length<2)return;this.transitionMarkers=[];const i=this.marketData.slice(0,this.currentTimeIndex+1);for(let a=1;a<i.length;a++){const s=i[a-1],n=i[a],o=s.regime||0,r=n.regime||0;if(o!==r){const i=(Math.max(0,Math.min(1,(a-1)/Math.max(1,t.length-1)))+Math.max(0,Math.min(1,a/Math.max(1,t.length-1))))/2,l=e.getPoint(i);if(!l||void 0===l.x||void 0===l.y||void 0===l.z)continue;let c=s.volatility,h=n.volatility;if(this.hmmModel){const e=this.hmmModel.getEmissionMeans();e[o]&&e[o][1]&&(c=e[o][1]),e[r]&&e[r][1]&&(h=e[r][1])}this.getRegimeColorByVolatility(c),this.getRegimeColorByVolatility(h);const d=new Q(.6,16,16),u=new J({color:16777215,emissive:16766720,emissiveIntensity:.8,transparent:!0,opacity:.9,shininess:100}),m=new O(d,u);m.position.copy(l);const v=new Q(.9,16,16),p=new ie({color:16766720,transparent:!0,opacity:.3}),g=new O(v,p);g.position.copy(l);const y=new B;y.add(m),y.add(g),y.userData={fromRegime:o,toRegime:r,timeIndex:a,transitionPoint:l},this.transitionMarkers.push(y),this.scene.add(y)}}}setTimeIndex(e){this.currentTimeIndex=Math.max(0,Math.min(e,this.marketData.length-1)),this.updateTrajectory()}updateTrajectory(){if(this.autoAnimationPlaying)return this.trajectoryLine&&(this.scene.remove(this.trajectoryLine),this.trajectoryLine=null),void this.createTrajectoryLine();this.trajectoryLine&&this.scene.remove(this.trajectoryLine),this.trajectoryPoints&&this.scene.remove(this.trajectoryPoints),this.trajectoryNodes.forEach(e=>this.scene.remove(e)),this.transitionMarkers.forEach(e=>this.scene.remove(e)),this.trajectoryNodes=[],this.transitionMarkers=[],this.createTrajectory(),this.showTransitionArrows&&(this.transitionArrows.forEach(e=>this.scene.remove(e)),this.transitionArrows=[],this.createTransitionArrows())}createTrajectoryLine(){if(0===this.marketData.length||!this.showTrajectory)return;const e=[],t=[];if(this.marketData.forEach((i,a)=>{if(void 0===i.return||void 0===i.volatility||void 0===i.liquidity)return;const s=i.regime||0,n=this.getRegimeZPosition(s),o=this.getRegimeXPosition(s);let r=15;if(this.hmmModel){const e=this.hmmModel.getEmissionMeans();e&&e[s]&&void 0!==e[s][1]&&(r=e[s][1])}const l=.6*(this.regimeSphereRadii.get(s)||10);let c=2*(i.liquidity-.5),h=2*(i.volatility/60-.5),d=2.5*i.return;const u=Math.sqrt(c*c+h*h+d*d);if(u>0){const e=Math.min(1,1/u)*l;c*=e,h*=e,d*=e}const m=Math.max(5,Math.min(115,n+c)),v=Math.max(5,Math.min(75,r+h)),p=Math.max(5,Math.min(115,o+d));e.push(new q(m,v,p));const g=this.getRegimeColorByVolatility(i.volatility);t.push(new T(g))}),e.length<2)return;const i=new ae(e,!1,"centripetal").getPoints(Math.max(100,15*e.length)),a=[];for(let r=0;r<i.length;r++){const s=r/(i.length-1),n=Math.min(Math.floor(s*(e.length-1)),e.length-2),o=Math.min(n+1,e.length-1),l=s*(e.length-1)-n,c=t[n],h=t[o],d=(new T).lerpColors(c,h,l);a.push(d.r,d.g,d.b)}const s=new W,n=new Float32Array(3*i.length);i.forEach((e,t)=>{n[3*t]=e.x,n[3*t+1]=e.y,n[3*t+2]=e.z}),s.setAttribute("position",new Y(n,3)),s.setAttribute("color",new se(a,3));const o=new Z({vertexColors:!0,transparent:!0,opacity:.9,linewidth:3});this.trajectoryLine=new G(s,o),this.scene.add(this.trajectoryLine)}setShowTransitionArrows(e){this.showTransitionArrows=e,e?this.createTransitionArrows():(this.transitionArrows.forEach(e=>this.scene.remove(e)),this.transitionArrows=[])}setShowTrajectory(e){this.showTrajectory=e,this.updateVisualization()}setShowEllipsoids(e){this.showEllipsoids=e,this.updateVisualization()}setShowCentroids(e){this.showCentroids=e,this.updateVisualization()}setShowGrid(e){this.showGrid=e,this.gridHelper&&(e?this.scene.add(this.gridHelper):this.scene.remove(this.gridHelper))}async setCameraPreset(e){const i=await async function(){return"undefined"==typeof window?null:ye||(ye=t(()=>import("./index-Ba4DjugF.js").then(e=>e.k),__vite__mapDeps([0,1,2])).then(e=>e.gsap),ye)}();if(!i)return this.camera.position.set(...e.position),this.controls.target.set(...e.target),void this.controls.update();i.to(this.camera.position,{duration:1.2,x:e.position[0],y:e.position[1],z:e.position[2],ease:"power2.out",onUpdate:()=>{this.controls.target.set(...e.target),this.controls.update()}})}setAutoRotate(e){this.autoRotate=e,this.controls.autoRotate=e,this.controls.autoRotateSpeed=1}animate(){this.animationId=requestAnimationFrame(()=>this.animate()),this.controls&&this.controls.update(),this.raycaster&&this.updateHover(),this.autoAnimationPlaying&&this.updateAutoAnimation(),this.autoRotate;const e=.001*Date.now();this.regimeCentroids.forEach((t,i)=>{if(!t||!t.parent)return;if(void 0!==t.userData.pulsePhase){const i=.3*Math.sin(3*e+t.userData.pulsePhase)+1;if(t.scale.setScalar(i),t.material instanceof J){const i=.8+.5*Math.sin(4*e+t.userData.pulsePhase);t.material.emissiveIntensity=i,t.material.opacity=.8+.15*Math.sin(3*e+t.userData.pulsePhase)}}const a=t.parent.children.find(e=>e!==t&&"Mesh"===e.type);if(a&&void 0!==a.userData.pulsePhase){const t=.5*Math.sin(2.5*e+a.userData.pulsePhase+Math.PI/4)+1,i=a.userData.baseScale||1;if(a.scale.setScalar(i*t),a.material instanceof ie){const t=a.userData.baseOpacity||.3,i=.15*Math.sin(2.5*e+a.userData.pulsePhase)+t;a.material.opacity=Math.max(.15,Math.min(.6,i))}}}),this.renaissanceMode&&(this.arbitrageZones.forEach((e,t)=>{const i=.2*Math.sin(.002*Date.now()+t)+1;e.scale.setScalar(i)}),this.probabilityWaves.forEach(e=>{e.children.forEach((e,t)=>{if(e instanceof O&&e.material instanceof ie){const i=(e.userData.baseOpacity||.3)*(.5+.5*Math.sin(.001*Date.now()+t));e.material.opacity=i}})}),this.decodingParticles.forEach(e=>{if(e.userData.velocity){const t=e.geometry.attributes.position.array,i=e.userData.velocity;for(let e=0;e<t.length;e+=3)t[e+1]-=i[e/3],t[e+1]<-50&&(t[e+1]=50);e.geometry.attributes.position.needsUpdate=!0}}),this.meanReversionBands.forEach((e,t)=>{e.rotation&&(e.rotation.z+=.01*(t%2==0?1:-1))})),this.renderer.render(this.scene,this.camera)}resize(e,t){this.camera.aspect=e/t,this.camera.updateProjectionMatrix(),this.renderer.setSize(e,t)}dispose(){this.animationId&&cancelAnimationFrame(this.animationId),this.clearScene(),this.renderer&&this.renderer.dispose(),this.container&&this.renderer?.domElement&&this.container.removeChild(this.renderer.domElement)}exportScreenshot(e="regime-space.png"){this.renderer.render(this.scene,this.camera);const t=this.renderer.domElement.toDataURL("image/png"),i=document.createElement("a");i.href=t,i.download=e,i.click()}setRenaissanceMode(e,t,i,a){this.renaissanceMode=e,e?this.createRenaissanceOverlays(t,i,a):this.clearRenaissanceOverlays()}setTimeframe(e){this.selectedTimeframe=e,this.renaissanceMode&&this.marketData.length>0&&this.hmmModel&&(this.clearRenaissanceOverlays(),this.createRenaissanceOverlays(this.marketData,this.hmmModel,this.regimeConfigs))}createRenaissanceOverlays(e,t,i){this.createNonRandomPatterns(e,i),this.createArbitrageZones(e,t,i),this.createMeanReversionBands(e,t,i),this.createMomentumArrows(e,i),this.createSignalMarkers(e,t,i),this.createProbabilityWaves(t,i),this.createDecodingEffect(e),this.createPortfolioHeatmap(e,t,i),this.createComparisonOverlay(e)}clearRenaissanceOverlays(){this.nonRandomSegments.forEach(e=>this.scene.remove(e)),this.arbitrageZones.forEach(e=>this.scene.remove(e)),this.meanReversionBands.forEach(e=>this.scene.remove(e)),this.momentumArrows.forEach(e=>this.scene.remove(e)),this.signalMarkers.forEach(e=>this.scene.remove(e)),this.probabilityWaves.forEach(e=>this.scene.remove(e)),this.decodingParticles.forEach(e=>this.scene.remove(e)),this.portfolioHeatmap&&this.scene.remove(this.portfolioHeatmap),this.comparisonOverlay&&this.scene.remove(this.comparisonOverlay),this.nonRandomSegments=[],this.arbitrageZones=[],this.meanReversionBands=[],this.momentumArrows=[],this.signalMarkers=[],this.probabilityWaves=[],this.decodingParticles=[],this.portfolioHeatmap=null,this.comparisonOverlay=null}createNonRandomPatterns(e,t){for(let i=0;i<e.length-10;i++){const t=e.slice(i,i+10),a=this.calculateRegimeStability(t),s=this.calculatePredictability(t);if(a>.8&&s>.7){const e=[];if(t.forEach((t,i)=>{if(void 0===t.return||void 0===t.volatility||void 0===t.liquidity)return;const a=Math.max(0,35*t.liquidity),s=Math.max(0,t.volatility),n=Math.max(0,t.return);e.push(new q(a,s,n))}),e.length<2)return;const i=(new W).setFromPoints(e),a=new Z({color:16776960,linewidth:4,transparent:!0,opacity:.8}),s=new G(i,a),n=new B;n.add(s);const o=(new W).setFromPoints(e),r=new Z({color:16776960,linewidth:6,transparent:!0,opacity:.3}),l=new G(o,r);n.add(l),this.nonRandomSegments.push(n),this.scene.add(n)}}}createArbitrageZones(e,t,i){const a=t.getEmissionMeans(),s=t.getTransitionMatrix();a.forEach((e,t)=>{if(!i.find(e=>e.id===t))return;const a=e[1]||0,n=this.getRegimeColorByVolatility(a);if(Math.max(...s[t].filter((e,i)=>i!==t))>.3){const i=new Q(5,16,16),a=new ie({color:new T(n),transparent:!0,opacity:.2,wireframe:!0}),s=new O(i,a),o=this.getRegimeZPosition(t),r=Math.max(0,void 0!==e[1]?e[1]:0),l=this.getRegimeXPosition(t);s.position.set(o,r,l),s.userData={pulse:0},this.arbitrageZones.push(s),this.scene.add(s)}})}createMeanReversionBands(e,t,i){const a=t.getEmissionMeans();for(let s=0;s<a.length;s++)for(let e=s+1;e<a.length;e++){const t=this.getRegimeZPosition(s),i=Math.max(0,void 0!==a[s][1]?a[s][1]:0),n=this.getRegimeXPosition(s),o=new q(t,i,n),r=this.getRegimeZPosition(e),l=Math.max(0,void 0!==a[e][1]?a[e][1]:0),c=this.getRegimeXPosition(e),h=new q(r,l,c),d=(new q).addVectors(o,h).multiplyScalar(.5);(new q).subVectors(h,o).normalize();const u=new ne(.5,.5,o.distanceTo(h),8),m=new ie({color:16777215,transparent:!0,opacity:.15,wireframe:!0}),v=new O(u,m);v.position.copy(d),v.lookAt(h),v.rotateX(Math.PI/2),this.meanReversionBands.push(v),this.scene.add(v)}}createMomentumArrows(e,t){for(let i=5;i<e.length;i++){const t=e.slice(i-5,i),a=t.reduce((e,t)=>e+t.return,0)/5,s=t.reduce((e,t)=>e+t.volatility,0)/5;if(Math.abs(a)>.1&&s<20){const t=e[i],s=e[i-5];if(void 0===t.return||void 0===t.volatility||void 0===t.liquidity)continue;if(void 0===s.return||void 0===s.volatility||void 0===s.liquidity)continue;const n=Math.max(0,35*t.liquidity),o=Math.max(0,t.volatility),r=Math.max(0,t.return),l=Math.max(0,35*s.liquidity),c=Math.max(0,s.volatility),h=Math.max(0,s.return),d=new q(n-l,o-c,r-h).normalize(),u=new q(n,o,r),m=new z(d,u,3,a>0?4906624:16281969,1.5,.8);this.momentumArrows.push(m),this.scene.add(m)}}}createSignalMarkers(e,t,i){const a=t.getTransitionMatrix(),s=t.getEmissionMeans();for(let n=1;n<e.length;n++){const t=e[n],i=e[n-1];if(void 0===t.regime||void 0===i.regime)continue;const o=a[i.regime][t.regime],r=s[t.regime][0];if(o*(r>0?1:.5)>.4){if(void 0===t.return||void 0===t.volatility||void 0===t.liquidity)continue;const e=Math.max(0,35*t.liquidity),i=Math.max(0,t.volatility),a=Math.max(0,t.return),s=new q(e,i,a),n=r>0,o=n?4906624:16281969,l=new oe(.8,2,8),c=new ie({color:o,transparent:!0,opacity:.7}),h=new O(l,c);h.position.copy(s),h.lookAt(s.clone().add(new q(0,n?1:-1,0))),h.rotateX(-Math.PI/2);const d=new B;d.add(h);const u=new oe(1,2.5,8),m=new ie({color:o,transparent:!0,opacity:.2}),v=new O(u,m);v.position.copy(s),v.lookAt(s.clone().add(new q(0,n?1:-1,0))),v.rotateX(-Math.PI/2),d.add(v),this.signalMarkers.push(d),this.scene.add(d)}}}createProbabilityWaves(e,t){e.getEmissionMeans().forEach((e,i)=>{if(!t.find(e=>e.id===i))return;const a=e[1]||0,s=this.getRegimeColorByVolatility(a);for(let t=1;t<=3;t++){const a=new re(2*t,2.5*t,32),n=new ie({color:new T(s),transparent:!0,opacity:.3/t,side:K}),o=new O(a,n),r=this.getRegimeZPosition(i),l=Math.max(0,void 0!==e[1]?e[1]:0),c=this.getRegimeXPosition(i);o.position.set(r,l,c),o.rotation.x=Math.PI/2,o.userData={baseOpacity:.3/t,ring:t};const h=new B;h.add(o),this.probabilityWaves.push(h),this.scene.add(h)}})}createDecodingEffect(e){const t=[],i=[];for(let a=1;a<e.length;a++)if(e[a].regime!==e[a-1].regime){if(void 0===e[a].return||void 0===e[a].volatility||void 0===e[a].liquidity)continue;const s=Math.max(0,35*e[a].liquidity),n=Math.max(0,e[a].volatility),o=Math.max(0,e[a].return);for(let e=0;e<20;e++){const e=s+10*(Math.random()-.5),a=n+5*Math.random(),r=o+5*(Math.random()-.5);t.push(Math.max(0,e),Math.max(0,a),Math.max(0,r)),i.push(0,1,0)}}if(t.length>0){const e=new W;e.setAttribute("position",new se(t,3)),e.setAttribute("color",new se(i,3));const a=new le({size:.5,vertexColors:!0,transparent:!0,opacity:.6}),s=new ce(e,a);s.userData={velocity:t.map(()=>.1*Math.random()-.05)},this.decodingParticles.push(s),this.scene.add(s)}}createPortfolioHeatmap(e,t,i){const a=t.getEmissionMeans(),s=new B;a.forEach((e,t)=>{if(!i.find(e=>e.id===t))return;const a=new he(10,10,10,10),n=e[0],o=(n+.2)/.4,r=new ie({color:new T(n>0?4906624:16281969),transparent:!0,opacity:.3*Math.abs(o),side:K}),l=new O(a,r),c=this.getRegimeZPosition(t),h=Math.max(0,void 0!==e[1]?e[1]:0)-5,d=this.getRegimeXPosition(t);l.position.set(c,h,d),l.rotation.x=-Math.PI/2,s.add(l)}),this.portfolioHeatmap=s,this.scene.add(s)}createComparisonOverlay(e){const t=new B,i=[];if(e.forEach((e,t)=>{if(void 0===e.return||void 0===e.volatility||void 0===e.liquidity)return;const a=Math.max(0,1.2*e.return),s=Math.max(0,35*e.liquidity),n=Math.max(0,.9*e.volatility),o=Math.max(0,a);i.push(new q(s,n,o))}),i.length>1){const e=(new W).setFromPoints(i),a=new Z({color:16766720,transparent:!0,opacity:.4,linewidth:2,dashed:!0}),s=new G(e,a);t.add(s)}this.comparisonOverlay=t,this.scene.add(t)}calculateRegimeStability(e){if(0===e.length)return 0;const t=e.map(e=>e.regime||0),i=t.sort((e,i)=>t.filter(t=>t===e).length-t.filter(e=>e===i).length).pop()||0;return t.filter(e=>e===i).length/e.length}calculatePredictability(e){if(e.length<2)return 0;let t=0;for(let i=1;i<e.length;i++)e[i].regime===e[i-1].regime&&t++;return t/(e.length-1)}}const we={class:"regime-space-3d"},xe={class:"main-layout"},be={class:"controls-panel"},Me={class:"glass-card panel"},Ae={class:"controls-section"},Se={class:"input-group"},ke={class:"input-group"},Ee={class:"scrub-row"},Ce={class:"input-group"},Re=["disabled"],Pe={key:0},De={key:1,class:"flex items-center gap-2"},je={key:0,class:"glass-card panel"},Te={class:"view-controls"},Ie={class:"checkbox-label"},Le={class:"checkbox-label"},Fe={class:"checkbox-label"},_e={class:"checkbox-label"},Ne={class:"camera-presets"},Ve={class:"preset-buttons"},He=["onClick"],Oe={class:"checkbox-label"},qe={key:1,class:"glass-card panel"},ze={class:"regime-info"},Be={class:"regime-name"},$e={class:"regime-stats"},Ue={class:"stat-row"},Xe={class:"stat-value"},Ze={class:"stat-row"},We={class:"stat-row"},Ye={class:"stat-value"},Ge={key:0,class:"glass-card panel"},Qe={class:"m-val"},Je={class:"m-lbl"},Ke={class:"main-content"},et={key:0,class:"visualization-header"},tt={class:"timeline-controls"},it=["disabled"],at={class:"timeline-wrapper"},st=["max","disabled"],nt=["disabled"],ot={class:"current-date"},rt={key:0,class:"loading-overlay"},lt={class:"tooltip-header"},ct={class:"tooltip-title"},ht={class:"tooltip-type"},dt={class:"tooltip-body"},ut={class:"tooltip-key"},mt={class:"tooltip-value"},vt={key:1,class:"stats-panel"},pt={class:"stats-card"},gt={class:"distribution-bars"},yt={class:"dist-label"},ft={class:"stats-card"},wt={class:"duration-list"},xt={class:"duration-name"},bt={class:"duration-value"},Mt={key:0,class:"stats-card trajectory-node-details"},At={class:"trajectory-node-data"},St={class:"data-row"},kt={class:"data-value"},Et={class:"data-row"},Ct={class:"data-value"},Rt={class:"data-row"},Pt={class:"data-row"},Dt={class:"data-row"},jt={class:"data-value"},Tt={class:"data-row"},It={class:"data-value"},Lt={key:0,class:"data-row"},Ft={class:"data-value"},_t=a({__name:"RegimeSpace3D",props:{initialAsset:{},initialNStates:{}},setup(e){const i=e,a=s(null),C=s(!1),R=s(!1),P=s(i.initialAsset||"SPY"),D=s(i.initialNStates||4),j=s("1Y"),T=s(0),I=s(!1),L=s(1),F=s(!1),_=s(!0),N=s(!0),V=s(!1),H=s(!0),O=s(!1),q=s(null),z=s({x:0,y:0}),B=s(null),$=s([]),U=n(()=>{if("ALL"===j.value)return $.value;const e={"3M":90,"6M":180,"1Y":252,"2Y":504}[j.value]||252;return $.value.slice(-e)}),X=s(null),Z=s(null),W=s([]),Y=s([]);let G=null;const Q=s([{id:0,name:"Low Vol / Accumulation",color:"#60a5fa",mean:[.15,8,.8]},{id:1,name:"Normal / Trending",color:"#fb923c",mean:[.08,15,.6]},{id:2,name:"High Vol / Distribution",color:"#ef4444",mean:[-.05,35,.4]},{id:3,name:"Crisis / Panic",color:"#dc2626",mean:[-.2,60,.2]},{id:4,name:"Recovery",color:"#fb923c",mean:[.12,20,.5]}]),J=[{name:"top",label:"Сверху",position:[0,100,0],target:[0,0,0]},{name:"side",label:"Сбоку",position:[0,40,80],target:[0,0,0]},{name:"isometric",label:"Изометрия",position:[50,50,50],target:[0,0,0]},{name:"front",label:"Спереди",position:[0,0,80],target:[0,0,0]}];let K=null;const ee=n(()=>0===U.value.length?0:T.value/(U.value.length-1)*100),te=n(()=>{if(0===U.value.length)return"—";const e=U.value[T.value];return e?.date||"—"}),ie=n(()=>{if(0===U.value.length||!U.value[T.value])return null;const e=U.value[T.value],t=void 0!==e.regime?Math.max(0,Math.min(e.regime,D.value-1)):0,i=Math.max(0,Math.min(t,Q.value.length-1)),a=Q.value[i];if(!a)return null;const s=e.probability&&i<e.probability.length?e.probability[i]:0,n=X.value?.getEmissionMeans(),o=n&&i<n.length?n[i]:[0,0,0];return{...a,probability:s,meanReturn:o[0]||0,meanVolatility:o[1]||0}}),ae=n(()=>{if(!q.value||!q.value.data)return{};const e={};for(const[t,i]of Object.entries(q.value.data))"object"!=typeof i&&null!==i&&"point"!==t&&"Индекс"!==t&&"Режим ID"!==t&&(e[t]=String(i));return e}),se=()=>{const e=[];for(let t=0;t<D.value;t++)if(t<Q.value.length)e.push(Q.value[t]);else{const i=["#4ade80","#60a5fa","#a78bfa","#f87171","#fbbf24","#fb923c","#3b82f6"];e.push({id:t,name:`Режим ${t}`,color:i[t%i.length],mean:[0,10,.5]})}return e},ne=async()=>{if(a.value){console.log("Starting HMM analysis...",{nStates:D.value,containerSize:{width:a.value.clientWidth,height:a.value.clientHeight}}),C.value=!0,R.value=!1;try{const{getChartData:e,getRegimeStatistics:i,getTransitionMatrix:s}=await t(async()=>{const{getChartData:e,getRegimeStatistics:t,getTransitionMatrix:i}=await import("./multivariateHmmService-DuaXhU80.js");return{getChartData:e,getRegimeStatistics:t,getTransitionMatrix:i}},__vite__mapDeps([3,0,1,2])),{usePortfolioStore:n}=await t(async()=>{const{usePortfolioStore:e}=await import("./portfolio-t34lcnLk.js");return{usePortfolioStore:e}},__vite__mapDeps([4,1])),r=(n(),await e());if(!r.success||!r.data||0===r.data.length)throw new Error("Нет данных HMM модели. Сначала запустите анализ на странице RegimeAnalysis.");$.value=r.data.map((e,t)=>({date:new Date(Date.now()-24*(r.data.length-t)*60*60*1e3).toISOString().split("T")[0],return:(e.price-100)/100,volatility:e.vol,liquidity:.5+.5*Math.random(),regime:e.regime,probability:Array(D.value).fill(0).map((t,i)=>i===e.regime?.8:.2/(D.value-1))}));const[l,c]=await Promise.all([s(),i()]);D.value=l.n_regimes,X.value=new ge;const h=l.transition_matrix,d=[],u=[];for(let t=0;t<c.statistics.length;t++){const e=c.statistics[t],i=e.mean.reduce((e,t)=>e+t,0)/e.mean.length,a=e.volatility_per_asset.reduce((e,t)=>e+t,0)/e.volatility_per_asset.length;d.push([i,a,.5]);const s=e.covariance;s&&s.length>=3&&s[0].length>=3?u.push([[s[0][0]||.01,s[0][1]||0,s[0][2]||0],[s[1][0]||0,s[1][1]||.01,s[1][2]||0],[s[2][0]||0,s[2][1]||0,.1]]):u.push([[.01,0,0],[0,.01,0],[0,0,.1]])}if(X.value.setParameters({nStates:D.value,transitionMatrix:h,initialStateDistribution:Array(D.value).fill(1/D.value),emissionMeans:d,emissionCovariances:u}),X.value){W.value=X.value.computeStationaryDistribution(),Y.value=[];for(let e=0;e<D.value;e++)Y.value.push(X.value.computeExpectedDuration(e))}if(Z.value=h,a.value&&!G){if(0===a.value.clientWidth||0===a.value.clientHeight)return console.warn("Canvas container has zero dimensions, retrying..."),void setTimeout(()=>ne(),200);G=new fe(a.value),G.setOnHover(e=>{if(q.value=e,e&&"trajectory-node"===e.type){q.value=e;const t=e.data.point;t&&(B.value={point:t,timeIndex:parseInt(e.data["Индекс"]||"0"),regimeId:parseInt(e.data["Режим ID"]||"0")})}else!e||"centroid"!==e.type&&"ellipsoid"!==e.type?(q.value=null,B.value=null):(q.value=e,B.value=null)});const e=e=>{if(a.value&&q.value){const t=a.value.getBoundingClientRect();z.value={x:e.clientX-t.left,y:e.clientY-t.top}}};a.value.addEventListener("mousemove",e),o(()=>{a.value&&a.value.removeEventListener("mousemove",e)});const t=()=>{if(G&&a.value){const e=a.value.clientWidth,t=a.value.clientHeight;e>0&&t>0&&G.resize(e,t)}};window.addEventListener("resize",t),o(()=>{window.removeEventListener("resize",t)}),setTimeout(()=>{if(G&&a.value){const e=a.value.clientWidth,t=a.value.clientHeight;e>0&&t>0&&G.resize(e,t)}},100)}if(G&&X.value){const e=se();G.setData(U.value,X.value,e)}T.value=U.value.length-1,R.value=!0,console.log("HMM analysis completed successfully",{dataPoints:U.value.length,rendererInitialized:!!G,hmmModelInitialized:!!X.value})}catch(e){console.error("Error running analysis:",e),alert("Ошибка при запуске анализа: "+e.message)}finally{C.value=!1}}else console.error("Canvas container not found")},oe=()=>{ne()},re=()=>{if(G&&X.value){const e=se();G.setData(U.value,X.value,e)}},le=()=>{if(G&&X.value){const e=se();G.setData(U.value,X.value,e),T.value=Math.min(T.value,U.value.length-1)}},ce=()=>{G&&(G.setShowTrajectory(_.value),G.setShowEllipsoids(N.value),G.setShowCentroids(V.value),G.setShowGrid(H.value))},he=()=>{G&&G.setAutoRotate(F.value)},de=()=>{if(G){const e=Math.max(0,(U.value.length||1)-1);T.value=Math.max(0,Math.min(T.value,e)),G.setTimeIndex(T.value),O.value&&(G.setShowTransitionArrows(!1),setTimeout(()=>{G&&G.setShowTransitionArrows(!0)},100))}},ue=()=>{I.value=!I.value,I.value?me():ve()},me=()=>{if(ve(),!R.value||0===U.value.length)return;const e=()=>{if(!I.value||!R.value||0===U.value.length)return void ve();const t=parseFloat(L.value.toString()),i=Math.max(1,Math.ceil(t));if(T.value=Math.min(T.value+i,U.value.length-1),T.value>=U.value.length-1)return T.value=U.value.length-1,void ve();de();const a=Math.max(30,Math.min(200,150/t));K=window.setTimeout(e,a)};e()},ve=()=>{K&&(clearTimeout(K),K=null),I.value=!1},ye=()=>{ve(),R.value&&U.value.length>0&&(T.value=0,de())},_t=()=>{G&&G.exportScreenshot(`regime-space-${P.value}-${Date.now()}.png`)},Nt=()=>{const e=[["Date","Return","Volatility","Liquidity","Regime","Probability"].join(","),...U.value.map(e=>[e.date,e.return.toFixed(4),e.volatility.toFixed(4),e.liquidity.toFixed(4),e.regime||0,e.probability?Math.max(...e.probability).toFixed(4):"0"].join(","))].join("\n"),t=new Blob([e],{type:"text/csv"}),i=URL.createObjectURL(t),a=document.createElement("a");a.href=i,a.download=`regime-data-${P.value}-${Date.now()}.csv`,a.click(),URL.revokeObjectURL(i)};return m(()=>U.value,()=>{if(G&&X.value&&U.value.length>0){const e=se();G.setData(U.value,X.value,e)}},{deep:!0}),v(()=>{setTimeout(()=>{!a.value||C.value||R.value||ne()},100)}),o(()=>{ve(),G&&(G.dispose(),G=null)}),(e,t)=>(u(),r("div",we,[h("div",xe,[h("aside",be,[h("div",Me,[t[17]||(t[17]=h("div",{class:"panel-header"},[h("h3",null,"Управление")],-1)),h("div",Ae,[h("div",Se,[t[11]||(t[11]=h("label",{class:"lbl"},"Актив",-1)),g(h("select",{"onUpdate:modelValue":t[0]||(t[0]=e=>P.value=e),class:"glass-select",onChange:oe},[...t[10]||(t[10]=[h("option",{value:"SPY"},"S&P 500 (SPY)",-1),h("option",{value:"QQQ"},"Nasdaq 100 (QQQ)",-1),h("option",{value:"BTC"},"Bitcoin (BTC)",-1),h("option",{value:"IMOEX"},"IMOEX Index",-1)])],544),[[y,P.value]])]),h("div",ke,[t[13]||(t[13]=h("label",{class:"lbl"},"Количество режимов",-1)),h("div",Ee,[p(pe,{modelValue:D.value,"onUpdate:modelValue":[t[1]||(t[1]=e=>D.value=e),re],min:2,max:5,step:1,class:"text-accent font-bold"},null,8,["modelValue"]),t[12]||(t[12]=h("span",{class:"unit"},"states",-1))])]),h("div",Ce,[t[15]||(t[15]=h("label",{class:"lbl"},"Временной период",-1)),g(h("select",{"onUpdate:modelValue":t[2]||(t[2]=e=>j.value=e),class:"glass-select",onChange:le},[...t[14]||(t[14]=[f('<option value="3M" data-v-273d2efa>3 месяца</option><option value="6M" data-v-273d2efa>6 месяцев</option><option value="1Y" data-v-273d2efa>1 год</option><option value="2Y" data-v-273d2efa>2 года</option><option value="ALL" data-v-273d2efa>Все данные</option>',5)])],544),[[y,j.value]])]),h("button",{onClick:ne,disabled:C.value,class:"btn-primary-gradient"},[C.value?(u(),r("span",De,[...t[16]||(t[16]=[h("span",{class:"spinner-mini"},null,-1),w(" Обучение HMM... ",-1)])])):(u(),r("span",Pe,"Запустить анализ"))],8,Re)])]),R.value?(u(),r("div",je,[t[24]||(t[24]=h("div",{class:"panel-header"},[h("h3",null,"Вид")],-1)),h("div",Te,[h("label",Ie,[g(h("input",{type:"checkbox","onUpdate:modelValue":t[3]||(t[3]=e=>_.value=e),onChange:ce},null,544),[[x,_.value]]),t[18]||(t[18]=h("span",null,"Траектория",-1))]),h("label",Le,[g(h("input",{type:"checkbox","onUpdate:modelValue":t[4]||(t[4]=e=>N.value=e),onChange:ce},null,544),[[x,N.value]]),t[19]||(t[19]=h("span",null,"Эллипсоиды",-1))]),h("label",Fe,[g(h("input",{type:"checkbox","onUpdate:modelValue":t[5]||(t[5]=e=>V.value=e),onChange:ce},null,544),[[x,V.value]]),t[20]||(t[20]=h("span",null,"Центроиды",-1))]),h("label",_e,[g(h("input",{type:"checkbox","onUpdate:modelValue":t[6]||(t[6]=e=>H.value=e),onChange:ce},null,544),[[x,H.value]]),t[21]||(t[21]=h("span",null,"Сетка",-1))])]),h("div",Ne,[t[23]||(t[23]=h("h4",{class:"presets-title"},"Вид камеры",-1)),h("div",Ve,[(u(),r(b,null,M(J,e=>h("button",{key:e.name,onClick:t=>(e=>{G&&G.setCameraPreset(e)})(e),class:"btn-preset"},d(e.label),9,He)),64))]),h("label",Oe,[g(h("input",{type:"checkbox","onUpdate:modelValue":t[7]||(t[7]=e=>F.value=e),onChange:he},null,544),[[x,F.value]]),t[22]||(t[22]=h("span",null,"Авто-вращение",-1))])])])):c("",!0),ie.value?(u(),r("div",qe,[t[28]||(t[28]=h("div",{class:"panel-header"},[h("h3",null,"Текущий режим")],-1)),h("div",ze,[h("div",{class:"regime-badge",style:A({borderColor:ie.value.color})},[h("span",{class:"regime-dot",style:A({backgroundColor:ie.value.color})},null,4),h("span",Be,d(ie.value.name),1)],4),h("div",$e,[h("div",Ue,[t[25]||(t[25]=h("span",{class:"stat-label"},"Вероятность:",-1)),h("span",Xe,d((100*ie.value.probability).toFixed(1))+"%",1)]),h("div",Ze,[t[26]||(t[26]=h("span",{class:"stat-label"},"Доходность:",-1)),h("span",{class:l(["stat-value",ie.value.meanReturn>=0?"text-green":"text-red"])},d(ie.value.meanReturn.toFixed(2))+"% ",3)]),h("div",We,[t[27]||(t[27]=h("span",{class:"stat-label"},"Волатильность:",-1)),h("span",Ye,d(ie.value.meanVolatility.toFixed(1))+"%",1)])])])])):c("",!0),p(S,{name:"fade"},{default:k(()=>[Z.value?(u(),r("div",Ge,[t[29]||(t[29]=h("div",{class:"panel-header"},[h("h3",null,"Матрица переходов")],-1)),h("div",{class:"matrix-grid",style:A({gridTemplateColumns:`repeat(${D.value}, 1fr)`})},[(u(!0),r(b,null,M(Z.value,(e,t)=>(u(),r("div",{key:t,class:"matrix-row-group"},[(u(!0),r(b,null,M(e,(e,i)=>(u(),r("div",{key:i,class:"matrix-cell",style:A({backgroundColor:`rgba(96, 165, 250, ${.6*e})`})},[h("span",Qe,d((100*e).toFixed(0))+"%",1),h("span",Je,"S"+d(t)+"→S"+d(i),1)],4))),128))]))),128))],4)])):c("",!0)]),_:1})]),h("main",Ke,[R.value?(u(),r("div",et,[t[31]||(t[31]=h("div",{class:"header-left"},[h("h2",{class:"vis-title"},"Пространство скрытых состояний"),h("p",{class:"vis-subtitle"}," 3D визуализация рыночных режимов (HMM) ")],-1)),h("div",tt,[h("button",{onClick:ue,class:l(["btn-play",{active:I.value}]),disabled:!R.value||0===U.value.length},d(I.value?"⏸":"▶"),11,it),h("div",at,[g(h("input",{type:"range",min:0,max:Math.max(0,(U.value.length||1)-1),"onUpdate:modelValue":t[8]||(t[8]=e=>T.value=e),onInput:de,class:"timeline-slider",disabled:!R.value},null,40,st),[[E,T.value,void 0,{number:!0}]]),h("div",{class:"timeline-track",style:A({width:ee.value+"%"})},null,4),h("div",{class:"timeline-thumb",style:A({left:ee.value+"%"})},null,4)]),g(h("select",{"onUpdate:modelValue":t[9]||(t[9]=e=>L.value=e),class:"speed-select"},[...t[30]||(t[30]=[h("option",{value:"0.5"},"0.5x",-1),h("option",{value:"1"},"1x",-1),h("option",{value:"2"},"2x",-1),h("option",{value:"5"},"5x",-1)])],512),[[y,L.value]]),h("button",{onClick:ye,class:"btn-reset",disabled:!R.value||0===U.value.length},"↺",8,nt),h("div",ot,d(te.value),1)])])):c("",!0),h("div",{ref_key:"canvasContainer",ref:a,class:l(["canvas-container",{loading:C.value}])},[C.value?(u(),r("div",rt,[...t[32]||(t[32]=[h("div",{class:"spinner-large"},null,-1),h("p",null,"Инициализация 3D пространства...",-1)])])):c("",!0),q.value?(u(),r("div",{key:1,class:"hover-tooltip",style:A({left:z.value.x+"px",top:z.value.y+"px"})},[h("div",lt,[h("h4",ct,d(q.value.title),1),h("span",ht,d(q.value.type),1)]),h("div",dt,[(u(!0),r(b,null,M(ae.value,(e,t)=>(u(),r("div",{key:t,class:"tooltip-row"},[h("span",ut,d(t)+":",1),h("span",mt,d(e),1)]))),128))])],4)):c("",!0)],2),R.value?(u(),r("div",vt,[h("div",pt,[t[33]||(t[33]=h("h4",null,"Стационарное распределение",-1)),t[34]||(t[34]=h("p",{class:"info-hint"},"Долгосрочная вероятность каждого режима",-1)),h("div",gt,[(u(!0),r(b,null,M(W.value,(e,t)=>(u(),r("div",{key:t,class:"dist-bar",style:A({width:100*e+"%",backgroundColor:Q.value[t]?.color||"#888"})},[h("span",yt,"S"+d(t)+": "+d((100*e).toFixed(1))+"%",1)],4))),128))])]),h("div",ft,[t[35]||(t[35]=h("h4",null,"Ожидаемая длительность режимов",-1)),t[36]||(t[36]=h("p",{class:"info-hint"},"Средняя продолжительность режима в днях",-1)),h("div",wt,[(u(!0),r(b,null,M(Y.value,(e,t)=>(u(),r("div",{key:t,class:"duration-item"},[h("span",{class:"duration-dot",style:A({backgroundColor:Q.value[t]?.color||"#888"})},null,4),h("span",xt,d(Q.value[t]?.name||`Режим ${t}`),1),h("span",bt,d(e.toFixed(1))+" дней",1)]))),128))])]),B.value?(u(),r("div",Mt,[t[44]||(t[44]=h("h4",null,"Детализация узла траектории",-1)),t[45]||(t[45]=h("p",{class:"info-hint"},"Информация о наведенном наблюдении",-1)),h("div",At,[h("div",St,[t[37]||(t[37]=h("span",{class:"data-label"},"Индекс:",-1)),h("span",kt,d(B.value.timeIndex),1)]),h("div",Et,[t[38]||(t[38]=h("span",{class:"data-label"},"Дата:",-1)),h("span",Ct,d(B.value.point.date||"N/A"),1)]),h("div",Rt,[t[39]||(t[39]=h("span",{class:"data-label"},"Режим:",-1)),h("span",{class:"data-value",style:A({color:Q.value[B.value.regimeId]?.color||"#fff"})},d(Q.value[B.value.regimeId]?.name||`Режим ${B.value.regimeId}`),5)]),h("div",Pt,[t[40]||(t[40]=h("span",{class:"data-label"},"Доходность:",-1)),h("span",{class:l(["data-value",B.value.point.return&&B.value.point.return>=0?"text-green":"text-red"])},d(void 0!==B.value.point.return?(100*B.value.point.return).toFixed(2)+"%":"N/A"),3)]),h("div",Dt,[t[41]||(t[41]=h("span",{class:"data-label"},"Волатильность:",-1)),h("span",jt,d(void 0!==B.value.point.volatility?B.value.point.volatility.toFixed(2)+"%":"N/A"),1)]),h("div",Tt,[t[42]||(t[42]=h("span",{class:"data-label"},"Ликвидность:",-1)),h("span",It,d(void 0!==B.value.point.liquidity?B.value.point.liquidity.toFixed(3):"N/A"),1)]),B.value.point.probability?(u(),r("div",Lt,[t[43]||(t[43]=h("span",{class:"data-label"},"Вероятность режима:",-1)),h("span",Ft,d((100*B.value.point.probability[B.value.regimeId]).toFixed(1)+"%"),1)])):c("",!0)])])):c("",!0),h("div",{class:"export-section"},[h("button",{onClick:_t,class:"btn-export"}," 📷 Скриншот "),h("button",{onClick:Nt,class:"btn-export"}," 📊 CSV ")])])):c("",!0)])])]))}}),Nt=e(_t,[["__scopeId","data-v-273d2efa"]]),Vt={class:"page-container custom-scroll"},Ht={class:"section-header"},Ot={class:"header-actions"},qt={class:"glass-pill status-pill"},zt={class:"status-label"},Bt={class:"text-white"},$t={class:"view-tabs"},Ut={key:0,class:"regime-3d-container"},Xt={key:1,class:"dashboard-grid"},Zt={class:"left-panel"},Wt={class:"glass-card panel"},Yt={class:"controls-form"},Gt={class:"input-group"},Qt={class:"glass-pill status-pill"},Jt={class:"status-label text-muted"},Kt={class:"text-white"},ei={class:"info-text"},ti={class:"input-group mt-2"},ii={class:"checkbox-label"},ai={key:0,class:"input-group mt-2"},si={class:"scrub-row"},ni=["disabled"],oi={key:0},ri={key:1,class:"flex items-center gap-2"},li={key:0,class:"glass-card panel"},ci={class:"m-val"},hi={class:"m-lbl"},di={key:0,class:"glass-card panel"},ui={class:"stats-list"},mi={class:"stat-head"},vi={class:"s-name"},pi={class:"stat-metrics"},gi={class:"text-muted"},yi={class:"main-panel"},fi={class:"glass-card chart-card"},wi={class:"chart-header"},xi={class:"ch-left"},bi={key:0,class:"badge-live"},Mi={key:0,class:"playback-controls"},Ai={key:0},Si={key:1},ki={class:"timeline-wrapper"},Ei=["max"],Ci={class:"chart-container"},Ri={key:0,viewBox:"0 0 800 400",preserveAspectRatio:"none",class:"regime-svg"},Pi=["x","width","fill"],Di=["d"],ji=["x1","x2"],Ti={key:1,class:"empty-state"},Ii={key:0,class:"spinner-large"},Li={key:1},Fi={class:"glass-card chart-card mt-4"},_i={class:"chart-container-sm"},Ni={key:0,viewBox:"0 0 800 160",preserveAspectRatio:"none",class:"regime-svg"},Vi=["y1","y2"],Hi=["cx","cy","fill"],Oi={class:"glass-card chart-card mt-4"},qi={class:"chart-container-sm"},zi={key:0,viewBox:"0 0 800 160",preserveAspectRatio:"none",class:"regime-svg"},Bi=["y1","y2"],$i=["y"],Ui=["y"],Xi=["y"],Zi=["cx","cy","fill"],Wi=e(a({__name:"RegimeAnalysis",setup(e){const a=i(),m=P(),v=s("SPY"),y=s(3),f=s(!0),D=s("2d"),j=s(!1),T=s(null),I=s([]),L=s([]),F=s(0),_=s(!1);let N=null,V=null;const H=n(()=>I.value.length?F.value/(I.value.length-1)*100:0),O=async()=>{if(j.value)return;j.value=!0,z();const e=m.selectedBank?.name||"Портфель",i=a.addTask(`Обучение HMM на портфеле ${e}...`,"simulation");try{a.updateProgress(i,10);const{fitModel:e,getChartData:s,getRegimeStatistics:n,getTransitionMatrix:o}=await t(async()=>{const{fitModel:e,getChartData:t,getRegimeStatistics:i,getTransitionMatrix:a}=await import("./multivariateHmmService-DuaXhU80.js");return{fitModel:e,getChartData:t,getRegimeStatistics:i,getTransitionMatrix:a}},__vite__mapDeps([3,0,1,2])),r=await e({bank_reg_number:m.selectedBank?.regNumber,auto_optimize:f.value,n_regimes:f.value?void 0:y.value,criterion:"aicc",max_iterations:50,tol:1e-6,random_state:42,period_days:252});a.updateProgress(i,70),f.value&&(y.value=r.n_regimes);const l=await s();a.updateProgress(i,85);const c=await n(),h=await o();a.updateProgress(i,95),I.value=l.data.map(e=>({price:e.price,regime:e.regime,vol:e.vol})),T.value=h.transition_matrix,L.value=c.statistics.map(e=>{const t=e.mean.reduce((e,t)=>e+t,0)/e.mean.length,i=e.volatility_per_asset.reduce((e,t)=>e+t,0)/e.volatility_per_asset.length;return{ret:(100*t).toFixed(2),vol:(100*i).toFixed(1)}}),F.value=I.value.length-1,a.updateProgress(i,100),V=setTimeout(()=>{q()},500)}catch(s){console.error("Ошибка обучения HMM:",s),a.failTask(i),alert(`Ошибка: ${s.message||"Неизвестная ошибка"}`)}finally{j.value=!1}},q=()=>{_.value?z():(F.value>=I.value.length-1&&(F.value=0),_.value=!0,$())},z=()=>{_.value=!1,N&&cancelAnimationFrame(N)},B=()=>{z(),F.value=0},$=()=>{if(!_.value)return;const e=F.value+3;e>=I.value.length?(F.value=I.value.length-1,z()):(F.value=e,N=requestAnimationFrame($))},U=n(()=>800/(I.value.length||1)),X=e=>e*U.value,Z=e=>{let t=(e-0)/.8;return t>1&&(t=1),t<0&&(t=0),160-140*t-10},W=e=>0===e?130:1===e?80:30,Y=n(()=>{if(!I.value.length)return"";const e=I.value.slice(0,F.value+1),t=I.value.map(e=>e.price),i=Math.min(...t),a=Math.max(...t);return"M "+e.map((e,t)=>`${X(t).toFixed(1)},${((e,t,i)=>400-(e-t)/(i-t||1)*360-20)(e.price,i,a).toFixed(1)}`).join(" L ")}),G=e=>0===e?"Стабильный (Низкая волатильность)":1===e?"Рост (Бычий)":2===e?"Стресс (Медвежий)":"Коррекция",Q=e=>1===e?"#4ade80":2===e?"#f87171":"#3b82f6",J=e=>1===e?"bg-green":2===e?"bg-red":"bg-blue",K=n(()=>{if(!I.value.length)return"—";const e=Math.min(F.value,I.value.length-1);return G(I.value[e].regime)}),ee=n(()=>{if(!I.value.length)return"bg-grey";const e=Math.min(F.value,I.value.length-1);return J(I.value[e].regime)});return o(()=>{N&&cancelAnimationFrame(N),V&&clearTimeout(V)}),(e,t)=>(u(),r("div",Vt,[h("div",Ht,[t[6]||(t[6]=h("div",{class:"header-left"},[h("h1",{class:"section-title"},"Анализ рыночных режимов"),h("p",{class:"section-subtitle"},"HMM: Классификация скрытых состояний рынка")],-1)),h("div",Ot,[h("div",qt,[h("span",{class:l(["dot",ee.value])},null,2),h("span",zt,[t[5]||(t[5]=w("Текущий режим: ",-1)),h("b",Bt,d(K.value),1)])])])]),h("div",$t,[h("button",{onClick:t[0]||(t[0]=e=>D.value="2d"),class:l(["tab-btn",{active:"2d"===D.value}])}," 2D Анализ ",2),h("button",{onClick:t[1]||(t[1]=e=>D.value="3d"),class:l(["tab-btn",{active:"3d"===D.value}])}," 3D Пространство режимов ",2)]),"3d"===D.value?(u(),r("div",Ut,[p(Nt,{"initial-asset":v.value,"initial-n-states":y.value},null,8,["initial-asset","initial-n-states"])])):(u(),r("div",Xt,[h("aside",Zt,[h("div",Wt,[t[12]||(t[12]=h("div",{class:"panel-header"},[h("h3",null,"Параметры модели")],-1)),h("div",Yt,[h("div",Gt,[t[7]||(t[7]=h("label",{class:"lbl"},"Портфель банка",-1)),h("div",Qt,[h("span",Jt,[h("b",Kt,d(C(m).selectedBank?.name||"Не выбран"),1)])]),h("p",ei,"Используется портфель из "+d(C(m).positions.length)+" активов",1)]),h("div",ti,[h("label",ii,[g(h("input",{type:"checkbox","onUpdate:modelValue":t[2]||(t[2]=e=>f.value=e)},null,512),[[x,f.value]]),t[8]||(t[8]=h("span",null,"Автоматически определить количество режимов",-1))])]),f.value?c("",!0):(u(),r("div",ai,[t[10]||(t[10]=h("label",{class:"lbl"},"Количество режимов",-1)),h("div",si,[p(pe,{modelValue:y.value,"onUpdate:modelValue":t[3]||(t[3]=e=>y.value=e),min:2,max:5,step:1,class:"text-accent font-bold"},null,8,["modelValue"]),t[9]||(t[9]=h("span",{class:"unit"},"режимов",-1))])])),h("button",{onClick:O,disabled:j.value,class:"btn-primary-gradient mt-6"},[j.value?(u(),r("span",ri,[...t[11]||(t[11]=[h("span",{class:"spinner-mini"},null,-1),w(" Обучение... ",-1)])])):(u(),r("span",oi,"Запустить анализ"))],8,ni)])]),p(S,{name:"fade"},{default:k(()=>[T.value?(u(),r("div",li,[t[13]||(t[13]=h("div",{class:"panel-header"},[h("h3",null,"Матрица переходов")],-1)),h("div",{class:"matrix-grid",style:A({gridTemplateColumns:`repeat(${y.value}, 1fr)`})},[(u(!0),r(b,null,M(T.value,(e,t)=>(u(),r("div",{key:t,class:"matrix-row-group"},[(u(!0),r(b,null,M(e,(e,i)=>(u(),r("div",{key:i,class:"matrix-cell",style:A({backgroundColor:`rgba(59, 130, 246, ${.8*e})`})},[h("span",ci,d((100*e).toFixed(0))+"%",1),h("span",hi,"S"+d(t)+"→S"+d(i),1)],4))),128))]))),128))],4)])):c("",!0)]),_:1}),p(S,{name:"fade"},{default:k(()=>[L.value.length?(u(),r("div",di,[t[14]||(t[14]=h("div",{class:"panel-header"},[h("h3",null,"Статистика режимов")],-1)),h("div",ui,[(u(!0),r(b,null,M(L.value,(e,t)=>(u(),r("div",{class:"stat-item",key:t},[h("div",mi,[h("span",{class:l(["dot",J(t)])},null,2),h("span",vi,d(G(t)),1)]),h("div",pi,[h("span",{class:l(parseFloat(e.ret)>0?"text-green":"text-red")},"μ: "+d(e.ret)+"%",3),h("span",gi,"σ: "+d(e.vol)+"%",1)])]))),128))])])):c("",!0)]),_:1})]),h("main",yi,[h("div",fi,[h("div",wi,[h("div",xi,[t[15]||(t[15]=h("h3",null,"Динамика цены и режимы",-1)),_.value?(u(),r("span",bi,"В ПРЯМОМ ЭФИРЕ")):c("",!0)]),I.value.length?(u(),r("div",Mi,[h("button",{class:"icon-btn",onClick:q,title:"Воспроизвести/Пауза"},[_.value?(u(),r("span",Ai,"⏸")):(u(),r("span",Si,"▶"))]),h("div",ki,[g(h("input",{type:"range",min:"0",max:I.value.length-1,"onUpdate:modelValue":t[4]||(t[4]=e=>F.value=e),onInput:z,class:"timeline-slider"},null,40,Ei),[[E,F.value,void 0,{number:!0}]]),h("div",{class:"timeline-track",style:A({width:H.value+"%"})},null,4),h("div",{class:"timeline-thumb",style:A({left:H.value+"%"})},null,4)]),h("button",{class:"icon-btn",onClick:B,title:"Сброс"},"↺")])):c("",!0)]),h("div",Ci,[I.value.length?(u(),r("svg",Ri,[(u(!0),r(b,null,M(I.value,(e,t)=>{return g((u(),r("rect",{key:"bg-"+t,x:X(t),y:"0",width:U.value+.5,height:"400",fill:(i=e.regime,a=.15,1===i?`rgba(74, 222, 128, ${a})`:2===i?`rgba(248, 113, 113, ${a})`:`rgba(59, 130, 246, ${a})`)},null,8,Pi)),[[R,t<=F.value]]);var i,a}),128)),t[16]||(t[16]=h("line",{x1:"0",y1:"100",x2:"800",y2:"100",stroke:"rgba(255,255,255,0.05)"},null,-1)),t[17]||(t[17]=h("line",{x1:"0",y1:"200",x2:"800",y2:"200",stroke:"rgba(255,255,255,0.05)"},null,-1)),t[18]||(t[18]=h("line",{x1:"0",y1:"300",x2:"800",y2:"300",stroke:"rgba(255,255,255,0.05)"},null,-1)),h("path",{d:Y.value,fill:"none",stroke:"#fff","stroke-width":"2","stroke-linejoin":"round",filter:"drop-shadow(0 0 4px rgba(0,0,0,0.5))"},null,8,Di),F.value<I.value.length-1?(u(),r("line",{key:0,x1:X(F.value),y1:"0",x2:X(F.value),y2:"400",stroke:"rgba(255,255,255,0.8)","stroke-dasharray":"3"},null,8,ji)):c("",!0)])):(u(),r("div",Ti,[j.value?(u(),r("div",Ii)):(u(),r("span",Li,"Нажмите «Запустить анализ» для генерации"))]))])]),h("div",Fi,[t[19]||(t[19]=h("div",{class:"chart-header"},[h("h3",null,"Скользящая волатильность (20Д)")],-1)),h("div",_i,[I.value.length?(u(),r("svg",Ni,[(u(),r(b,null,M(3,e=>h("line",{key:e,x1:"0",y1:40*e,x2:"800",y2:40*e,stroke:"rgba(255,255,255,0.05)"},null,8,Vi)),64)),(u(!0),r(b,null,M(I.value,(e,t)=>g((u(),r("circle",{key:"v-"+t,cx:X(t),cy:Z(e.vol),r:"2",fill:Q(e.regime)},null,8,Hi)),[[R,t<=F.value]])),128))])):c("",!0)])]),h("div",Oi,[t[20]||(t[20]=h("div",{class:"chart-header"},[h("h3",null,"Предсказанные скрытые состояния")],-1)),h("div",qi,[I.value.length?(u(),r("svg",zi,[(u(),r(b,null,M([0,1,2],e=>h("line",{key:"g-"+e,x1:"0",y1:W(e),x2:"800",y2:W(e),stroke:"rgba(255,255,255,0.05)","stroke-dasharray":"4"},null,8,Bi)),64)),h("text",{x:"10",y:W(0)-8,fill:"rgba(255,255,255,0.2)","font-size":"10"},"Стабильный (0)",8,$i),h("text",{x:"10",y:W(1)-8,fill:"rgba(255,255,255,0.2)","font-size":"10"},"Рост (1)",8,Ui),h("text",{x:"10",y:W(2)-8,fill:"rgba(255,255,255,0.2)","font-size":"10"},"Стресс (2)",8,Xi),(u(!0),r(b,null,M(I.value,(e,t)=>g((u(),r("circle",{key:"s-"+t,cx:X(t),cy:W(e.regime),r:"3",fill:Q(e.regime)},null,8,Zi)),[[R,t<=F.value]])),128))])):c("",!0)])])])]))]))}}),[["__scopeId","data-v-430d9aa0"]]);export{Wi as default};
