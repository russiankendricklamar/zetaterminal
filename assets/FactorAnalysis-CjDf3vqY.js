import{d as a,r as s,G as l,c as e,e as t,C as n,f as d,x as i,y as r,j as c,M as o,t as v,F as u,n as p,i as h,A as m,q as f}from"./vendor-DLyKmMu8.js";import{i as g}from"./index-BjvaFruF.js";import{g as b}from"./apiHeaders-DCeXWvJ_.js";import{_ as k}from"./index-AoYxWDki.js";const _={class:"fa-page"},y={class:"page-header"},x={class:"header-right"},S=["disabled"],F={key:0},M={key:1},w={class:"input-grid"},T={class:"panel"},j={class:"has-header-row"},H={class:"panel"},A={class:"has-header-row"},C={key:0,class:"error-banner"},R={class:"kpi-grid"},E={class:"kpi-card"},$={class:"kpi-value"},N={class:"kpi-sub"},O={class:"kpi-card"},G={class:"kpi-value"},K={class:"kpi-sub"},L={class:"kpi-card"},V={class:"kpi-card"},z={class:"kpi-value"},P={class:"kpi-value"},U={class:"kpi-sub"},B={class:"kpi-card"},q={class:"kpi-value mono"},I={class:"results-grid"},J={class:"panel"},D={class:"coef-table"},Q={class:"mono"},W={class:"mono"},X={class:"grs-box"},Y={class:"grs-label"},Z={class:"mono"},aa={class:"panel"},sa={class:"coef-table"},la={class:"mono accent"},ea={class:"mono muted"},ta={class:"mono"},na={class:"stats-table"},da={class:"mono"},ia={class:"panel"},ra=k(a({__name:"FactorAnalysis",setup(a){const k=s(""),ra=s(""),ca=s(!0),oa=s(!0),va=s(!1),ua=s(""),pa=s(null),ha=s(null),ma=s(null);let fa=null,ga=null;function ba(a,s){const l=a.trim().split("\n").filter(a=>a.trim().length>0);if(0===l.length)return{data:[],names:null};let e=null,t=l;s&&l.length>0&&(e=l[0].trim().split(/[\s,;\t]+/).filter(a=>a.length>0),t=l.slice(1));return{data:t.map(a=>a.trim().split(/[\s,;\t]+/).filter(a=>a.length>0).map(a=>parseFloat(a))).filter(a=>a.length>0&&a.every(a=>!isNaN(a))),names:e}}const ka=a=>null!=a?(100*a).toFixed(2)+"%":"—",_a=a=>a?.toFixed(2)??"—",ya=a=>a?.toFixed(4)??"—",xa=a=>null==a?"—":a<.001?"<0.001":a.toFixed(3);async function Sa(){ua.value="";const{data:a,names:s}=ba(k.value,ca.value),{data:l,names:e}=ba(ra.value,oa.value);if(a.length<10)ua.value="Нужно минимум 10 строк доходностей";else if(0!==l.length)if(a.length===l.length){va.value=!0;try{const t=await fetch("   https://stochastic-dashbord-v1-production.up.railway.app/api/factor-analysis/analyze",{method:"POST",headers:b(),body:JSON.stringify({returns:a,factors:l,asset_names:s,factor_names:e})});if(!t.ok){const a=await t.json();throw new Error(a.detail||`HTTP ${t.status}`)}const n=await t.json();pa.value=n.result,await m(),Fa()}catch(t){ua.value=t.message||"Неизвестная ошибка"}finally{va.value=!1}}else ua.value=`Разное число периодов: returns=${a.length}, factors=${l.length}`;else ua.value="Введите матрицу факторов"}function Fa(){!function(){if(!ha.value||!pa.value)return;fa||(fa=g(ha.value,"dark"));const a=pa.value.cs.pricing_errors,s=pa.value.cs.pricing_errors_assets,l=a.map(a=>a>=0?"#2ecc71":"#e74c3c");fa.setOption({backgroundColor:"transparent",tooltip:{trigger:"axis",formatter:a=>`${a[0].name}: ${parseFloat(a[0].value).toFixed(4)}`},xAxis:{type:"category",data:s,axisLabel:{rotate:30,fontSize:11}},yAxis:{type:"value",axisLabel:{formatter:a=>a.toFixed(3)}},series:[{type:"bar",data:a.map((a,s)=>({value:a,itemStyle:{color:l[s]}})),name:"Pricing error"}],grid:{left:50,right:10,top:10,bottom:60}})}(),function(){if(!ma.value||!pa.value)return;ga||(ga=g(ma.value,"dark"));const a=pa.value.ts.beta_matrix,s=pa.value.asset_names,l=pa.value.factor_names,e=s.length,t=l.length,n=[];let d=1/0,i=-1/0;for(let c=0;c<e;c++)for(let s=0;s<t;s++){const l=a[c][s];n.push([s,c,parseFloat(l.toFixed(4))]),l<d&&(d=l),l>i&&(i=l)}const r=Math.max(Math.abs(d),Math.abs(i));ga.setOption({backgroundColor:"transparent",tooltip:{formatter:a=>`${s[a.data[1]]} / ${l[a.data[0]]}: β = ${a.data[2]}`},xAxis:{type:"category",data:l,splitArea:{show:!0}},yAxis:{type:"category",data:s,splitArea:{show:!0}},visualMap:{min:-r,max:r,calculable:!0,orient:"horizontal",left:"center",bottom:0,inRange:{color:["#e74c3c","#1a1a2e","#2ecc71"]},textStyle:{color:"#aaa"}},series:[{type:"heatmap",data:n,label:{show:e<=12,formatter:a=>a.data[2].toFixed(2),fontSize:11}}],grid:{left:80,right:20,top:10,bottom:60}})}()}return l(pa,()=>m(Fa)),(a,s)=>(f(),e("div",_,[t("div",y,[s[4]||(s[4]=t("div",{class:"header-left"},[t("h1",{class:"page-title"},"TS vs CS Factor Analysis"),t("p",{class:"page-subtitle"},"Fama-MacBeth двухшаговый метод: нагрузки β (TS) → риск-премии λ (CS)")],-1)),t("div",x,[t("button",{onClick:Sa,class:"btn-primary",disabled:va.value},[va.value?(f(),e("span",M,"↺ Считаю...")):(f(),e("span",F,"Анализировать"))],8,S)])]),t("div",w,[t("div",T,[s[6]||(s[6]=t("div",{class:"panel-header"},[t("h3",null,"Матрица доходностей (T × N)"),t("span",{class:"hint"},"Строки — периоды, столбцы — активы. Разделители: пробел/tab/точка с запятой. Первая строка — опционально имена активов.")],-1)),i(t("textarea",{"onUpdate:modelValue":s[0]||(s[0]=a=>k.value=a),class:"data-textarea",rows:"8",placeholder:"AAPL  MSFT  GOOG\n0.01  0.02  0.015\n-0.01 0.00  0.005\n0.02  0.01  0.018"},null,512),[[r,k.value]]),t("div",j,[t("label",null,[i(t("input",{type:"checkbox","onUpdate:modelValue":s[1]||(s[1]=a=>ca.value=a)},null,512),[[o,ca.value]]),s[5]||(s[5]=c(" Первая строка — имена активов",-1))])])]),t("div",H,[s[8]||(s[8]=t("div",{class:"panel-header"},[t("h3",null,"Матрица факторов (T × K)"),t("span",{class:"hint"},"Те же T строк, столбцы — факторы (MKT, HML, SMB и др.).")],-1)),i(t("textarea",{"onUpdate:modelValue":s[2]||(s[2]=a=>ra.value=a),class:"data-textarea",rows:"8",placeholder:"MKT   HML\n0.005 0.002\n-0.003 0.001\n0.008 -0.001"},null,512),[[r,ra.value]]),t("div",A,[t("label",null,[i(t("input",{type:"checkbox","onUpdate:modelValue":s[3]||(s[3]=a=>oa.value=a)},null,512),[[o,oa.value]]),s[7]||(s[7]=c(" Первая строка — имена факторов",-1))])])])]),s[31]||(s[31]=n('<div class="method-row" data-v-5d1549f3><div class="method-card ts-card" data-v-5d1549f3><div class="mc-step" data-v-5d1549f3>Шаг 1 — Time-Series</div><div class="mc-formula" data-v-5d1549f3>R_{i,t} = αᵢ + Σ βᵢₖ·Fₖ,ₜ + εᵢ,ₜ</div><div class="mc-desc" data-v-5d1549f3>Оценка факторных нагрузок β для каждого актива. Даёт attribution риска.</div></div><div class="method-arrow" data-v-5d1549f3>→</div><div class="method-card cs-card" data-v-5d1549f3><div class="mc-step" data-v-5d1549f3>Шаг 2 — Cross-Sectional</div><div class="mc-formula" data-v-5d1549f3>R̄ᵢ = λ₀ + Σ λₖ·βᵢₖ + αᵢ</div><div class="mc-desc" data-v-5d1549f3>Оценка факторных премий λ — цена единицы β-риска в CS.</div></div><div class="method-arrow" data-v-5d1549f3>+</div><div class="method-card grs-card" data-v-5d1549f3><div class="mc-step" data-v-5d1549f3>GRS тест</div><div class="mc-formula" data-v-5d1549f3>F = [(T-N-K)/N] · (1+SR_F²)⁻¹ · α&#39;Σ⁻¹α</div><div class="mc-desc" data-v-5d1549f3>H₀: все αᵢ = 0 — модель объясняет все доходности.</div></div></div>',1)),ua.value?(f(),e("div",C,v(ua.value),1)):d("",!0),pa.value?(f(),e(u,{key:1},[t("div",R,[t("div",E,[s[9]||(s[9]=t("div",{class:"kpi-label"},"Активов N",-1)),t("div",$,v(pa.value.n_assets),1),t("div",N,v(pa.value.n_periods)+" периодов",1)]),t("div",O,[s[10]||(s[10]=t("div",{class:"kpi-label"},"Факторов K",-1)),t("div",G,v(pa.value.n_factors),1),t("div",K,v(pa.value.factor_names?.join(", ")),1)]),t("div",L,[s[11]||(s[11]=t("div",{class:"kpi-label"},"R² TS (avg)",-1)),t("div",{class:p(["kpi-value",pa.value.ts.mean_r2>.5?"val-green":"val-yellow"])},v(ka(pa.value.ts.mean_r2)),3),s[12]||(s[12]=t("div",{class:"kpi-sub"},"средний по активам",-1))]),t("div",V,[s[13]||(s[13]=t("div",{class:"kpi-label"},"R² CS",-1)),t("div",z,v(ka(pa.value.cs.r2_cs)),1),s[14]||(s[14]=t("div",{class:"kpi-sub"},"cross-sectional",-1))]),t("div",{class:p(["kpi-card",pa.value.ts.grs.rejects_H0?"kpi-red":"kpi-green"])},[s[15]||(s[15]=t("div",{class:"kpi-label"},"GRS тест",-1)),t("div",P,v(pa.value.ts.grs.rejects_H0?"Отклоняет":"Не откл."),1),t("div",U,"p = "+v(xa(pa.value.ts.grs.p_value)),1)],2),t("div",B,[s[16]||(s[16]=t("div",{class:"kpi-label"},"Shanken c",-1)),t("div",q,v(_a(pa.value.cs.shanken_c)),1),s[17]||(s[17]=t("div",{class:"kpi-sub"},"коррекция SE",-1))])]),t("div",I,[t("div",J,[s[24]||(s[24]=t("div",{class:"panel-header"},[t("h3",null,"TS: Факторные нагрузки β и альфа"),t("span",{class:"hint"},"* p<0.05, ** p<0.01")],-1)),t("table",D,[t("thead",null,[t("tr",null,[s[19]||(s[19]=t("th",null,"Актив",-1)),s[20]||(s[20]=t("th",null,"α",-1)),(f(!0),e(u,null,h(pa.value.factor_names,a=>(f(),e("th",{key:a},[s[18]||(s[18]=c("β",-1)),t("sub",null,v(a),1)]))),128)),s[21]||(s[21]=t("th",null,"R²",-1)),s[22]||(s[22]=t("th",null,"Sys%",-1))])]),t("tbody",null,[(f(!0),e(u,null,h(pa.value.ts.assets,a=>(f(),e("tr",{key:a.asset},[t("td",null,v(a.asset),1),t("td",{class:p(["mono",Math.abs(a.t_alpha)>1.96?a.alpha>0?"pos":"neg":""])},v(ya(a.alpha))+v(Math.abs(a.t_alpha)>2.58?"**":Math.abs(a.t_alpha)>1.96?"*":""),3),(f(!0),e(u,null,h(a.betas,(s,l)=>{return f(),e("td",{key:l,class:p(["mono",Math.abs(a.t_betas[l])>1.96?"accent":""])},v((t=s,t?.toFixed(3)??"—"))+v(Math.abs(a.t_betas[l])>2.58?"**":Math.abs(a.t_betas[l])>1.96?"*":""),3);var t}),128)),t("td",Q,v(ka(a.r2)),1),t("td",W,v(ka(pa.value.ts.systematic_share[pa.value.ts.assets.indexOf(a)])),1)]))),128))])]),t("div",X,[t("span",Y,"GRS F("+v(pa.value.ts.grs.df1)+", "+v(pa.value.ts.grs.df2)+")",1),t("span",Z,"= "+v(_a(pa.value.ts.grs.stat)),1),s[23]||(s[23]=t("span",{class:"grs-label",style:{"margin-left":"12px"}},"p-value",-1)),t("span",{class:p(["mono",pa.value.ts.grs.rejects_H0?"neg":"pos"])},"= "+v(xa(pa.value.ts.grs.p_value)),3),t("span",{class:p(["grs-verdict",pa.value.ts.grs.rejects_H0?"neg":"pos"])},v(pa.value.ts.grs.rejects_H0?"→ H₀ отклоняется: значимые альфа":"→ H₀ не отклоняется: модель адекватна"),3)])]),t("div",aa,[s[27]||(s[27]=t("div",{class:"panel-header"},[t("h3",null,"CS: Риск-премии λ (Fama-MacBeth)")],-1)),t("table",sa,[s[25]||(s[25]=t("thead",null,[t("tr",null,[t("th",null,"Параметр"),t("th",null,"λ̄"),t("th",null,"SE (FM)"),t("th",null,"SE (Shanken)"),t("th",null,"t-стат"),t("th",null,"p-value")])],-1)),t("tbody",null,[(f(!0),e(u,null,h(pa.value.cs.risk_premia,a=>(f(),e("tr",{key:a.name},[t("td",null,v(a.name),1),t("td",la,v(ya(a.lambda_mean)),1),t("td",ea,v(ya(a.se_fm)),1),t("td",ta,v(ya(a.se_shanken)),1),t("td",{class:p(["mono",Math.abs(a.t_stat)>1.96?"pos":"muted"])},v(_a(a.t_stat)),3),t("td",{class:p(["mono",a.p_value<.05?"pos":"muted"])},v(xa(a.p_value)),3)]))),128))])]),s[28]||(s[28]=t("div",{class:"panel-header",style:{"margin-top":"16px"}},[t("h3",null,"Ценовые ошибки per asset"),t("span",{class:"hint"},"αᵢ = E[Rᵢ] − λ'βᵢ")],-1)),t("div",{ref_key:"peChartEl",ref:ha,class:"chart-sm"},null,512),s[29]||(s[29]=t("div",{class:"panel-header",style:{"margin-top":"16px"}},[t("h3",null,"Статистика факторов")],-1)),t("table",na,[s[26]||(s[26]=t("thead",null,[t("tr",null,[t("th",null,"Фактор"),t("th",null,"E[F]"),t("th",null,"Vol"),t("th",null,"Sharpe")])],-1)),t("tbody",null,[(f(!0),e(u,null,h(pa.value.factor_stats,a=>(f(),e("tr",{key:a.name},[t("td",null,v(a.name),1),t("td",{class:p(["mono",a.mean>0?"pos":"neg"])},v(ya(a.mean)),3),t("td",da,v(ya(a.vol)),1),t("td",{class:p(["mono",a.sharpe>0?"pos":"neg"])},v(_a(a.sharpe)),3)]))),128))])])])]),t("div",ia,[s[30]||(s[30]=t("div",{class:"panel-header"},[t("h3",null,"Тепловая карта β (активы × факторы)")],-1)),t("div",{ref_key:"heatmapEl",ref:ma,class:"chart-container"},null,512)])],64)):d("",!0)]))}}),[["__scopeId","data-v-5d1549f3"]]);export{ra as default};
