import{d as a,r as e,c as l,w as t,n as s,l as r,H as i,p as n,q as o,F as u,z as c,K as v,A as d,R as p,B as m,P as b,L as h,u as y,D as f}from"./vendor-DdjqA-DE.js";import{m as k}from"./charts-DbP6hfG6.js";import{g as x,_ as g}from"./index-CPZWcFRR.js";import"./three-vendor-JfvIfzq4.js";const _={class:"cp-page"},w={class:"card input-card"},F={class:"objectives-row"},j=["value"],V={class:"form-grid"},S={class:"form-group"},C={class:"form-group"},$={class:"form-group"},R={class:"form-group"},L={class:"form-group"},M={class:"form-group"},N={class:"form-group names-group"},T={class:"form-group",style:{"margin-bottom":"16px"}},P={key:0,class:"parse-info"},U={key:1,class:"parse-error"},E={class:"actions"},z=["disabled"],O={key:0,class:"error-msg"},D={class:"card"},K={class:"summary-table"},Q={class:"charts-row"},A={class:"card chart-card"},q={class:"card chart-card"},G={class:"card"},B={class:"obj-details"},I={class:"detail-kpi-row"},H={class:"detail-kpi"},Y={class:"detail-kpi"},J={class:"kpi-val"},W={class:"detail-kpi"},X={class:"kpi-val danger-val"},Z={class:"detail-kpi"},aa={class:"kpi-val"},ea={class:"weight-bars"},la={class:"asset-name"},ta={class:"bar-track"},sa={class:"weight-label"},ra=g(a({__name:"ConvexOptimization",emits:["toast"],setup(a,{emit:g}){const ra=[{key:"min_variance",label:"Min Variance"},{key:"max_sharpe",label:"Max Sharpe"},{key:"cvar",label:"Min CVaR"},{key:"risk_parity",label:"Risk Parity"},{key:"kelly",label:"Kelly"},{key:"mean_variance",label:"Mean-Variance"}],ia={min_variance:"#5b8af5",max_sharpe:"#4caf72",cvar:"#f5a623",risk_parity:"#b39ddb",kelly:"#80deea",mean_variance:"#e05c5c",equal_weight:"#888"},na=e(["min_variance","max_sharpe","cvar","risk_parity","kelly"]),oa=e({long_only:!0,max_weight:.4,cvar_alpha:.95,kelly_fraction:.5,risk_free:0,annualize:252}),ua=e(""),ca=e(""),va=e(!1),da=e(""),pa=e(null),ma=e(null),ba=e(null),ha=e(null);let ya=[];const fa=l(()=>{if(!ca.value.trim())return{matrix:null,error:""};const a=ca.value.trim().split("\n").filter(a=>a.trim()),e=[];for(const t of a){const a=t.split(",").map(a=>parseFloat(a.trim()));if(a.some(isNaN))return{matrix:null,error:`Не удалось разобрать: "${t}"`};e.push(a)}const l=e[0]?.length??0;return e.some(a=>a.length!==l)?{matrix:null,error:"Все строки должны иметь одинаковое число столбцов"}:e.length<30?{matrix:null,error:`Нужно минимум 30 строк, получено ${e.length}`}:l<2?{matrix:null,error:"Нужно минимум 2 актива"}:{matrix:e,error:""}}),ka=l(()=>fa.value.matrix?{T:fa.value.matrix.length,N:fa.value.matrix[0].length}:null),xa=l(()=>fa.value.error);function ga(){let a=314;const e=[5e-4,8e-4,2e-4,4e-4,1e-4],l=[.012,.018,.005,.008,.025],t=[];for(let s=0;s<200;s++){const s=e.map((e,t)=>(e+(a=1664525*a+1013904223&2147483647,(a/2147483647*2-1)*l[t])).toFixed(5));t.push(s.join(","))}ca.value=t.join("\n"),ua.value="SPY,QQQ,IEF,GLD,BTC"}async function _a(){if(!fa.value.matrix)return;va.value=!0,da.value="",pa.value=null;const a=ua.value.trim()?ua.value.split(",").map(a=>a.trim()):void 0;try{const e=await fetch("   https://stochastic-dashbord-v1-production.up.railway.app/api/convex-portfolio/optimize",{method:"POST",headers:{"Content-Type":"application/json",...x()},body:JSON.stringify({returns:fa.value.matrix,asset_names:a,objectives:na.value,...oa.value,n_frontier:30})});if(!e.ok){const a=await e.json();throw new Error(a.detail||`HTTP ${e.status}`)}const l=await e.json();pa.value=l.result,await s(),Fa()}catch(e){da.value=e.message}finally{va.value=!1}}function wa(a){if(!a)return null;const e=k(a,"dark");return ya.push(e),e}function Fa(){ya.forEach(a=>a.dispose()),ya=[],function(){const a=wa(ma.value);if(!a||!pa.value)return;const e=pa.value.asset_names,l=pa.value.objectives_computed,t=e.map((a,e)=>({name:a,type:"bar",stack:"weights",data:l.map(a=>+(pa.value.results[a]?.weights_list?.[e]??0).toFixed(4))}));a.setOption({backgroundColor:"transparent",tooltip:{trigger:"axis",axisPointer:{type:"shadow"}},legend:{bottom:5,textStyle:{color:"#aaa"}},xAxis:{type:"category",data:l.map(a=>Va(a)),axisLabel:{color:"#aaa",rotate:20}},yAxis:{name:"Вес",min:0,max:1,splitLine:{lineStyle:{color:"#333"}}},series:t,grid:{left:50,right:20,top:10,bottom:70}})}(),function(){const a=wa(ba.value);if(!a||!pa.value)return;const e=pa.value.results.risk_parity||pa.value.results.min_variance;if(!e)return;const l=pa.value.asset_names,t=e.risk_contributions;a.setOption({backgroundColor:"transparent",tooltip:{trigger:"item",formatter:a=>`${a.name}: ${(100*a.value).toFixed(2)}%`},series:[{type:"pie",radius:["30%","65%"],data:l.map((a,e)=>({name:a,value:+Math.abs(t[e]??0).toFixed(6)})),label:{formatter:a=>`${a.name}\n${(100*a.value).toFixed(1)}%`,color:"#e0e0e0"}}]})}(),function(){const a=wa(ha.value);if(!a||!pa.value)return;const e=pa.value.frontier,l=pa.value.objectives_computed.filter(a=>pa.value.results[a]).map(a=>{const e=pa.value.results[a];return{value:[e.vol_annual,e.return_annual],name:Va(a),color:Sa(a)}});a.setOption({backgroundColor:"transparent",tooltip:{trigger:"item",formatter:a=>"Frontier"===a.seriesName?`Vol: ${(100*a.data[0]).toFixed(2)}%<br/>Ret: ${(100*a.data[1]).toFixed(2)}%`:`${a.seriesName}<br/>Vol: ${(100*a.data[0]).toFixed(2)}%<br/>Ret: ${(100*a.data[1]).toFixed(2)}%`},legend:{right:10,top:10,textStyle:{color:"#aaa"}},xAxis:{name:"Волатильность (г.)",nameLocation:"middle",nameGap:30,splitLine:{lineStyle:{color:"#333"}},axisLabel:{formatter:a=>`${(100*a).toFixed(0)}%`}},yAxis:{name:"Доходность (г.)",nameLocation:"middle",nameGap:45,splitLine:{lineStyle:{color:"#333"}},axisLabel:{formatter:a=>`${(100*a).toFixed(1)}%`}},series:[{name:"Frontier",type:"line",data:e.map(a=>[a.vol,a.return]),lineStyle:{color:"#5b8af5",width:2},itemStyle:{color:"#5b8af5"},symbol:"none"},...l.map(a=>({name:a.name,type:"scatter",data:[a.value],symbolSize:12,itemStyle:{color:a.color}}))],grid:{left:65,right:20,top:40,bottom:50}})}()}const ja=a=>`${(100*a).toFixed(2)}%`,Va=a=>({min_variance:"Min Var",max_sharpe:"Max SR",cvar:"CVaR",risk_parity:"Risk Parity",kelly:"Kelly",mean_variance:"MV",equal_weight:"Equal Wt"}[a]??a),Sa=a=>ia[a]??"#888",Ca=a=>{const e=Math.max(...(pa.value?.summary??[]).map(a=>a.sharpe));return a.sharpe===e&&e>0};return t(pa,async a=>{a&&(await s(),Fa())}),(a,e)=>(i(),r("div",_,[n("div",w,[e[22]||(e[22]=n("h2",null,"Параметры",-1)),e[23]||(e[23]=n("div",{class:"section-label"},"Задачи оптимизации",-1)),n("div",F,[(i(),r(u,null,c(ra,a=>n("label",{key:a.key,class:"obj-check"},[v(n("input",{type:"checkbox","onUpdate:modelValue":e[0]||(e[0]=a=>na.value=a),value:a.key},null,8,j),[[p,na.value]]),d(" "+m(a.label),1)])),64))]),n("div",V,[n("div",S,[e[10]||(e[10]=n("label",null,"Long-Only",-1)),v(n("select",{"onUpdate:modelValue":e[1]||(e[1]=a=>oa.value.long_only=a)},[...e[9]||(e[9]=[n("option",{value:!0},"Да (w ≥ 0)",-1),n("option",{value:!1},"Long-Short",-1)])],512),[[b,oa.value.long_only]])]),n("div",C,[e[11]||(e[11]=n("label",null,"Макс. вес актива",-1)),v(n("input",{"onUpdate:modelValue":e[2]||(e[2]=a=>oa.value.max_weight=a),type:"number",min:"0.01",max:"1",step:"0.05"},null,512),[[h,oa.value.max_weight,void 0,{number:!0}]]),e[12]||(e[12]=n("span",{class:"hint"},"Ограничение концентрации.",-1))]),n("div",$,[e[13]||(e[13]=n("label",null,"CVaR уровень (α)",-1)),v(n("input",{"onUpdate:modelValue":e[3]||(e[3]=a=>oa.value.cvar_alpha=a),type:"number",min:"0.5",max:"0.999",step:"0.01"},null,512),[[h,oa.value.cvar_alpha,void 0,{number:!0}]]),e[14]||(e[14]=n("span",{class:"hint"},"0.95 = 95% CVaR (Expected Shortfall).",-1))]),n("div",R,[e[15]||(e[15]=n("label",null,"Kelly дробь",-1)),v(n("input",{"onUpdate:modelValue":e[4]||(e[4]=a=>oa.value.kelly_fraction=a),type:"number",min:"0.1",max:"1",step:"0.1"},null,512),[[h,oa.value.kelly_fraction,void 0,{number:!0}]]),e[16]||(e[16]=n("span",{class:"hint"},"0.5 = half-Kelly, 1 = full Kelly.",-1))]),n("div",L,[e[17]||(e[17]=n("label",null,"Безрисковая ставка (дн.)",-1)),v(n("input",{"onUpdate:modelValue":e[5]||(e[5]=a=>oa.value.risk_free=a),type:"number",step:"0.00001"},null,512),[[h,oa.value.risk_free,void 0,{number:!0}]])]),n("div",M,[e[18]||(e[18]=n("label",null,"Периодов в году",-1)),v(n("input",{"onUpdate:modelValue":e[6]||(e[6]=a=>oa.value.annualize=a),type:"number",min:"1"},null,512),[[h,oa.value.annualize,void 0,{number:!0}]]),e[19]||(e[19]=n("span",{class:"hint"},"252 (дн.), 52 (нед.), 12 (мес.).",-1))])]),n("div",N,[e[20]||(e[20]=n("label",null,"Названия активов (через запятую)",-1)),v(n("input",{"onUpdate:modelValue":e[7]||(e[7]=a=>ua.value=a),type:"text",placeholder:"SPY,QQQ,IEF,GLD,BTC"},null,512),[[h,ua.value]])]),n("div",T,[e[21]||(e[21]=n("label",null,"Матрица доходностей (T × N, CSV, строка = период)",-1)),v(n("textarea",{"onUpdate:modelValue":e[8]||(e[8]=a=>ca.value=a),rows:"10",placeholder:"0.001,0.002,-0.001\n-0.001,0.000,0.002\n0.002,0.001,0.000"},null,512),[[h,ca.value]]),ka.value?(i(),r("div",P,m(ka.value.T)+" × "+m(ka.value.N)+" (T × N)",1)):o("",!0),xa.value?(i(),r("div",U,m(xa.value),1)):o("",!0)]),n("div",E,[n("button",{class:"btn-primary",onClick:_a,disabled:va.value||!!xa.value||!ca.value.trim()},m(va.value?"Оптимизация...":"Оптимизировать"),9,z),n("button",{class:"btn-secondary",onClick:ga},"Демо (5 активов, 200 дней)")]),da.value?(i(),r("div",O,m(da.value),1)):o("",!0)]),pa.value?(i(),r(u,{key:0},[n("div",D,[e[25]||(e[25]=n("h3",null,"Сравнение стратегий",-1)),n("table",K,[e[24]||(e[24]=n("thead",null,[n("tr",null,[n("th",null,"Стратегия"),n("th",null,"Sharpe"),n("th",null,"Доходность (г.)"),n("th",null,"Волатильность (г.)"),n("th",null,"CVaR"),n("th",null,"Eff. N"),n("th",null,"Div. Ratio")])],-1)),n("tbody",null,[(i(!0),r(u,null,c(pa.value.summary,a=>(i(),r("tr",{key:a.objective,class:y({"best-row":Ca(a)})},[n("td",null,[n("span",{class:"obj-badge",style:f({background:Sa(a.objective)})},m(Va(a.objective)),5)]),n("td",{class:y(a.sharpe>0?"ok-val":"danger-val")},m(a.sharpe.toFixed(3)),3),n("td",{class:y(a.return_annual>0?"ok-val":"danger-val")},m(ja(a.return_annual)),3),n("td",null,m(ja(a.vol_annual)),1),n("td",null,m(a.cvar.toFixed(4)),1),n("td",null,m(a.effective_n.toFixed(1)),1),n("td",null,m(a.diversification_ratio.toFixed(2)),1)],2))),128))])])]),n("div",Q,[n("div",A,[e[26]||(e[26]=n("h3",null,"Веса портфелей (stacked bar)",-1)),n("div",{ref_key:"weightsChart",ref:ma,class:"chart tall-chart"},null,512)]),n("div",q,[e[27]||(e[27]=n("h3",null,"Вклад риска (Risk Parity)",-1)),n("div",{ref_key:"rcChart",ref:ba,class:"chart tall-chart"},null,512)])]),n("div",G,[e[28]||(e[28]=n("h3",null,"Эффективная граница (Mean-Variance)",-1)),n("div",{ref_key:"frontierChart",ref:ha,class:"chart"},null,512)]),n("div",B,[pa.value.results[a.obj]?(i(!0),r(u,{key:0},c(pa.value.objectives_computed,a=>(i(),r("div",{key:a,class:"card obj-detail-card"},[n("h3",null,[n("span",{class:"obj-badge-sm",style:f({background:Sa(a)})},m(Va(a)),5)]),n("div",I,[n("div",H,[e[29]||(e[29]=n("div",{class:"kpi-label"},"Sharpe",-1)),n("div",{class:y(["kpi-val",pa.value.results[a].sharpe>0?"ok-val":"danger-val"])},m(pa.value.results[a].sharpe.toFixed(3)),3)]),n("div",Y,[e[30]||(e[30]=n("div",{class:"kpi-label"},"CVaR",-1)),n("div",J,m(pa.value.results[a].cvar.toFixed(4)),1)]),n("div",W,[e[31]||(e[31]=n("div",{class:"kpi-label"},"Max DD",-1)),n("div",X,m(ja(pa.value.results[a].max_drawdown)),1)]),n("div",Z,[e[32]||(e[32]=n("div",{class:"kpi-label"},"Eff. N",-1)),n("div",aa,m(pa.value.results[a].effective_n.toFixed(2)),1)])]),n("div",ea,[(i(!0),r(u,null,c(pa.value.asset_names,(e,l)=>(i(),r("div",{key:e,class:"weight-bar-row"},[n("span",la,m(e),1),n("div",ta,[n("div",{class:"bar-fill",style:f({width:ja(Math.abs(pa.value.results[a].weights_list[l])),background:pa.value.results[a].weights_list[l]>=0?"#5b8af5":"#e05c5c"})},null,4)]),n("span",sa,m(ja(pa.value.results[a].weights_list[l])),1)]))),128))])]))),128)):o("",!0)])],64)):o("",!0)]))}}),[["__scopeId","data-v-35456963"]]);export{ra as default};
