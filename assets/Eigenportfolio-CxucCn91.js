import{d as a,r as e,G as l,c as t,e as s,f as i,x as r,j as n,M as o,y as u,t as d,F as c,n as p,i as v,A as m,q as h}from"./vendor-DLyKmMu8.js";import{i as f}from"./index-BjvaFruF.js";import{g,_ as y}from"./index-Ba4DjugF.js";const k={class:"ep-page"},b={class:"page-header"},x={class:"header-right"},_={class:"toggle-label"},C=["disabled"],w={key:0},A={key:1},P={class:"input-grid"},S={class:"panel"},M={class:"has-header-row"},F={class:"panel"},L={key:0,class:"error-banner"},$={class:"kpi-grid"},N={class:"kpi-card"},E={class:"kpi-value"},V={class:"kpi-sub"},O={class:"kpi-card accent-card"},T={class:"kpi-value"},j={class:"kpi-sub"},q={class:"kpi-card"},z={class:"kpi-value"},R={class:"kpi-sub"},U={class:"kpi-card"},I={class:"kpi-value"},K={class:"kpi-sub"},Q={class:"kpi-value"},W={class:"kpi-sub"},G={key:0,class:"kpi-card"},B={class:"kpi-value mono"},H={class:"charts-row"},J={class:"panel"},Z={class:"panel"},D={class:"panel-header"},X={class:"hint"},Y={class:"results-grid"},aa={class:"panel"},ea={class:"panel"},la={class:"ev-table"},ta={class:"mono"},sa={class:"mono"},ia={class:"mono"},ra={class:"panel-header",style:{"margin-top":"16px"}},na={class:"hint"},oa=y(a({__name:"Eigenportfolio",setup(a){const y=e(""),oa=e(""),ua=e(!0),da=e(!0),ca=e(null),pa=e(!1),va=e(""),ma=e(null),ha=e(null),fa=e(null),ga=e(null),ya=e(null);let ka=null,ba=null,xa=null,_a=null;const Ca=a=>null!=a?(100*a).toFixed(2)+"%":"—",wa=a=>a?.toFixed(3)??"—";async function Aa(){va.value="";const{data:a,names:e}=function(a,e){const l=a.trim().split("\n").filter(a=>a.trim());if(!l.length)return{data:[],names:null};const t=/[\s,;\t]+/;let s=null,i=l;return e&&l.length>0&&(s=l[0].trim().split(t).filter(Boolean),i=l.slice(1)),{data:i.map(a=>a.trim().split(t).filter(Boolean).map(Number)).filter(a=>a.length>0&&a.every(a=>!isNaN(a))),names:s}}(y.value,ua.value);if(a.length<5)return void(va.value="Нужно минимум 5 строк доходностей");const l=function(a){if(!a.trim())return null;const e=a.replace(/,/g," ").trim().split(/\s+/).map(Number);return e.every(a=>!isNaN(a))?e:null}(oa.value);if(null!==l&&a.length>0&&l.length!==a[0].length)va.value=`Длина весов ${l.length} не совпадает с числом активов ${a[0].length}`;else{pa.value=!0;try{const t=await fetch("   https://stochastic-dashbord-v1-production.up.railway.app/api/eigenportfolio/decompose",{method:"POST",headers:g(),body:JSON.stringify({returns:a,asset_names:e,use_shrinkage:da.value,n_components:ca.value||null,portfolio_weights:l})});if(!t.ok){const a=await t.json();throw new Error(a.detail||`HTTP ${t.status}`)}ma.value=(await t.json()).result,await m(),Pa()}catch(t){va.value=t.message||"Неизвестная ошибка"}finally{pa.value=!1}}}function Pa(){!function(){if(!ha.value||!ma.value)return;ka||(ka=f(ha.value,"dark"));const a=ma.value.explained_variance.map(a=>+(100*a).toFixed(2)),e=ma.value.cumulative_variance.map(a=>+(100*a).toFixed(2)),l=ma.value.rmt.n_signal,t=a.map((a,e)=>`PC${e+1}`),s=a.map((a,e)=>e<l?"#4e8ef7":"#2a2a3e");ka.setOption({backgroundColor:"transparent",tooltip:{trigger:"axis"},legend:{data:["Var%","Cum%"],top:4,textStyle:{color:"#aaa"}},xAxis:{type:"category",data:t,axisLabel:{rotate:45,fontSize:10}},yAxis:[{type:"value",name:"Var%",axisLabel:{formatter:a=>a+"%"},max:1.15*Math.max(...a)},{type:"value",name:"Cum%",min:0,max:100,axisLabel:{formatter:a=>a+"%"}}],series:[{name:"Var%",type:"bar",data:a.map((a,e)=>({value:a,itemStyle:{color:s[e]}})),yAxisIndex:0},{name:"Cum%",type:"line",data:e,yAxisIndex:1,lineStyle:{color:"#f5c518",width:2},showSymbol:!1,markLine:{data:[{yAxis:90,lineStyle:{color:"#2ecc71",type:"dashed"},label:{formatter:"90%"}}]}}],grid:{left:50,right:55,top:40,bottom:55}})}(),function(){if(!fa.value||!ma.value)return;ba||(ba=f(fa.value,"dark"));const{eigenvalues:a,rmt:e}=ma.value,{lambda_plus:l,lambda_minus:t,mp_x:s,mp_pdf:i}=e;Math.max(...a),Math.max(...i),ba.setOption({backgroundColor:"transparent",tooltip:{trigger:"axis"},legend:{data:["Eigenvalues","MP pdf"],top:4,textStyle:{color:"#aaa"}},xAxis:{type:"category",data:a.map((a,e)=>`PC${e+1}`),axisLabel:{rotate:45,fontSize:10}},yAxis:{type:"value",name:"λ"},series:[{name:"Eigenvalues",type:"bar",data:a.map(a=>({value:a,itemStyle:{color:a>l?"#4e8ef7":"#e74c3c"}})),markLine:{silent:!0,data:[{yAxis:l,lineStyle:{color:"#f5c518",type:"dashed",width:1.5},label:{formatter:`λ₊=${l.toFixed(3)}`}}]}}],grid:{left:55,right:20,top:40,bottom:55}})}(),function(){if(!ga.value||!ma.value)return;xa||(xa=f(ga.value,"dark"));const a=ma.value.loadings,e=ma.value.n_components_used,l=Array.from({length:e},(a,e)=>`PC${e+1}`),t=a.map(a=>a.asset),s=[];let i=0;a.forEach((a,e)=>{a.loadings.forEach((a,l)=>{s.push([l,e,parseFloat(a.toFixed(4))]),Math.abs(a)>i&&(i=Math.abs(a))})}),xa.setOption({backgroundColor:"transparent",tooltip:{formatter:a=>`${t[a.data[1]]} / ${l[a.data[0]]}: ${a.data[2]}`},xAxis:{type:"category",data:l,splitArea:{show:!0}},yAxis:{type:"category",data:t,splitArea:{show:!0}},visualMap:{min:-i,max:i,calculable:!0,orient:"horizontal",left:"center",bottom:0,inRange:{color:["#e74c3c","#1a1a2e","#2ecc71"]},textStyle:{color:"#aaa"}},series:[{type:"heatmap",data:s,label:{show:a.length<=15&&e<=8,formatter:a=>a.data[2].toFixed(2),fontSize:10}}],grid:{left:80,right:20,top:10,bottom:55}})}(),ma.value?.portfolio_risk&&function(){if(!ya.value||!ma.value?.portfolio_risk)return;_a||(_a=f(ya.value,"dark"));const a=ma.value.portfolio_risk.pc_contributions,e=a.map(a=>`PC${a.pc}`),l=a.map(a=>+(100*a.share).toFixed(2)),t=a.map((a,e)=>e<ma.value.rmt.n_signal?"#4e8ef7":"#666");_a.setOption({backgroundColor:"transparent",tooltip:{trigger:"axis",formatter:a=>`PC${a[0].axisValue}: ${a[0].value.toFixed(2)}%`},xAxis:{type:"category",data:e,axisLabel:{fontSize:10}},yAxis:{type:"value",axisLabel:{formatter:a=>a+"%"}},series:[{type:"bar",data:l.map((a,e)=>({value:a,itemStyle:{color:t[e]}}))}],grid:{left:45,right:10,top:10,bottom:30}})}()}return l(ma,()=>m(Pa)),(a,e)=>(h(),t("div",k,[s("div",b,[e[6]||(e[6]=s("div",{class:"header-left"},[s("h1",{class:"page-title"},"Eigenportfolios — PCA декомпозиция"),s("p",{class:"page-subtitle"},"Σ = QΛQᵀ | Marchenko-Pastur сигнал/шум | Ledoit-Wolf shrinkage")],-1)),s("div",x,[s("label",_,[r(s("input",{type:"checkbox","onUpdate:modelValue":e[0]||(e[0]=a=>da.value=a)},null,512),[[o,da.value]]),e[5]||(e[5]=n(" Ledoit-Wolf shrinkage ",-1))]),r(s("input",{"onUpdate:modelValue":e[1]||(e[1]=a=>ca.value=a),type:"number",min:"1",placeholder:"K компонент (авто)",class:"param-input",style:{width:"160px"}},null,512),[[u,ca.value,void 0,{number:!0}]]),s("button",{onClick:Aa,class:"btn-primary",disabled:pa.value},[pa.value?(h(),t("span",A,"↺ Считаю...")):(h(),t("span",w,"Разложить"))],8,C)])]),s("div",P,[s("div",S,[e[8]||(e[8]=s("div",{class:"panel-header"},[s("h3",null,"Матрица доходностей (T × N)"),s("span",{class:"hint"},"Строки — периоды, столбцы — активы. Разделители: пробел/tab/;. Первая строка — имена.")],-1)),r(s("textarea",{"onUpdate:modelValue":e[2]||(e[2]=a=>y.value=a),class:"data-textarea",rows:"9",placeholder:"AAPL  MSFT  GOOG  AMZN\n0.01  0.02  0.015  0.008\n-0.01 0.00  0.005  -0.002\n..."},null,512),[[u,y.value]]),s("div",M,[s("label",null,[r(s("input",{type:"checkbox","onUpdate:modelValue":e[3]||(e[3]=a=>ua.value=a)},null,512),[[o,ua.value]]),e[7]||(e[7]=n(" Первая строка — имена активов",-1))])])]),s("div",F,[e[9]||(e[9]=s("div",{class:"panel-header"},[s("h3",null,"Веса портфеля — необязательно"),s("span",{class:"hint"},"N весов через пробел/запятую для декомпозиции риска по PC")],-1)),r(s("textarea",{"onUpdate:modelValue":e[4]||(e[4]=a=>oa.value=a),class:"data-textarea",rows:"4",placeholder:"0.25 0.25 0.25 0.25"},null,512),[[u,oa.value]]),e[10]||(e[10]=s("div",{class:"formula-box"},[s("div",{class:"formula"},"Σ = QΛQᵀ  |  λ₊ = σ²(1+√q)²"),s("div",{class:"formula small"},"q = N/T  |  Σ_LW = (1−α)S + α·μI"),s("div",{class:"formula small"},"Reconstruction: Σ_K = Σ_{k≤K} λₖ qₖqₖᵀ")],-1))])]),va.value?(h(),t("div",L,d(va.value),1)):i("",!0),ma.value?(h(),t(c,{key:1},[s("div",$,[s("div",N,[e[11]||(e[11]=s("div",{class:"kpi-label"},"Активов N",-1)),s("div",E,d(ma.value.n_assets),1),s("div",V,d(ma.value.n_periods)+" периодов",1)]),s("div",O,[e[12]||(e[12]=s("div",{class:"kpi-label"},"Сигнальных PC",-1)),s("div",T,d(ma.value.rmt.n_signal),1),s("div",j,"из "+d(ma.value.n_components_total)+" (RMT)",1)]),s("div",q,[e[13]||(e[13]=s("div",{class:"kpi-label"},"PC для 80% var",-1)),s("div",z,d(ma.value.thresholds.pc_80pct??"—"),1),s("div",R,"90%: "+d(ma.value.thresholds.pc_90pct??"—"),1)]),s("div",U,[e[14]||(e[14]=s("div",{class:"kpi-label"},"PC1 объясняет",-1)),s("div",I,d(Ca(ma.value.explained_variance[0])),1),s("div",K,"PC2: "+d(Ca(ma.value.explained_variance[1])),1)]),s("div",{class:p(["kpi-card",ma.value.reconstruction_error<.1?"kpi-green":"kpi-yellow"])},[e[15]||(e[15]=s("div",{class:"kpi-label"},"Recon. error",-1)),s("div",Q,d(Ca(ma.value.reconstruction_error)),1),s("div",W,"K="+d(ma.value.n_components_used),1)],2),ma.value.shrinkage.applied?(h(),t("div",G,[e[16]||(e[16]=s("div",{class:"kpi-label"},"Shrinkage α",-1)),s("div",B,d(wa(ma.value.shrinkage.alpha)),1),e[17]||(e[17]=s("div",{class:"kpi-sub"},"Ledoit-Wolf",-1))])):i("",!0)]),s("div",H,[s("div",J,[e[18]||(e[18]=s("div",{class:"panel-header"},[s("h3",null,"Scree plot — объяснённая дисперсия")],-1)),s("div",{ref_key:"screeEl",ref:ha,class:"chart-md"},null,512)]),s("div",Z,[s("div",D,[e[19]||(e[19]=s("h3",null,"Marchenko-Pastur: сигнал vs шум",-1)),s("span",X,"λ₊="+d(wa(ma.value.rmt.lambda_plus))+" — граница шума",1)]),s("div",{ref_key:"rmtEl",ref:fa,class:"chart-md"},null,512)])]),s("div",Y,[s("div",aa,[e[20]||(e[20]=s("div",{class:"panel-header"},[s("h3",null,"Тепловая карта нагрузок (активы × PC)"),s("span",{class:"hint"},"Вес каждого актива в каждом eigenportfolio")],-1)),s("div",{ref_key:"heatmapEl",ref:ga,class:"chart-heatmap"},null,512)]),s("div",ea,[e[23]||(e[23]=s("div",{class:"panel-header"},[s("h3",null,"Собственные значения")],-1)),s("table",la,[e[21]||(e[21]=s("thead",null,[s("tr",null,[s("th",null,"PC"),s("th",null,"λ"),s("th",null,"Var%"),s("th",null,"Cum%"),s("th",null,"RMT")])],-1)),s("tbody",null,[(h(!0),t(c,null,v(ma.value.eigenvalues.slice(0,15),(a,e)=>{return h(),t("tr",{key:e,class:p(a>ma.value.rmt.lambda_plus?"signal-row":"noise-row")},[s("td",null,"PC"+d(e+1),1),s("td",ta,d((l=a,l?.toFixed(4)??"—")),1),s("td",sa,d(Ca(ma.value.explained_variance[e])),1),s("td",ia,d(Ca(ma.value.cumulative_variance[e])),1),s("td",null,[s("span",{class:p(["rmt-tag",a>ma.value.rmt.lambda_plus?"signal":"noise"])},d(a>ma.value.rmt.lambda_plus?"signal":"noise"),3)])],2);var l}),128))])]),ma.value.portfolio_risk?(h(),t(c,{key:0},[s("div",ra,[e[22]||(e[22]=s("h3",null,"Декомпозиция риска портфеля",-1)),s("span",na,"vol = "+d(Ca(ma.value.portfolio_risk.portfolio_vol)),1)]),s("div",{ref_key:"riskEl",ref:ya,class:"chart-sm"},null,512)],64)):i("",!0)])])],64)):i("",!0)]))}}),[["__scopeId","data-v-e64e39f8"]]);export{oa as default};
