import{d as a,r as e,v as l,G as t,c as s,e as i,f as r,x as n,y as o,t as u,F as d,n as c,i as v,j as p,A as m,q as b}from"./vendor-DLyKmMu8.js";import{i as h}from"./index-DmS4-4n_.js";import{g as x}from"./apiHeaders-DCeXWvJ_.js";import{_ as g}from"./index-BaahR4yN.js";const k={class:"pbo-page"},y={class:"card input-card"},f={class:"form-grid"},S={class:"form-group"},_={class:"form-group"},F={class:"form-group"},O={class:"matrix-input"},w={key:0,class:"matrix-info"},R={key:1,class:"matrix-error"},C={class:"actions"},L=["disabled"],j={key:0,class:"error-msg"},$={class:"verdict-icon"},P={class:"verdict-text"},T={class:"kpi-grid"},A={class:"kpi-value"},V={class:"kpi-value"},z={class:"kpi-card"},B={class:"kpi-value"},N={class:"kpi-card"},I={class:"kpi-value"},M={class:"kpi-value"},D={class:"kpi-sub"},G={class:"kpi-card"},U={class:"kpi-value"},q={class:"kpi-sub"},E={class:"charts-row"},H={class:"card chart-card"},J={class:"card chart-card"},K={class:"card"},Q={class:"stats-table"},W={key:0,class:"best-tag"},X=g(a({__name:"PBOAnalysis",setup(a){const g=e({n_splits:16,annualize:252,sr_benchmark:0}),X=e(""),Y=e(!1),Z=e(""),aa=e(null),ea=e(null),la=e(null);let ta=null,sa=null;const ia=l(()=>{if(!X.value.trim())return{matrix:null,error:""};const a=X.value.trim().split("\n").filter(a=>a.trim()),e=[];for(const t of a){const a=t.split(",").map(a=>parseFloat(a.trim()));if(a.some(isNaN))return{matrix:null,error:`Не удалось разобрать строку: "${t}"`};e.push(a)}const l=e[0].length;return e.some(a=>a.length!==l)?{matrix:null,error:"Все строки должны иметь одинаковое число столбцов"}:e.length<20?{matrix:null,error:`Нужно минимум 20 строк, получено ${e.length}`}:l<2?{matrix:null,error:"Нужно минимум 2 стратегии (столбца)"}:{matrix:e,error:""}}),ra=l(()=>ia.value.matrix?{T:ia.value.matrix.length,N:ia.value.matrix[0].length}:null),na=l(()=>ia.value.error);function oa(){const a=[],e=(a=>{let e=a;return()=>(e=1664525*e+1013904223&4294967295,(e>>>0)/4294967295-.5)})(42);for(let l=0;l<100;l++){const l=Array.from({length:8},(a,l)=>{const t=0===l?.001:0;return(.02*e()+t).toFixed(5)});a.push(l.join(","))}X.value=a.join("\n")}async function ua(){if(ia.value.matrix){Y.value=!0,Z.value="",aa.value=null;try{const a=await fetch("   https://stochastic-dashbord-v1-production.up.railway.app/api/pbo/analyze",{method:"POST",headers:{"Content-Type":"application/json",...x()},body:JSON.stringify({strategy_returns:ia.value.matrix,n_splits:g.value.n_splits,annualize:g.value.annualize,sr_benchmark:g.value.sr_benchmark})});if(!a.ok){const e=await a.json();throw new Error(e.detail||`HTTP ${a.status}`)}const e=await a.json();aa.value=e.result,await m(),da()}catch(a){Z.value=a.message}finally{Y.value=!1}}}function da(){!function(){if(!ea.value||!aa.value)return;ta?.dispose(),ta=h(ea.value,"dark");const a=aa.value.scatter.is_sr,e=aa.value.scatter.oos_sr,l=a.map((a,l)=>[a,e[l]]),t=[...a,...e],s=Math.min(...t),i=Math.max(...t);ta.setOption({backgroundColor:"transparent",tooltip:{trigger:"item",formatter:a=>`IS SR: ${a.data[0].toFixed(4)}<br/>OOS SR: ${a.data[1].toFixed(4)}`},xAxis:{name:"IS Sharpe Ratio",nameLocation:"middle",nameGap:30,splitLine:{lineStyle:{color:"#333"}}},yAxis:{name:"OOS Sharpe Ratio",nameLocation:"middle",nameGap:40,splitLine:{lineStyle:{color:"#333"}}},series:[{type:"scatter",data:l,symbolSize:7,itemStyle:{color:"#5b8af5",opacity:.75}},{type:"line",data:[[s,s],[i,i]],lineStyle:{color:"#888",type:"dashed",width:1},symbol:"none",tooltip:{show:!1}}],grid:{left:60,right:20,top:20,bottom:50}})}(),function(){if(!la.value||!aa.value)return;sa?.dispose(),sa=h(la.value,"dark");const{counts:a,bin_edges:e,mean:l}=aa.value.logit_hist,t=a.map((a,l)=>({value:a,name:`[${e[l].toFixed(2)}, ${e[l+1].toFixed(2)})`}));sa.setOption({backgroundColor:"transparent",tooltip:{trigger:"axis",formatter:a=>`${a[0].name}<br/>Частота: ${a[0].value}`},xAxis:{type:"category",data:e.slice(0,-1).map(a=>a.toFixed(1)),name:"Логит OOS ранга",nameLocation:"middle",nameGap:30,axisLabel:{interval:4}},yAxis:{name:"Частота",splitLine:{lineStyle:{color:"#333"}}},series:[{type:"bar",data:t,itemStyle:{color:a=>e[a.dataIndex]<0?"#e05c5c":"#5b8af5"}}],markLine:{data:[{xAxis:l.toFixed(1),label:{formatter:`mean=${l.toFixed(2)}`}}]},grid:{left:50,right:20,top:20,bottom:50}})}()}return t(aa,async a=>{a&&(await m(),da())}),(a,e)=>{return b(),s("div",k,[e[27]||(e[27]=i("div",{class:"page-header"},[i("h1",null,"PBO / DSR — Анализ переобучения бэктеста"),i("p",{class:"subtitle"}," Probability of Backtest Overfitting (CSCV) · Deflated Sharpe Ratio · Minimum Backtest Length ")],-1)),i("div",y,[e[12]||(e[12]=i("h2",null,"Параметры",-1)),i("div",f,[i("div",S,[e[4]||(e[4]=i("label",null,"Число подмножеств (S)",-1)),n(i("input",{"onUpdate:modelValue":e[0]||(e[0]=a=>g.value.n_splits=a),type:"number",min:"4",max:"64",step:"2"},null,512),[[o,g.value.n_splits,void 0,{number:!0}]]),e[5]||(e[5]=i("span",{class:"hint"},"Чётное, ≥ 4. C(S, S/2) комбинаций для CSCV.",-1))]),i("div",_,[e[6]||(e[6]=i("label",null,"Периодов в году",-1)),n(i("input",{"onUpdate:modelValue":e[1]||(e[1]=a=>g.value.annualize=a),type:"number",min:"1"},null,512),[[o,g.value.annualize,void 0,{number:!0}]]),e[7]||(e[7]=i("span",{class:"hint"},"252 для дневных, 52 для недельных данных.",-1))]),i("div",F,[e[8]||(e[8]=i("label",null,"SR бенчмарк (годовой)",-1)),n(i("input",{"onUpdate:modelValue":e[2]||(e[2]=a=>g.value.sr_benchmark=a),type:"number",step:"0.1"},null,512),[[o,g.value.sr_benchmark,void 0,{number:!0}]]),e[9]||(e[9]=i("span",{class:"hint"},"Пороговый SR для PSR. Обычно 0.",-1))])]),i("div",O,[e[10]||(e[10]=i("label",null,"Матрица доходностей (T × N)",-1)),e[11]||(e[11]=i("p",{class:"hint"},'Каждая строка — период, столбцы — стратегии. CSV-формат, разделитель ",".',-1)),n(i("textarea",{"onUpdate:modelValue":e[3]||(e[3]=a=>X.value=a),rows:"10",placeholder:"0.001,0.002,-0.001\n-0.001,0.000,0.002\n0.002,0.001,0.000"},null,512),[[o,X.value]]),ra.value?(b(),s("div",w," Матрица: "+u(ra.value.T)+" × "+u(ra.value.N)+" (T × N стратегий) ",1)):r("",!0),na.value?(b(),s("div",R,u(na.value),1)):r("",!0)]),i("div",C,[i("button",{class:"btn-primary",onClick:ua,disabled:Y.value||!!na.value},u(Y.value?"Вычисление...":"Запустить анализ"),9,L),i("button",{class:"btn-secondary",onClick:oa},"Демо-данные")]),Z.value?(b(),s("div",j,u(Z.value),1)):r("",!0)]),aa.value?(b(),s(d,{key:0},[i("div",{class:c(["verdict-banner",aa.value.verdict_level])},[i("div",$,u("danger"===aa.value.verdict_level?"⚠️":"warning"===aa.value.verdict_level?"⚡":"✅"),1),i("div",P,[i("strong",null,u(aa.value.verdict),1),i("span",null,"PBO = "+u((100*aa.value.pbo).toFixed(1))+"% · "+u(aa.value.n_combinations)+" комбинаций CSCV",1)])],2),i("div",T,[i("div",{class:c(["kpi-card",(t=aa.value.pbo,t>.75?"danger":t>.5?"warning":"ok")])},[e[13]||(e[13]=i("div",{class:"kpi-label"},"PBO",-1)),i("div",A,u((100*aa.value.pbo).toFixed(1))+"%",1),e[14]||(e[14]=i("div",{class:"kpi-sub"},"вероятность переобучения",-1))],2),i("div",{class:c(["kpi-card",(l=aa.value.dsr,l>.95?"ok":l>.5?"warning":"danger")])},[e[15]||(e[15]=i("div",{class:"kpi-label"},"DSR",-1)),i("div",V,u((100*aa.value.dsr).toFixed(1))+"%",1),e[16]||(e[16]=i("div",{class:"kpi-sub"},"Deflated Sharpe Ratio",-1))],2),i("div",z,[e[17]||(e[17]=i("div",{class:"kpi-label"},"SR̂ (лучший)",-1)),i("div",B,u(aa.value.sr_hat_annual.toFixed(2)),1),e[18]||(e[18]=i("div",{class:"kpi-sub"},"годовой, аннуализированный",-1))]),i("div",N,[e[19]||(e[19]=i("div",{class:"kpi-label"},"SR* (порог)",-1)),i("div",I,u(aa.value.sr_star_annual.toFixed(2)),1),e[20]||(e[20]=i("div",{class:"kpi-sub"},"E[max SR] с поправкой",-1))]),i("div",{class:c(["kpi-card",aa.value.btl_sufficient?"ok":"danger"])},[e[21]||(e[21]=i("div",{class:"kpi-label"},"MinBTL",-1)),i("div",M,u(aa.value.min_btl.toLocaleString()),1),i("div",D," мин. длина бэктеста (текущий: "+u(aa.value.current_t)+") "+u(aa.value.btl_sufficient?"✅":"❌"),1)],2),i("div",G,[e[22]||(e[22]=i("div",{class:"kpi-label"},"Стратегий",-1)),i("div",U,u(aa.value.n_strategies),1),i("div",q,"лучшая: #"+u(aa.value.best_strategy),1)])]),i("div",E,[i("div",H,[e[23]||(e[23]=i("h3",null,"IS vs OOS Scatter",-1)),i("div",{ref_key:"scatterChart",ref:ea,class:"chart"},null,512)]),i("div",J,[e[24]||(e[24]=i("h3",null,"Логит-распределение OOS ранга",-1)),i("div",{ref_key:"logitChart",ref:la,class:"chart"},null,512)])]),i("div",K,[e[26]||(e[26]=i("h3",null,"Статистика стратегий",-1)),i("table",Q,[e[25]||(e[25]=i("thead",null,[i("tr",null,[i("th",null,"Стратегия"),i("th",null,"SR (период)"),i("th",null,"SR (годовой)"),i("th",null,"Асимметрия"),i("th",null,"Эксц. куртозис"),i("th",null,"PSR")])],-1)),i("tbody",null,[(b(!0),s(d,null,v(aa.value.strategy_stats,a=>{return b(),s("tr",{key:a.strategy,class:c({"best-row":a.strategy===aa.value.best_strategy})},[i("td",null,[p(u(a.strategy)+" ",1),a.strategy===aa.value.best_strategy?(b(),s("span",W,"★ лучшая")):r("",!0)]),i("td",null,u(a.sr_freq.toFixed(4)),1),i("td",null,u(a.sr_annual.toFixed(3)),1),i("td",null,u(a.skewness.toFixed(3)),1),i("td",null,u(a.excess_kurtosis.toFixed(3)),1),i("td",{class:c((e=a.psr,e>.95?"ok-text":e>.5?"warn-text":"danger-text"))},u((100*a.psr).toFixed(1))+"%",3)],2);var e}),128))])])])],64)):r("",!0)]);var l,t}}}),[["__scopeId","data-v-522686ea"]]);export{X as default};
