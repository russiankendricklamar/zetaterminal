import{g as a}from"./apiHeaders-DCeXWvJ_.js";import{usePortfolioStore as s}from"./portfolio-t34lcnLk.js";import{d as e,v as t,r as l,o as r,c,e as i,t as n,F as d,i as o,n as v,j as u,C as p,f as h,k as m,q as g}from"./vendor-DLyKmMu8.js";import{_ as b}from"./index-BaahR4yN.js";const f={class:"page-container custom-scroll"},x={class:"section-header"},y={class:"header-right"},k={class:"glass-pill control-pill"},_={class:"text-white font-bold"},w={class:"glass-segmented-control"},M=["onClick"],F={class:"kpi-cards-grid"},T={class:"glass-card kpi-card"},$={class:"kpi-value text-gradient-green"},A={class:"glass-card kpi-card"},j={class:"kpi-value text-white"},L={class:"glass-card kpi-card"},O={class:"kpi-value text-gradient-blue"},q={class:"glass-card kpi-card"},P={class:"kpi-value text-red"},S={class:"glass-card chart-panel"},C={class:"chart-container"},Y={viewBox:"0 0 1000 250",preserveAspectRatio:"none",class:"main-svg"},B=["d"],R=["d"],D=["d"],E=["cx","cy"],G={class:"dashboard-grid"},H={class:"col-left"},J={class:"glass-card panel-full"},N={class:"table-wrapper custom-scroll"},Q={class:"heatmap-table"},U={class:"col-month"},V={class:"col-right"},Z={class:"glass-card panel-full"},z={class:"stats-grid-mini"},I={class:"stat-box"},W={class:"val"},K={class:"stat-box"},X={class:"val text-green"},aa={class:"stat-box"},sa={class:"val text-green"},ea={class:"stat-box"},ta={class:"val text-green"},la={class:"stat-box"},ra={class:"val text-red"},ca={class:"stat-box"},ia={class:"val"},na={class:"glass-card panel-full"},da={class:"drawdown-list"},oa={class:"dd-info"},va={class:"dd-period"},ua={class:"dd-rec"},pa={class:"dd-right"},ha={class:"dd-val text-red"},ma={class:"dd-bar-bg"},ga=b(e({__name:"Backtesting",setup(e){const b=s(),ga=t(()=>b.selectedBank),ba=l(["1M","3M","6M","YTD","1Y","All"]),fa=l("YTD"),xa=l(!1),ya=l(null),ka=l(["2024","2025"]),_a=l(["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"]),wa=l([{2024:"+2.1",2025:"+1.8"},{2024:"+3.4",2025:"-1.2"},{2024:"-0.5",2025:"+2.9"},{2024:"+1.7",2025:"+0.8"},{2024:"+2.3",2025:"-0.3"},{2024:"+1.9",2025:"+1.5"},{2024:"+2.8",2025:"+2.1"},{2024:"-1.1",2025:"+0.9"},{2024:"+3.2",2025:"+1.4"},{2024:"+2.5",2025:"+3.1"},{2024:"+1.8",2025:"+2.2"},{2024:"+4.1",2025:"+2.8"}]),Ma=[{period:"Mar 23 — May 23",amount:-14.2,recovery:"6 mo"},{period:"Sep 23 — Oct 23",amount:-8.5,recovery:"3 mo"},{period:"Feb 24 — Mar 24",amount:-5.3,recovery:"2 mo"}],Fa=a=>{const s="string"==typeof a?parseFloat(a):a;return s>=3?"bg-green-strong":s>0?"bg-green-soft":0===s?"bg-neutral":s>-2?"bg-red-soft":"bg-red-strong"},Ta=t(()=>{if(!ya.value?.metrics?.monthly_returns)return wa.value;const a=ya.value.metrics.monthly_returns,s=[],e=Object.keys(a).sort();for(let t=0;t<12;t++){const l={};for(const s of e){const e=a[s]?.[t+1];l[s]=void 0!==e?e>0?"+"+e.toFixed(1):e.toFixed(1):"0.0"}s.push(l)}return s}),$a=t(()=>ya.value?.metrics?.monthly_returns?Object.keys(ya.value.metrics.monthly_returns).sort():ka.value),Aa=async()=>{if(!xa.value){xa.value=!0;try{const s=b.positions.length||23,e=b.positions.map(a=>a.symbol),t=Array.from({length:s},()=>.05+.1*Math.random()),l=b.correlationMatrix,r=Array.from({length:s},()=>.15+.15*Math.random()),c=[];for(let a=0;a<s;a++){const e=[];for(let t=0;t<s;t++){let s=.3;l.length>a&&void 0!==l[a]?.values?.[t]?s=l[a].values[t]:a===t&&(s=1),e.push(s*r[a]*r[t])}c.push(e)}const i=await(async s=>{try{const e=await fetch("   https://stochastic-dashbord-v1-production.up.railway.app/api/backtest/run",{method:"POST",headers:a(),body:JSON.stringify(s)});if(!e.ok){const a=await e.json().catch(()=>({detail:"Unknown error"}));throw new Error(a.detail||`HTTP error! status: ${e.status}`)}return await e.json()}catch(e){throw console.error("Backtest Failed:",e),e}})({mu:t,cov_matrix:c,initial_capital:1e6,risk_free_rate:.1394,gamma:3,horizon_years:1,n_steps:252,asset_names:e,n_paths:1e3,seed:42});ya.value=i}catch(s){console.error("Ошибка бэктестинга:",s)}finally{xa.value=!1}}},ja=()=>{if(!ya.value?.equity_curve||0===ya.value.equity_curve.length)return"M0,220 Q150,200 300,150 T600,100 T1000,40";const a=ya.value.equity_curve,s=Math.min(...a),e=Math.max(...a)-s||1,t=a.length;let l="";for(let r=0;r<t;r++){const c=r/(t-1)*1e3,i=250-(a[r]-s)/e*200-25;l+=0===r?`M${c},${i}`:` L${c},${i}`}return l},La=()=>{if(!ya.value?.benchmark_curve||0===ya.value.benchmark_curve.length)return"M0,220 Q150,210 300,190 T600,160 T1000,120";const a=ya.value.benchmark_curve,s=Math.min(...ya.value.equity_curve||[0],...a),e=Math.max(...ya.value.equity_curve||[0],...a)-s||1,t=a.length;let l="";for(let r=0;r<t;r++){const c=r/(t-1)*1e3,i=250-(a[r]-s)/e*200-25;l+=0===r?`M${c},${i}`:` L${c},${i}`}return l},Oa=()=>{const a=ja();if(!a||"M0,220 Q150,200 300,150 T600,100 T1000,40"===a)return"M0,220 Q150,200 300,150 T600,100 T1000,40 V250 H0 Z";const s=a.match(/L([0-9.]+),([0-9.]+)$/);return s?a+` L${s[1]},250 L0,250 Z`:a+" V250 H0 Z"},qa=t(()=>{if(!ya.value?.metrics?.drawdowns||0===ya.value.metrics.drawdowns.length)return null;ya.value.metrics.drawdowns[0];const a=ya.value.equity_curve;if(!a||0===a.length)return null;const s=Math.min(...a),e=a.indexOf(s);if(-1===e)return null;const t=Math.min(...a),l=Math.max(...a)-t||1;return{x:e/(a.length-1)*1e3,y:250-(t-t)/l*200-25}});return r(()=>{Aa()}),(a,s)=>(g(),c("div",f,[i("div",x,[s[1]||(s[1]=i("div",{class:"header-left"},[i("h1",{class:"section-title"},"Результаты бэктеста"),i("p",{class:"section-subtitle"},"Историческая симуляция стратегии (Long/Short)")],-1)),i("div",y,[i("div",k,[s[0]||(s[0]=i("span",{class:"lbl-mini"},"Банк:",-1)),i("span",_,n(ga.value.name),1)]),i("div",w,[(g(!0),c(d,null,o(ba.value,a=>(g(),c("button",{key:a,onClick:s=>fa.value=a,class:v(["seg-btn",{active:fa.value===a}])},n(a),11,M))),128))])])]),i("div",F,[i("div",T,[s[2]||(s[2]=i("div",{class:"kpi-label"},"Общая доходность",-1)),i("div",$,n(ya.value?.metrics?(100*ya.value.metrics.total_return).toFixed(1)+"%":"+24.5%"),1),s[3]||(s[3]=i("div",{class:"kpi-change text-green"},[i("span",{class:"icon-up"},"↑"),u(" vs SPY: +6.2% ")],-1))]),i("div",A,[s[4]||(s[4]=i("div",{class:"kpi-label"},"CAGR (Годовая)",-1)),i("div",j,n(ya.value?.metrics?(100*ya.value.metrics.cagr).toFixed(1)+"%":"18.2%"),1),s[5]||(s[5]=i("div",{class:"kpi-change text-muted"},"Безрисковая ставка: 5.0%",-1))]),i("div",L,[s[6]||(s[6]=i("div",{class:"kpi-label"},"Коэф. Шарпа",-1)),i("div",O,n(ya.value?.metrics?ya.value.metrics.sharpe_ratio.toFixed(2):"1.58"),1),s[7]||(s[7]=i("div",{class:"kpi-change text-blue"},"Топ 15%",-1))]),i("div",q,[s[8]||(s[8]=i("div",{class:"kpi-label"},"Макс. Просадка",-1)),i("div",P,n(ya.value?.metrics?(100*ya.value.metrics.max_drawdown).toFixed(1)+"%":"-14.2%"),1),s[9]||(s[9]=i("div",{class:"kpi-change text-red"},"Высокий риск",-1))])]),i("div",S,[s[11]||(s[11]=p('<div class="panel-header" data-v-cbc555e1><div class="ph-left" data-v-cbc555e1><h3 data-v-cbc555e1>Кривая капитала</h3><span class="badge-live" data-v-cbc555e1>Накопительный</span></div><div class="chart-legend" data-v-cbc555e1><div class="legend-item" data-v-cbc555e1><span class="dot strategy" data-v-cbc555e1></span>Портфель</div><div class="legend-item" data-v-cbc555e1><span class="dot benchmark" data-v-cbc555e1></span>S&amp;P 500</div></div></div>',1)),i("div",C,[(g(),c("svg",Y,[s[10]||(s[10]=p('<defs data-v-cbc555e1><linearGradient id="grad-green" x1="0" y1="0" x2="0" y2="1" data-v-cbc555e1><stop offset="0%" stop-color="rgba(74, 222, 128, 0.3)" data-v-cbc555e1></stop><stop offset="100%" stop-color="rgba(74, 222, 128, 0)" data-v-cbc555e1></stop></linearGradient></defs><line x1="0" y1="50" x2="1000" y2="50" stroke="rgba(255,255,255,0.05)" data-v-cbc555e1></line><line x1="0" y1="125" x2="1000" y2="125" stroke="rgba(255,255,255,0.05)" data-v-cbc555e1></line><line x1="0" y1="200" x2="1000" y2="200" stroke="rgba(255,255,255,0.05)" data-v-cbc555e1></line>',4)),i("path",{d:La(),fill:"none",stroke:"rgba(255,255,255,0.2)","stroke-width":"2","stroke-dasharray":"6,4"},null,8,B),i("path",{d:Oa(),fill:"url(#grad-green)",stroke:"none"},null,8,R),i("path",{d:ja(),fill:"none",stroke:"#4ade80","stroke-width":"3","stroke-linecap":"round"},null,8,D),qa.value?(g(),c("circle",{key:0,cx:qa.value.x,cy:qa.value.y,r:"4",fill:"#1e293b",stroke:"#f87171","stroke-width":"2"},null,8,E)):h("",!0)]))])]),i("div",G,[i("div",H,[i("div",J,[s[14]||(s[14]=i("div",{class:"panel-header"},[i("h3",null,"Месячная доходность")],-1)),i("div",N,[i("table",Q,[i("thead",null,[i("tr",null,[s[12]||(s[12]=i("th",{class:"col-month"},null,-1)),(g(!0),c(d,null,o($a.value,a=>(g(),c("th",{key:a,class:"col-year"},n(a),1))),128))])]),i("tbody",null,[(g(!0),c(d,null,o(_a.value,(a,s)=>(g(),c("tr",{key:a},[i("td",U,n(a),1),(g(!0),c(d,null,o($a.value,e=>(g(),c("td",{key:`${a}-${e}`,class:"col-val"},[i("div",{class:v(["val-pill",Fa(Ta.value[s]?.[e]||"0.0")])},n(Ta.value[s]?.[e]||"0.0")+"% ",3)]))),128))]))),128)),s[13]||(s[13]=i("tr",{class:"row-total"},[i("td",{class:"col-month"},"YTD"),i("td",{class:"col-val"},[i("span",{class:"text-green font-bold"},"+24.1%")]),i("td",{class:"col-val"},[i("span",{class:"text-green font-bold"},"+18.5%")])],-1))])])])])]),i("div",V,[i("div",Z,[s[21]||(s[21]=i("div",{class:"panel-header"},[i("h3",null,"Статистика сделок")],-1)),i("div",z,[i("div",I,[s[15]||(s[15]=i("span",{class:"lbl"},"Всего сделок",-1)),i("span",W,n(ya.value?.metrics?.total_trades||243),1)]),i("div",K,[s[16]||(s[16]=i("span",{class:"lbl"},"Win Rate",-1)),i("span",X,n(ya.value?.metrics?(100*ya.value.metrics.win_rate).toFixed(1)+"%":"64.2%"),1)]),i("div",aa,[s[17]||(s[17]=i("span",{class:"lbl"},"Profit Factor",-1)),i("span",sa,n(ya.value?.metrics?ya.value.metrics.profit_factor.toFixed(2):"2.34"),1)]),i("div",ea,[s[18]||(s[18]=i("span",{class:"lbl"},"Средняя прибыль",-1)),i("span",ta,n(ya.value?.metrics?"+"+ya.value.metrics.avg_profit.toFixed(0):"+₽245"),1)]),i("div",la,[s[19]||(s[19]=i("span",{class:"lbl"},"Средний убыток",-1)),i("span",ra,n(ya.value?.metrics?"-"+ya.value.metrics.avg_loss.toFixed(0):"-₽145"),1)]),i("div",ca,[s[20]||(s[20]=i("span",{class:"lbl"},"Время удержания",-1)),i("span",ia,n(ya.value?.metrics?ya.value.metrics.hold_time.toFixed(1)+"d":"8.4d"),1)])])]),i("div",na,[s[22]||(s[22]=i("div",{class:"panel-header"},[i("h3",null,"Топ 3 просадки")],-1)),i("div",da,[(g(!0),c(d,null,o(ya.value?.metrics?.drawdowns||Ma,(a,s)=>(g(),c("div",{key:s,class:"dd-item"},[i("div",oa,[i("span",va,n(a.period),1),i("span",ua,"Восстановление: "+n(a.recovery),1)]),i("div",pa,[i("span",ha,n(a.amount.toFixed(1))+"%",1),i("div",ma,[i("div",{class:"dd-bar-fill",style:m({width:3*Math.abs(a.amount)+"px"})},null,4)])])]))),128))])])])])]))}}),[["__scopeId","data-v-cbc555e1"]]);export{ga as default};
