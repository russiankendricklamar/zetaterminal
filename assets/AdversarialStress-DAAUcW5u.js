import{d as a,v as e,r as l,G as t,c as s,e as i,f as r,x as n,y as d,t as o,F as u,n as v,i as p,A as c,q as m}from"./vendor-DLyKmMu8.js";import{i as h}from"./index-BjvaFruF.js";import{usePortfolioStore as b}from"./portfolio-t34lcnLk.js";import{g as y}from"./apiHeaders-DCeXWvJ_.js";import{_}from"./index-AoYxWDki.js";const f={class:"adv-page"},x={class:"card params-card"},g={class:"form-grid"},k={class:"form-group"},w={class:"range-val"},C={class:"form-group"},F={class:"range-val"},M={class:"form-group"},S={class:"form-group"},A={class:"form-group"},V={class:"form-group"},R={class:"actions"},P=["disabled"],D={key:0,class:"asset-count"},T={key:1,class:"asset-count warn"},j={key:0,class:"error-msg"},B={class:"kpi-grid"},E={class:"kpi-card danger"},L={class:"kpi-value"},U={class:"kpi-sub"},z={class:"kpi-card danger"},O={class:"kpi-value"},G={class:"kpi-card danger"},W={class:"kpi-value"},q={class:"kpi-sub"},$={class:"kpi-card"},H={class:"kpi-value"},I={class:"kpi-value"},J={class:"kpi-sub"},K={key:0,class:"kpi-card"},N={class:"kpi-value"},Y={class:"kpi-sub"},Q={class:"card"},X={class:"comparison-table"},Z={class:"charts-row"},aa={class:"card chart-card"},ea={class:"card chart-card"},la={class:"charts-row"},ta={class:"card chart-card"},sa={key:0,class:"card chart-card"},ia=_(a({__name:"AdversarialStress",setup(a){const _=b(),ia=e(()=>_.positions),ra=e(()=>_.correlationMatrix),na=l(!1),da=l(""),oa=l(null),ua=l({kappa:1,epsilon:.1,nPaths:2e3,initialCapital:1e6,riskFreeRate:.045,gamma:3}),va=l(null),pa=l(null),ca=l(null),ma=l(null);let ha=null,ba=null,ya=null,_a=null;const fa=a=>Math.abs(a)>=1e6?(a/1e6).toFixed(2)+"M":Math.abs(a)>=1e3?(a/1e3).toFixed(0)+"K":a.toFixed(0),xa=e(()=>{if(!oa.value)return[];const a=oa.value.base_scenario,e=oa.value.adversarial_scenario;ua.value.initialCapital;const l=a=>(100*a).toFixed(2)+"%",t=a=>fa(a),s=(a,e,l)=>{const t=e-a;return l?(t>0?"+":"")+(100*t).toFixed(2)+"%":(t>0?"+":"")+fa(t)},i=(a,e,l)=>{const t=e-a;return Math.abs(t)<1e-6?"":(l?t<0:t>0)?"text-red":"text-green"};return[{label:"Expected Return",base:l(a.expected_return),adv:l(e.expected_return),delta:s(a.expected_return,e.expected_return,!0),deltaClass:i(a.expected_return,e.expected_return,!0)},{label:"Volatility",base:l(a.volatility),adv:l(e.volatility),delta:s(a.volatility,e.volatility,!0),deltaClass:i(a.volatility,e.volatility,!1)},{label:"Sharpe Ratio",base:a.sharpe.toFixed(3),adv:e.sharpe.toFixed(3),delta:(e.sharpe-a.sharpe>0?"+":"")+(e.sharpe-a.sharpe).toFixed(3),deltaClass:i(a.sharpe,e.sharpe,!0)},{label:"VaR 95%",base:t(a.var_95),adv:t(e.var_95),delta:s(a.var_95,e.var_95,!1),deltaClass:i(a.var_95,e.var_95,!0)},{label:"CVaR 95%",base:t(a.cvar_95),adv:t(e.cvar_95),delta:s(a.cvar_95,e.cvar_95,!1),deltaClass:i(a.cvar_95,e.cvar_95,!0)},{label:"VaR 99%",base:t(a.var_99),adv:t(e.var_99),delta:s(a.var_99,e.var_99,!1),deltaClass:i(a.var_99,e.var_99,!0)},{label:"Max Drawdown",base:l(a.max_drawdown),adv:l(e.max_drawdown),delta:s(a.max_drawdown,e.max_drawdown,!0),deltaClass:i(a.max_drawdown,e.max_drawdown,!1)},{label:"Mean Final Capital",base:t(a.mean_final),adv:t(e.mean_final),delta:s(a.mean_final,e.mean_final,!1),deltaClass:i(a.mean_final,e.mean_final,!0)}]}),ga=()=>{const a=ia.value,e=a.length,l=a.reduce((a,e)=>a+e.allocation,0),t=l>0?a.map(a=>a.allocation/l):a.map(()=>1/e),s=a.map(()=>.2),i=ra.value,r=[];for(let n=0;n<e;n++){const a=[];for(let l=0;l<e;l++){const e=i[n]?.values[l]??(n===l?1:0);a.push(e*s[n]*s[l])}r.push(a)}return{cov_matrix:r,mu:a.map(a=>.05+252*(a.dayChange/100)),weights:t,kappa:ua.value.kappa,epsilon:ua.value.epsilon,n_paths:ua.value.nPaths,risk_free_rate:ua.value.riskFreeRate,initial_capital:ua.value.initialCapital,gamma:ua.value.gamma,asset_names:a.map(a=>a.symbol),seed:42}},ka=async()=>{if(0!==ia.value.length){na.value=!0,da.value="",oa.value=null;try{const a=await fetch("   https://stochastic-dashbord-v1-production.up.railway.app/api/adversarial-stress/generate",{method:"POST",headers:{"Content-Type":"application/json",...y()},body:JSON.stringify(ga())});if(!a.ok){const e=await a.json().catch(()=>({detail:"Unknown error"}));throw new Error(e.detail||`HTTP ${a.status}`)}oa.value=await a.json(),await c(),wa()}catch(a){da.value=a.message}finally{na.value=!1}}},wa=()=>{Fa(),Ma(),Sa(),Aa()},Ca={backgroundColor:"transparent",textStyle:{color:"#d1d5db"}},Fa=()=>{if(!va.value||!oa.value)return;ha?.dispose(),ha=h(va.value);const a=oa.value.return_distributions.base,e=oa.value.return_distributions.adversarial,l=[...a,...e],t=Math.min(...l),s=(Math.max(...l)-t)/40,i=a=>{const e=new Array(40).fill(0);for(const l of a){const a=Math.min(Math.floor((l-t)/s),39);a>=0&&e[a]++}return e.map((e,l)=>[t+(l+.5)*s,e/a.length])},r=i(a),n=i(e);ha.setOption({...Ca,tooltip:{trigger:"axis"},legend:{data:["Base","Adversarial"],textStyle:{color:"#d1d5db"}},xAxis:{type:"value",name:"Return",axisLabel:{formatter:a=>(100*a).toFixed(0)+"%"}},yAxis:{type:"value",name:"Density"},series:[{name:"Base",type:"bar",data:r,barWidth:"90%",itemStyle:{color:"rgba(96,165,250,0.6)"}},{name:"Adversarial",type:"bar",data:n,barWidth:"90%",itemStyle:{color:"rgba(248,113,113,0.6)"}}]})},Ma=()=>{if(!pa.value||!oa.value)return;ba?.dispose(),ba=h(pa.value);const a=oa.value.mc_adversarial,e=a.t_grid,l=[];for(let s=0;s<Math.min(a.paths.length,20);s++)l.push({type:"line",data:a.paths[s].map((a,l)=>[e[l],a]),lineStyle:{width:.5,color:"rgba(248,113,113,0.15)"},symbol:"none",silent:!0});l.push({name:"Median",type:"line",data:a.median_path.map((a,l)=>[e[l],a]),lineStyle:{width:2,color:"#f87171"},symbol:"none"}),l.push({name:"5%-95% Band",type:"line",data:a.q95_path.map((a,l)=>[e[l],a]),lineStyle:{width:1,type:"dashed",color:"#fca5a5"},symbol:"none",areaStyle:{color:"transparent"}}),l.push({type:"line",data:a.q05_path.map((a,l)=>[e[l],a]),lineStyle:{width:1,type:"dashed",color:"#fca5a5"},symbol:"none",areaStyle:{color:"rgba(248,113,113,0.08)",origin:"auto"}});const t=oa.value.mc_base;l.push({name:"Base Median",type:"line",data:t.median_path.map((a,e)=>[t.t_grid[e],a]),lineStyle:{width:2,color:"#60a5fa",type:"dashed"},symbol:"none"}),ba.setOption({...Ca,tooltip:{trigger:"axis"},legend:{data:["Median","Base Median"],textStyle:{color:"#d1d5db"}},xAxis:{type:"value",name:"Years"},yAxis:{type:"value",name:"Capital",axisLabel:{formatter:a=>fa(a)}},series:l})},Sa=()=>{if(!ca.value||!oa.value)return;ya?.dispose(),ya=h(ca.value);const a=oa.value.asset_names,e=oa.value.mu_shift;ya.setOption({...Ca,tooltip:{trigger:"axis",formatter:a=>{const e=Array.isArray(a)?a[0]:a;return`${e.name}: ${(100*e.value).toFixed(2)}%`}},xAxis:{type:"category",data:a,axisLabel:{rotate:45,color:"#9ca3af"}},yAxis:{type:"value",name:"Δμ",axisLabel:{formatter:a=>(100*a).toFixed(1)+"%"}},series:[{type:"bar",data:e.map(a=>({value:a,itemStyle:{color:a<0?"#f87171":"#34d399"}}))}]})},Aa=()=>{if(!ma.value||!oa.value||!oa.value.evt_tail.fit_success)return;_a?.dispose(),_a=h(ma.value);const a=oa.value.return_distributions.adversarial.map(a=>-a).filter(a=>a>0).sort((a,e)=>a-e),e=a.length,l=a.map((l,t)=>[a[t],(t+1)/e]),t=oa.value.evt_tail,s=t.threshold/ua.value.initialCapital,i=t.xi,r=t.beta/ua.value.initialCapital,n=[],d=a.filter(a=>a>=.5*s);for(const o of d){const a=o-s;if(a<0){n.push([o,1]);continue}let e;if(Math.abs(i)<1e-8)e=Math.exp(-a/r);else{const l=1+i*a/r;e=l>0?Math.pow(l,-1/i):0}n.push([o,1-e*(1-.9)])}_a.setOption({...Ca,tooltip:{trigger:"axis"},legend:{data:["Empirical CDF","GPD Fit"],textStyle:{color:"#d1d5db"}},xAxis:{type:"value",name:"Loss",axisLabel:{formatter:a=>(100*a).toFixed(0)+"%"}},yAxis:{type:"value",name:"CDF",min:0,max:1},series:[{name:"Empirical CDF",type:"scatter",data:l.filter((a,e)=>e%3==0),symbolSize:3,itemStyle:{color:"#9ca3af"}},{name:"GPD Fit",type:"line",data:n,lineStyle:{color:"#f87171",width:2},symbol:"none"}]})},Va=()=>{ha?.resize(),ba?.resize(),ya?.resize(),_a?.resize()};return t(()=>oa.value,async a=>{a&&(await c(),wa())}),"undefined"!=typeof window&&window.addEventListener("resize",Va),(a,e)=>{return m(),s("div",f,[e[29]||(e[29]=i("div",{class:"page-header"},[i("h1",null,"Adversarial Stress Testing"),i("p",{class:"subtitle"}," Distributionally Robust worst-case сценарии · EVT tail analysis · Mahalanobis plausibility ")],-1)),i("div",x,[e[14]||(e[14]=i("h2",null,"Параметры",-1)),i("div",g,[i("div",k,[e[6]||(e[6]=i("label",null,"κ — интенсивность (mean shift)",-1)),n(i("input",{type:"range","onUpdate:modelValue":e[0]||(e[0]=a=>ua.value.kappa=a),min:"0.1",max:"3.0",step:"0.1",class:"range-input"},null,512),[[d,ua.value.kappa,void 0,{number:!0}]]),i("span",w,o(ua.value.kappa.toFixed(1)),1),e[7]||(e[7]=i("span",{class:"hint"},"Радиус эллипсоидальной неопределённости для μ",-1))]),i("div",C,[e[8]||(e[8]=i("label",null,"ε — пертурбация ковариации",-1)),n(i("input",{type:"range","onUpdate:modelValue":e[1]||(e[1]=a=>ua.value.epsilon=a),min:"0.01",max:"0.5",step:"0.01",class:"range-input"},null,512),[[d,ua.value.epsilon,void 0,{number:!0}]]),i("span",F,o(ua.value.epsilon.toFixed(2)),1),e[9]||(e[9]=i("span",{class:"hint"},"Радиус Фробениуса для Σ*",-1))]),i("div",M,[e[10]||(e[10]=i("label",null,"MC траектории",-1)),n(i("input",{type:"number","onUpdate:modelValue":e[2]||(e[2]=a=>ua.value.nPaths=a),min:"500",max:"5000",step:"500"},null,512),[[d,ua.value.nPaths,void 0,{number:!0}]])]),i("div",S,[e[11]||(e[11]=i("label",null,"Начальный капитал",-1)),n(i("input",{type:"number","onUpdate:modelValue":e[3]||(e[3]=a=>ua.value.initialCapital=a),min:"100000",step:"100000"},null,512),[[d,ua.value.initialCapital,void 0,{number:!0}]])]),i("div",A,[e[12]||(e[12]=i("label",null,"Безрисковая ставка",-1)),n(i("input",{type:"number","onUpdate:modelValue":e[4]||(e[4]=a=>ua.value.riskFreeRate=a),min:"0",max:"0.5",step:"0.01"},null,512),[[d,ua.value.riskFreeRate,void 0,{number:!0}]])]),i("div",V,[e[13]||(e[13]=i("label",null,"γ (risk aversion)",-1)),n(i("input",{type:"number","onUpdate:modelValue":e[5]||(e[5]=a=>ua.value.gamma=a),min:"0.5",max:"10",step:"0.5"},null,512),[[d,ua.value.gamma,void 0,{number:!0}]])])]),i("div",R,[i("button",{class:"btn-primary",onClick:ka,disabled:na.value||0===ia.value.length},o(na.value?"Генерация...":"Запустить Adversarial Stress"),9,P),ia.value.length>0?(m(),s("span",D,o(ia.value.length)+" активов в портфеле ",1)):(m(),s("span",T,"Портфель пуст — добавьте активы"))]),da.value?(m(),s("div",j,o(da.value),1)):r("",!0)]),oa.value?(m(),s(u,{key:0},[i("div",B,[i("div",E,[e[15]||(e[15]=i("div",{class:"kpi-label"},"Worst-Case VaR 95%",-1)),i("div",L,o(fa(oa.value.adversarial_scenario.var_95)),1),i("div",U,"потеря: "+o(fa(ua.value.initialCapital-oa.value.adversarial_scenario.var_95)),1)]),i("div",z,[e[16]||(e[16]=i("div",{class:"kpi-label"},"Worst-Case CVaR 95%",-1)),i("div",O,o(fa(oa.value.adversarial_scenario.cvar_95)),1),e[17]||(e[17]=i("div",{class:"kpi-sub"},"expected shortfall",-1))]),i("div",G,[e[18]||(e[18]=i("div",{class:"kpi-label"},"Worst-Case VaR 99%",-1)),i("div",W,o(fa(oa.value.adversarial_scenario.var_99)),1),i("div",q,"потеря: "+o(fa(ua.value.initialCapital-oa.value.adversarial_scenario.var_99)),1)]),i("div",$,[e[19]||(e[19]=i("div",{class:"kpi-label"},"Max Drawdown",-1)),i("div",H,o((100*oa.value.adversarial_scenario.max_drawdown).toFixed(1))+"%",1),e[20]||(e[20]=i("div",{class:"kpi-sub"},"adversarial сценарий",-1))]),i("div",{class:v(["kpi-card",(l=oa.value.plausibility.combined_score,l<.3?"ok":l<.6?"warning":"danger")])},[e[21]||(e[21]=i("div",{class:"kpi-label"},"Plausibility",-1)),i("div",I,o((100*oa.value.plausibility.combined_score).toFixed(0))+"%",1),i("div",J,"Mahalanobis: "+o(oa.value.plausibility.mahalanobis_distance.toFixed(2)),1)],2),oa.value.evt_tail.fit_success?(m(),s("div",K,[e[22]||(e[22]=i("div",{class:"kpi-label"},"EVT VaR 99.9%",-1)),i("div",N,o(fa(ua.value.initialCapital-oa.value.evt_tail.var_999)),1),i("div",Y,"ξ = "+o(oa.value.evt_tail.xi.toFixed(3))+" (GPD shape)",1)])):r("",!0)]),i("div",Q,[e[24]||(e[24]=i("h3",null,"Base vs Adversarial",-1)),i("table",X,[e[23]||(e[23]=i("thead",null,[i("tr",null,[i("th",null,"Метрика"),i("th",null,"Base"),i("th",null,"Adversarial"),i("th",null,"Δ")])],-1)),i("tbody",null,[(m(!0),s(u,null,p(xa.value,a=>(m(),s("tr",{key:a.label},[i("td",null,o(a.label),1),i("td",null,o(a.base),1),i("td",null,o(a.adv),1),i("td",{class:v(a.deltaClass)},o(a.delta),3)]))),128))])])]),i("div",Z,[i("div",aa,[e[25]||(e[25]=i("h3",null,"Распределение доходностей: Base vs Adversarial",-1)),i("div",{ref_key:"distChart",ref:va,class:"chart"},null,512)]),i("div",ea,[e[26]||(e[26]=i("h3",null,"MC Trajectories (Adversarial)",-1)),i("div",{ref_key:"pathsChart",ref:pa,class:"chart"},null,512)])]),i("div",la,[i("div",ta,[e[27]||(e[27]=i("h3",null,"Per-Asset μ Shift (Adversarial − Base)",-1)),i("div",{ref_key:"shiftChart",ref:ca,class:"chart"},null,512)]),oa.value.evt_tail.fit_success?(m(),s("div",sa,[e[28]||(e[28]=i("h3",null,"EVT Tail: GPD Fit",-1)),i("div",{ref_key:"tailChart",ref:ma,class:"chart"},null,512)])):r("",!0)])],64)):r("",!0)]);var l}}}),[["__scopeId","data-v-fa1a219a"]]);export{ia as default};
